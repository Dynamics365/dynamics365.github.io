<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Dynamics 365 for Finance & Operations and Azure DevOps | Dynamics 365 Finance Operations & Power Platform</title><meta name=keywords content="DevOps,ALM"><meta name=description content="Dynamics 365 for Finance & Operations and Azure DevOps 0.1.1. Azure DevOps Azure DevOps will be the service we will use for source control. Microsoft Dynamics 365 for Finance and Operations supports TFVC out of the box as its version-control system.
But Azure DevOps does not only offer a source control tool. Of course, developers will be the most benefited of using it, but from project management to the functional team and customers, everybody can be involved in using Azure DevOps."><meta name=author content="Me"><link rel=canonical href=https://nuxulu.com/2021-05-01-dynamics-365-for-finance-operations-and-azure-devops/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link href=/assets/css/stylesheet.min.746a86b58bb2b052b5e4df8216510494f04f81e62c08d626150c26c69ca929da.css integrity="sha256-dGqGtYuysFK15N+CFlEElPBPgeYsCNYmFQwmxpypKdo=" rel="preload stylesheet" as=style><link rel=icon href=https://nuxulu.com/%7B%7Bsite.url%7D%7D/><link rel=icon type=image/png sizes=16x16 href=https://nuxulu.com/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://nuxulu.com/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://nuxulu.com/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://nuxulu.com/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.83.1"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-123-45','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script><meta property="og:title" content="Dynamics 365 for Finance & Operations and Azure DevOps"><meta property="og:description" content="Dynamics 365 for Finance & Operations and Azure DevOps 0.1.1. Azure DevOps Azure DevOps will be the service we will use for source control. Microsoft Dynamics 365 for Finance and Operations supports TFVC out of the box as its version-control system.
But Azure DevOps does not only offer a source control tool. Of course, developers will be the most benefited of using it, but from project management to the functional team and customers, everybody can be involved in using Azure DevOps."><meta property="og:type" content="article"><meta property="og:url" content="https://nuxulu.com/2021-05-01-dynamics-365-for-finance-operations-and-azure-devops/"><meta property="og:image" content="https://nuxulu.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content><meta property="og:site_name" content="Dynamics 365 Finance Operations & Power Platform"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://nuxulu.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Dynamics 365 for Finance & Operations and Azure DevOps"><meta name=twitter:description content="Dynamics 365 for Finance & Operations and Azure DevOps 0.1.1. Azure DevOps Azure DevOps will be the service we will use for source control. Microsoft Dynamics 365 for Finance and Operations supports TFVC out of the box as its version-control system.
But Azure DevOps does not only offer a source control tool. Of course, developers will be the most benefited of using it, but from project management to the functional team and customers, everybody can be involved in using Azure DevOps."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Dynamics 365 for Finance \u0026 Operations and Azure DevOps","item":"https://nuxulu.com/2021-05-01-dynamics-365-for-finance-operations-and-azure-devops/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Dynamics 365 for Finance \u0026 Operations and Azure DevOps","name":"Dynamics 365 for Finance \u0026 Operations and Azure DevOps","description":"Dynamics 365 for Finance \u0026amp; Operations and Azure DevOps 0.1.1. Azure DevOps Azure DevOps will be the service we will use for source control. Microsoft Dynamics 365 for Finance and Operations supports TFVC out of the box as its version-control system.\nBut Azure DevOps does not only offer a source control tool. Of course, developers will be the most benefited of using it, but from project management to the functional team and customers, everybody can be involved in using Azure DevOps.","keywords":["DevOps","ALM"],"articleBody":"Dynamics 365 for Finance \u0026 Operations and Azure DevOps 0.1.1. Azure DevOps Azure DevOps will be the service we will use for source control. Microsoft Dynamics 365 for Finance and Operations supports TFVC out of the box as its version-control system.\nBut Azure DevOps does not only offer a source control tool. Of course, developers will be the most benefited of using it, but from project management to the functional team and customers, everybody can be involved in using Azure DevOps. BPM synchronization and task creation, team planning, source control, automated builds and releases, are some of the tools it offers. All these changes will need some learning from the team, but in the short-term all of this will help to better manage implementations.\nAs I said it looks like the technical team is the most affected by the addition of source control to Visual Studio, but it‚Äôs the most benefited too‚Ä¶\n0.1.2. First steps To use all the features described in this guide we need to create an Azure DevOps project and connect it to LCS. This will be the first step and it‚Äôs mandatory so let‚Äôs see how we have to do everything.\n0.1.2.1. Create an Azure DevOps organization You might or might not have to do this. If you or your customer already have an account, you can use it and just create a new project in it. Otherwise head to https://dev.azure.com and create a new organization:\nAzure DevOps sign up\nAfter creating it you need to create a new project with the following options:\nCreate Azure DevOps project\nPress the ‚ÄúCreate project‚Äù button and you‚Äôre done. Now let‚Äôs connect this Azure DevOps project to our LCS project.\nWhen a customer signs up for Finance and Operations the LCS project is of type ‚ÄúImplementation project‚Äù is created automatically. Your customers need to invite you to their project. If you‚Äôre an ISV you can use the ‚ÄúMigrate, create solutions, and learn‚Äù projects.\nIn any of both cases you need to go to ‚ÄúProject settings‚Äù and select the ‚ÄúVisual Studio Team Services‚Äù Tab. Scroll down and you should see two fields. Fill the field with your DevOps URL without the project part. If you got a https://dev.azure.com/YOUR_ORG URL type you need to change it to https://YOUR_ORG.visualstudio.com:\nAzure DevOps setup on LCS\nAnd to get the ‚ÄúPersonal access token‚Äù we go back to our Azure DevOps project, click on the user settings icon, and then select ‚ÄúPersonal access tokens‚Äù:\nWe add a new token, set its expiration and give it full access. Finally press the ‚ÄúCreate‚Äù button and a new dialog will appear with your token, copy it, and paste it in LCS.\nBack to LCS, once you‚Äôve pasted the token press the ‚ÄúContinue‚Äù button. On the next step just select your project, press ‚ÄúContinue‚Äù and finally ‚ÄúSave‚Äù on the last step.\nIf you have any problem you can take a look at the docs where everything is really well documented.\n0.1.3. The build server Once we‚Äôve linked LCS and Azure DevOps we‚Äôll have to deploy the build server. This will be the heart of our CI/CD processes.\nEven though the build virtual machine has the same topology as a developer box, it really isn‚Äôt a developer VM and should never be used as one, do not use it as a developer VM! It has Visual Studio installed in it, the AosService folder with all the standard packages and SQL Server with an AxDB, just like all other developer machines, but that‚Äôs not its purpose.\nWe won‚Äôt be using any of those features. The ‚Äúheart‚Äù of the build machine is the build agent, an application which Azure DevOps uses to execute the build definition‚Äôs tasks from Azure DevOps.\nWe can also use Azure hosted build agents. Azure hosted agents allow us to run a build without a VM, the pipeline runs on Azure. We‚Äôll see this later.\n0.1.3.1. The build VM This VM is usually the dev box on Microsoft‚Äôs subscription but you can also use a regular cloud-hosted environment as a build VM.\nWhen this VM is deployed there‚Äôs two things happening: the basic source code structure and the default build definition are created.\n0.1.4. Visual Studio We have the basics to start working. Log into your dev VM and start Visual Studio, we must map the Main folder to the development machine‚Äôs packages folder. Open the team explorer and select ‚ÄúConnect to a Project‚Ä¶‚Äù:\nIt will ask for your credentials and then show all projects available with the account you‚Äôve used. Select the project we have created in the steps earlier and click on ‚ÄúConnect‚Äù:\nNow open the ‚ÄúSource Control Explorer‚Äù, select the Main folder and click on the ‚ÄúNot mapped‚Äù text:\nMap the Main folder to the K:\\AosService\\PackagesLocalDirectory folder on your service drive (this could be drive C if you‚Äôre using a local VM instead of a cloud-hosted environment):\nWhat we‚Äôve done in this step is telling Visual Studio that what‚Äôs in our Azure DevOps project, inside the Main folder, will go into the K:\\AosService\\PackagesLocalDirectory folder of our development VM.\nThe Main folder we have in our source control tree is a regular folder, but we can convert it into a branch if we need it.\nIn the image above, you can see the icon for Main changes when it‚Äôs converted to a branch. Branches allow us to perform some actions that aren‚Äôt available to folders. Some differences can be seen in the context menu:\nFolder context menu\nBranch context menu\nFor instance, branches can display the hierarchy of all the project branches (in this case it‚Äôs only Main and Dev so it‚Äôs quite simple).\nProperties dialogs are different too. The folder one:\nAnd the branch one, where we can see the different relationships between the other branches created from Main:\nThis might be not that interesting or useful, but one of the things converting a folder into a branch is seeing where has a changeset been merge into.\n0.1.5. Some advice I strongly recommend moving the Projects folder out of the Main branch (or whatever you call it) into the root of the project, at the same level as BuildProcessTemplates and Trunk. In fact, and this is my personal preference, I would keep anything that‚Äôs not code outside of a branch. By doing this you only need to take care of the code when merging and branching.\nThose who have been working with AX for several years were used to not use version-control systems. MSDyn365FO has taken us to uncharted territory, so it is not uncommon for different teams to work in different ways, depending on their experience and what they‚Äôve found in the path. Each team will need to invest some time to discover what‚Äôs better for them regarding code, branching and methodologies. Many times, this will be based on experimentation and trial and error, and with the pace of implementation projects trial and error turns out bad.\n0.1.6. Branching strategies I want to make it clear in advance: I‚Äôm not an expert in managing code nor Azure DevOps, at all. All that I‚Äôve written here is product of my experience (good and bad) of over 4 years working with Finance and Operations. In this article on branching strategies from the docs there‚Äôs more information regarding branching and links to articles of the DevOps team. And there‚Äôs even more info in the DevOps Rangers‚Äô Library of tooling and guidance solutions!\n0.1.6.1. Main-Release One possible strategy is using a Main and a Release branch. We have already learnt that the Main branch is created when the Build VM is deployed. The usual is that in an implementation project all development will be done on that branch until the Go Live, and just before that a new Release branch will be created.\nWe will keep development work on the Main branch, and when that passes validation, we‚Äôll move it to Release. This branching strategy is really simple and will keep us mostly worry-free.\n0.1.6.2. Dev ‚Äì Main ‚Äì Release This strategy is similar to the Main ‚Äì Release one but includes a Dev branch for each developer. This dev branch must be maintained by the developer using it. He can do as many check-ins as he wants during a development, and when it‚Äôs done merge all these changes to the Main branch in a single changeset. Of course, this adds some bureaucracy because we also need to forward integrate changes from Main into our Dev branch, but it will allow us to have a cleaner list of changesets when merging them from Main to the Release branch.\nWhatever branching strategy you choose try to avoid having pending changesets to be merged for a long time. The amount of merge conflicts that will appear is directly proportional to the time the changeset has been waiting to be merged.\nI wrote all of this based on my experience. It‚Äôs obviously not the same working for an ISV than for an implementation partner. An ISV has different needs, it must maintain different code versions to support all their customers and they don‚Äôt necessarily need to work in a Main ‚Äì Release manner. They could have one (or more) branch for each version. However, since the end of overlayering this is not necessary. More ideas about this can be found in the article linked at the beginning.\nAzure Pipelines 0.2.1. Builds We‚Äôve already seen that the default build definition has all the default steps active. We can disable (or remove) all the steps we‚Äôre not going to use. For example, the testing steps can be removed if we have no unit testing. We can also create new build definitions from scratch, however it‚Äôs easier to clone the default one and modify it to other branches or needs.\nSince version 8.1 all the X++ hotfixes are gone, the updates are applied in a single deployable package as binaries. This implies that the source-controlled Metadata folder will only contain our custom packages and models, no standard packages anymore.\n0.2.2. Continuous Integration Continuous Integration (CI) is the process of automating the build and testing of code every time a team member commits changes to version control. (source)\nShould your project/team use CI? Yes, yes, yes. This is one of the key feature of using an automated build process.\nThis is how a build definition for CI that will only compile our codebase looks like:\nOnly the prepare and build steps. Then we need to go to the ‚ÄúTriggers‚Äù tab and enable the CI option:\nRight after each developer check-in, a build will be queued, and the code compiled. In case there‚Äôs a compilation error we‚Äôll be notified about it. Of course, we all build the solutions before checking them in and don‚Äôt need this CI build. Right?\n![tysonjaja](./MSDyn365 \u0026 Azure DevOps ALM - ariste.info_files/tysonjaja.gif ‚ÄúMSDyn365 \u0026 Azure DevOps ALM 23‚Äù)\nAnd because we all know that ‚ÄúSlow and steady wins the race‚Äù, but at some point during a project that‚Äôs not possible, so this kind of build definition can help us out. Especially when merging code between branches. This will allow us to be 100% sure when creating a DP to release to production that it‚Äôll work. I can tell you that having to do a release to prod in a hurry and seeing the Main build failing is not nice.\n0.2.3. Gated check-ins A gated check-in is a bit different than a CI build. The gated check-in will trigger an automated build BEFORE checking-in the code. If it fails, the changeset is not cheked-in until the errors are fixed and checked-in again.\nThis option might seem perfect for the merge check-ins to the Main branch. I‚Äôve found some issues trying to use it, for example:\n If multiple merges \u0026 check-ins from the same development are done and the first fails but the second doesn‚Äôt, you‚Äôll still have pending merges to be done. You can try batching the builds, but I haven‚Äôt tried that. Issues with error notifications and pending code on dev VMs. If many check-ins are made, you‚Äôll end up with lots of queued builds (and we only have one available agent per DevOps project). This can also be solved using the ‚ÄúBatch changes while a build is in progress‚Äù.  I think the CI option is working perfectly to validate code. As I‚Äôve already said several times, choose the strategy that better suits your team and your needs. Experiment with CI and Gated check-in builds and decide what is better for you.\n0.2.4. Set up the new Azure DevOps tasks for Packaging and Model Versioning Almost all the tasks of the default build definition use PowerShell scripts that run on the Build VM. We can change 3 of those steps for newer tasks. In order to use these newer tasks, we need to install the ‚ÄúDynamics 365 Unified Operations Tools‚Äù. We‚Äôll be using them to set up our release pipeline too so consider doing it now.\n0.2.4.1. Update Model Version task This one is the easiest, just add it to your build definition under the current model versioning task, disable the original one and you‚Äôre done. If you have any filters in your current task, like excluding any model, you must add the filter in the Descriptor Search Pattern field using Azure DevOps pattern syntax.\n0.2.4.2. Create Deployable Package task This task will replace the Generate packages from the current build definitions. To set it up we just need to do a pair of changes to the default values:\n0.2.4.2.1. X++ Tools Path This is your build VM‚Äôs physical bin folder, the AosService folder is usually on the unit K for cloud-hosted VMs. I guess this will change when we go VM-less to do the builds.\nUpdate!: the route to the unit can be changed for $(ServiceDrive), getting a path like $(ServiceDrive)\\AOSService\\PackagesLocalDirectory\\bin.\n0.2.4.2.2. Location of the X++ binaries to package The task comes with this field filled in as $(Build.BinariesDirectory) but this didn‚Äôt work out for our build definitions, maybe the variable isn‚Äôt set up on the proj file. After changing this to $(Agent.BuildDirectory)\\Bin the package is generated.\n0.2.4.2.3. Filename and path for the deployable package The path on the image should be changed to $(Build.ArtifactStagingDirectory)\\Packages\\AXDeployableRuntime_$(Build.BuildNumber).zip. You can leave it without the Packages folder in the path, but if you do that you will need to change the Path to Publish field in the Publish Artifact: Package step of the definition.\n0.2.4.3. Add Licenses to Deployable Package task This task will add the license files to an existing Deployable Package. Remember that the path of the deployable package must be the same as the one in the Create Deployable Package task.\nAzure hosted build for Dynamics 365 Finance \u0026 SCM The day we‚Äôve been waiting for has come! The Azure hosted builds are in public preview since PU35!! We can now stop asking Joris when will this be available, because it already is! Check the docs!\nI‚Äôve been able to write this because, thanks to Antonio Gilabert, we‚Äôve been testing this at Axazure for a few months with access to the private preview. And of course thanks to Joris for inviting us to the preview!\nRiding the Azure Pipelines by Caza Pelusas\nWhat does this mean? We no longer need a VM to run the build pipelines! Nah, we still need! If you‚Äôre running tests or synchronizing the DB as a part of your build pipeline you still need the VM. But we can move CI builds to the Azure hosted agent!\nYou can also read my full guide on MSDyn365FO \u0026 Azure DevOps ALM.\nRemember this is a public preview. If you want to join the preview you first need to be part of the Dynamics 365 Insider Program where you can join the ‚ÄúDynamics 365 for Finance and Operations Insider Community‚Äú. Once invited you should see a new LCS project called PEAP Assets, and inside its Asset Library you‚Äôll find the nugets in the Nuget package section.\n0.3.1. Azure agents With the capacity to run an extra Azure-hosted build we get another agent to run a pipeline and can run multiple pipelines at the same time. But it still won‚Äôt be parallel pipelines, because we only get one VM-less agent. This means we can run a self-hosted and azure hosted pipeline at the same time, but we cannot run two of the same type in parallel. If we want that we need to purchase extra agents.\nWith a private Azure DevOps project we get 2GB of Artifacts space (we‚Äôll see that later) and one self-hosted and one Microsoft hosted agent with 1800 free minutes:\nAzure hosted build: Azure DevOps project pricing\nWe‚Äôll still keep the build VM, so it‚Äôs difficult to tell a customer we need to pay extra money without getting rid of its cost. Plus we‚Äôve been doing everything with one agent until now and it‚Äôs been fine, right? So take this like extra capacity, we can divide the build between both agents and leave the MS hosted one for short builds to squeeze the 1800 free minutes as much as possible.\n0.3.2. How does it work? There‚Äôs really no magic in this. We move from a self-hosted agent in the build VM to a Microsoft-hosted agent.\nThe Azure hosted build relies on nuget packages to compile our X++ code. The contents of the PackagesLocalDirectory folder, platform and the compiler tools have basically been put into nugets and what we have in the build VM is now on 3 nugets.\nWhen the build runs it downloads \u0026 installs the nugets and uses them to compile our code on the Azure hosted build along the standard packages.\n0.3.3. What do I need? To configure the Azure hosted build we need:\n  The 3 nuget packages from LCS: Compiler tools, Platform X++ and Application X++.\n  nuget.exe\n  A user with rights at the organization level to upload the nugets to Azure DevOps.\n  Some patience to get everything running üôÇ\n  So the first step is going to the PEAP LCS‚Äô Asset Library and downloading the 3 nuget packages:\nNugets for the Azure Hosted Build\n0.3.4. Azure DevOps artifact All of this can be done on your PC or in a dev VM, but you‚Äôll need to add some files and a VS project to your source control so you need to use the developer box for sure.\nHead to your Azure DevOps project and go to the Artifacts section. Here we‚Äôll create a new feed and give it a name:\nYou get 2GB for artifacts, the 3 nuget packages‚Äô size is around 500MB, you should have no issues with space unless you have other artifacts in your project.\nNow press the ‚ÄúConnect to feed‚Äù button and select nuget.exe. You‚Äôll find the instructions to continue there but I‚Äôll explain it anyway.\nThen you need to download nuget.exe and put it in the Windows PATH. You can also get the nugets and nuget.exe in the same folder and forget about the PATH. Up to you. Finally, install the credential provider: download this Powershell script and run it. If the script keeps asking for your credentials and fails try adding -AddNetfx as a parameter. Thanks to Erik Norell for finding this and sharing in the¬†comments of the original post!\nCreate a new file called nuget.config in the same folder where you‚Äôve downloaded the nugets. It will have the content you can see in the ‚ÄúConnect to feed‚Äù page, something like this:\n1 2 3 4 5 6 7   \\ \\  /\\  key\\=\"AASBuild\" value\\=\"https://pkgs.dev.azure.com/aariste/aariste365FO/\\_packaging/AASBuild/nuget/v3/index.json\" /\\ /packageSources\\ /configuration\\   This file‚Äôs content has to be exactly the same as what‚Äôs displayed in your ‚ÄúConnect to feed‚Äù page.\nAnd finally, we‚Äôll push (upload) the nugets to our artifacts feed. We have to do this for each one of the 3 nugets we‚Äôve downloaded:\n1  nuget.exe push -Source \"AASBuild\" -ApiKey az packagePath   You‚Äôll get prompted for the user. Remember it needs to have enough rights on the project.\nOf course, you need to change ‚ÄúAASBuild‚Äù for your artifact feed name. And we‚Äôre done with the artifacts.\n0.3.5. Prepare Azure DevOps This new agent needs a solution to build our packages. This means we have to create an empty solution in Visual Studio and set the package of the project to our main package. Like this:\nVisual Studio solution\nIf you have more than one package or models, you need to add a project to this solution for each separate model you have.\nWe have to create another file called packages.config with the following content:\n1 2 3 4 5 6     id\\=\"Microsoft.Dynamics.AX.Platform.DevALM.BuildXpp\" version\\=\"7.0.5644.16778\" targetFramework\\=\"net40\" /  id\\=\"Microsoft.Dynamics.AX.Application.DevALM.BuildXpp\" version\\=\"10.0.464.13\" targetFramework\\=\"net40\" /  id\\=\"Microsoft.Dynamics.AX.Platform.CompilerPackage\" version\\=\"7.0.5644.16778\" targetFramework\\=\"net40\" /    The version tag will depend on when you‚Äôre reading this, but the one above is the correct one for PU35. We‚Äôll need to update this file each time a new version of the nugets is published.\nAnd, to end with this part, we need to add the solution, the nuget.config and the packages.config files to TFVC. This is what I‚Äôve done:\nAzure DevOps\nYou can see I‚Äôve created a Build folder in the root of my DevOps project. That‚Äôs only my preference, but I like to only have code in my branches, even the projects are outside of the branches, I only want the code to move between merges and branches. Place the files and solution inside the Build folder (or wherever you decide).\n0.3.6. Configure pipeline Now we need to create a new pipeline, you can just import this template from the newly created X++ (Dynamics 365) Samples and Tools Github project. After importing the template we‚Äôll modify it a bit. Initially, it will look like this:\nAzure hosted build: Default imported pipeline\nAs you can see the pipeline has all the steps needed to generate the DP, but some of them, the ones contained in the Dynamics 365 tasks, won‚Äôt load correctly after the import. You just need to add those steps to your pipeline manually and complete its setup.\n0.3.6.1. Pipeline root You need to select the Hosted Azure Pipelines for the Agent pool, and vs2017-win2016 as Agent Specification.\n0.3.6.2. Get sources Azure hosted build: Our mappings\nI‚Äôve mapped 2 things here: our codebase in the first mapping and the Build folder where I‚Äôve added the solution and config files. If you‚Äôve placed these files inside your Metadata folder you don‚Äôt need the extra mapping.\n0.3.6.3. NuGet install Packages This step gets the nugets from our artifacts feeds and the installs to be used in each pipeline execution.\nAzure hosted build: nuget install\nThe command uses the config files we have uploaded to the Build folder, and as you can see it‚Äôs fetching the files from the $(build.sourcesDirectory)\\Build directory we‚Äôve configured in the Get sources step. If you‚Äôve placed those files in a diferent place you need to change the paths as needed.\n0.3.6.4. Update Model Version This is one of the steps that are displaying issues even though I got the Dynamics 365 tools installed from the Azure DevOps marketplace. If you got it right you probably don‚Äôt need to change anything. If you have the same issue as me, just add a new step and select the ‚ÄúUpdate Model Version‚Äù task and change the fields so it looks like this:\nAzure hosted build: Update Model Version\n0.3.6.5. Build solution Build solution step\nIn the build solution step, you have a wildcard in the solution field: **\\\\*.sln. If you leave this wildcard it will build all the projects you have in the repo and, depending on the number of projects you have, the build could time out.\nI solve this by selecting a solution, that contains all the models I have, that I have placed in the Build folder in my repo, and update that solution if you add or remove any model.\nThanks to Ievgen Miroshnikov for pointing this out!\nThere could be an additional issue with the rnrproj files as Josh Williams points out in a comment. If your project was created pre-PU27 try creating a new solution to avoid problems.\n0.3.6.6. Create Deployable Package This is another one of the steps that are not loading correctly for me. Again, add it and change as needed:\nAzure hosted build: Create Deployable Package\n0.3.6.7. Add Licenses to Deployable Package Another step with issues. Do the same as with the others:\nAzure hosted build: Add Licenses to Deployable Package\nAnd that‚Äôs all. You can queue the build to test if it‚Äôs working. For the first runs you can disable the steps after the ‚ÄúBuild solution‚Äù one to see if the nugets are downloaded correctly and your code built. After that try generating the DP and publishing the artifact.\nYou‚Äôve configured your Azure hosted build, now it‚Äôs your turn to decide in which cases will you use the self-hosted or the azure hosted build.\n0.3.7. Update for version 10.0.18 Since version 10.0.18 we‚Äôll be getting 4 NuGet packages instead of 3 because of the Microsoft.Dynamics.AX.Application.DevALM.BuildXpp NuGet size is getting near or over the max size which is 500MB and will come as 2 NuGet packages from now on.\nYou can read about this in the docs.\nThere just 2 small changes we need to do to the pipeline if we‚Äôre already using it, one to the packages.config file and another one to the pipeline.\n0.3.7.1. packages.config The packages.config file will have an additional line for the Application Suite NuGet.\n1 2 3 4 5 6 7 8 9 10 11 12 13   \\  id\\=\"Microsoft.Dynamics.AX.Platform.DevALM.BuildXpp\" version\\=\"7.0.5968.16973\" targetFramework\\=\"net40\" /\\  id\\=\"Microsoft.Dynamics.AX.Application.DevALM.BuildXpp\" version\\=\"10.0.793.16\" targetFramework\\=\"net40\" /\\  id\\=\"Microsoft.Dynamics.AX.ApplicationSuite.DevALM.BuildXpp\" version\\=\"10.0.793.16\" targetFramework\\=\"net40\" /\\  id\\=\"Microsoft.Dynamics.AX.Platform.CompilerPackage\" version\\=\"7.0.5968.16973\" targetFramework\\=\"net40\" /\\ /packages\\   0.3.7.2. Pipeline We need to add a new variable to the pipeline variables called AppSuitePackage with the value Microsoft.Dynamics.AX.ApplicationSuite.DevALM.BuildXpp.\nNew Azure DevOps pipeline variable\nAnd then use it in the build step and change it to:\n1  /p:BuildTasksDirectory\\=\"$(NugetsPath)\\\\$(ToolsPackage)\\\\DevAlm\" /p:MetadataDirectory\\=\"$(MetadataPath)\" /p:FrameworkDirectory\\=\"$(NuGetsPath)\\\\$(ToolsPackage)\" /p:ReferenceFolder\\=\"$(NuGetsPath)\\\\$(PlatPackage)\\\\ref\\\\net40;$(NuGetsPath)\\\\$(AppPackage)\\\\ref\\\\net40;$(MetadataPath);$(Build.BinariesDirectory);$(NuGetsPath)\\\\$(AppSuitePackage)\\\\ref\\\\net40\" /p:ReferencePath\\=\"$(NuGetsPath)\\\\$(ToolsPackage)\" /p:OutputDirectory\\=\"$(Build.BinariesDirectory)\"   Azure DevTest Labs powered builds The end of Tier-1 Microsoft-managed build VMs is near, and this will leave us without the capacity to synchronize the DB or run tests in a pipeline, unless we deploy a new build VM in our, or our customer‚Äôs, Azure subscription. Of course, there might be a cost concern with it, and there‚Äôs where Azure DevTest Labs can help us!\nThis post has been written thanks to Joris de Gruyter‚Äòs session in the past DynamicsCon: Azure Devops Automation for Finance and Operations Like You‚Äôve Never Seen! And there‚Äôs also been some investigation and (a lot of) trial-and-error from my side until everything has been working.\nConfiguring the build VM in Azure DevTest Labs\nIf you want to know more about builds, releases, and the Dev ALM of Dynamics 365 you can read my full guide on MSDyn365 \u0026 Azure DevOps ALM.\n0.4.1. But first‚Ä¶ What I‚Äôm showing in this post is not a perfect blueprint. There‚Äôs a high probability that if you try exactly the same as I do here, you won‚Äôt get the same result. But it‚Äôs a good guide to get started and do some investigation on your own and learn.\n0.4.2. Azure DevTest Labs Azure DevTest Labs is an Azure tool/service that allows us to deploy virtual machines and integrate them with Azure DevOps pipelines, and many other things, but what I‚Äôm going to explain is just the VM and pipeline part.\nWhat will I show in this post? How to prepare a Dynamics 365 Finance and Operations VHD image to be used as the base to create a build virtual machine from an Azure DevOps pipeline, build our codebase, synchronize the DB, run tests, even deploy the reports, generate the deployable package and delete the VM.\n0.4.3. Getting and preparing the VHD This is by far the most tedious part of all the process because you need to download 11 ZIP files from LCS‚Äô Shared Asset Library, and we all know how fast things download from LCS.\nHow is LCS download speed?\nAnd to speed it up we can create a blob storage account on Azure and once more turn to M√∂tz Jensen‚Äòs d365fo.tools and use the Invoke-D365AzCopyTransfer cmdlet. Just go to LCS, click on the ‚ÄúGenerate SAS link‚Äù button for each file, use it as the source parameter in the command and your blob SAS URL as the destination one. Once you have all the files in your blob you can download them to your local PC at a good speed.\nOnce you‚Äôve unzipped the VHD you need to change it from Dynamic to Fixed using this PowerShell command:\n1  Convert-VHD ‚ÄìPath VHDLOCATION.vhd ‚ÄìDestinationPath NEWVHD.vhd ‚ÄìVHDType Fixed   The reason is you can‚Äôt create an Azure VM from a dynamically-sized VHD. And it took me several attempts to notice this üôÇ\n0.4.4. Create a DevTest Labs account To do this part you need an Azure account. If you don‚Äôt have one you can sign up for a free Azure account with a credit of 180 Euros (200 US Dollars) to be spent during 30 days, plus many other free services during 12 months.\nSearch for DevTest Labs in the top bar and create a new DevTest Lab. Once it‚Äôs created open the details and you should see something like this:\nAzure DevTest Labs\nClick on the ‚ÄúConfiguration and policies‚Äù menu item at the bottom of the list and scroll down in the menu until you see the ‚ÄúVirtual machine bases‚Äù section:\nDevTest Labs custom image\nAnd now comes the second funniest part of the process: we need to upload the 130GB VHD image to a blob storage account! So, click the ‚ÄúAdd‚Äù button on top and in the new dialog that will open click the ‚ÄúUpload a VHD using PowerShell‚Äù. This will generate a PowerShell script to upload the VHD to the DevTest Labs blob. For example:\n1 2 3   Add-AzureRmVhd -Destination \"https://YOURBLOB.blob.core.windows.net/uploads/tempImage.vhd?sv=2019-07-07\u0026st=2020-12-27T09%3A08%3A26Z\u0026se=2020-12-28T09%3A23%3A26Z\u0026sr=b\u0026sp=rcw\u0026sig=YTeXpxpVEJdSM7KZle71w8NVw9oznNizSnYj8Q3hngI%3D\" -LocalFilePath \"\"   Generated script to upload a local VHD to Azure.\nWARNING: The destination will be publicly available for 24 hours, after which it will expire.\nEnsure you complete your upload by then.\nRun the following command in a Azure PowerShell console after entering\nthe LocalFilePath to your VHD.\n1  Add-AzureRmVhd \\-Destination \"https://YOURBLOB.blob.core.windows.net/uploads/tempImage.vhd?sv=2019-07-07\u0026st=2020-12-27T09%3A08%3A26Z\u0026se=2020-12-28T09%3A23%3A26Z\u0026sr=b\u0026sp=rcw\u0026sig=YTeXpxpVEJdSM7KZle71w8NVw9oznNizSnYj8Q3hngI%3D\" \\-LocalFilePath \"\"   DevTest Labs custom image upload\nAn alternative to this is using the Azure Storage Explorer as you can see in the image on the left.\nYou should upload the VHD to the uploads blob.\nAny of these methods is good to upload the VHD and I don‚Äôt really know which one is faster.\nOnce the VHD is uploaded open the ‚ÄúCustom images‚Äù option again and you should see the VHD in the drop-down:\nDevTest Labs custom image\nGive the image a name and click OK.\nWhat we have now is the base for a Dynamics 365 Finance and Operations dev VM which we need to prepare to use it as a build VM.\n0.4.5. Creating the VM We‚Äôve got the essential, a VHD ready to be used as a base to create a virtual machine in Azure. Our next step is finding a way to make the deployment of this VM predictable and automated. We will attain this thanks to Azure ARM templates.\nGo back to your DevTest Labs overview page and click the ‚ÄúAdd‚Äù button, on the ‚ÄúChoose base‚Äù page select the base you‚Äôve just created, and on the next screen click on the ‚ÄúAdd or Remove Artifacts‚Äù link:\nAdd artifacts to the VM\nSearch for WinRM, select ‚ÄúConfigure WinRM‚Äù, and on the next screen enter ‚ÄúShared IP address‚Äù as the hostname box and click ‚ÄúAdd‚Äù.\nNote: if when the VM runs the artifacts can‚Äôt be installed check whether the Azure VM Agent is installed on the base VHD. Thanks to Joris for pointing this out!\n0.4.5.1. Configure Azure DevOps Agent Service 0.4.5.1.1. Option A: use an artifact Update: thanks to Florian Hopfner for reminding me this because I forgot‚Ä¶ If you choose Option A to install the agent service you need to do some things first!\nThe first thing we need to do is running some PowerShell scripts that create registry entries and environment variables in the VM, go to C:\\DynamicsSDK and run these:\n1 2 3 4 5  Import-Module $(Join-Path \\-Path \"C:\\\\DynamicsSDK\" \\-ChildPath \"DynamicsSDKCommon.psm1\") \\-Function \"Write-Message\", \"Set-AX7SdkRegistryValues\", \"Set-AX7SdkEnvironmentVariables\" Set\\-AX7SdkEnvironmentVariables \\-DynamicsSDK \"C:\\\\DynamicsSDK\" Set\\-AX7SdkRegistryValues \\-DynamicsSDK \"c:\\\\DynamicsSDK\" \\-TeamFoundationServerUrl \"https://dev.azure.com/YOUR\\_ORG\" \\-AosWebsiteName $AosWebsiteName \"AosService\"   The first one will load the functions and make them available in the command-line and the other two create the registry entries and environment variables.\nNow we need to add an artifact for the Azure DevOps agent service. This will configure the agent service on the VM each time the VM is deployed. Search for ‚ÄúAzure Pipelines Agent‚Äù and click it. You will see this:\nDevTest Labs Azure DevOps Agent\nWe need to fill some information:\nOn ‚ÄúAzure DevOps Organization Name‚Äù you need to provide the name of your organization. For example if your AZDO URL is https://dev.azure.com/blackbeltcorp you need to use blackbeltcorp.\nOn ‚ÄúAZDO Personal Access Token‚Äù you need to provide a token generated from AZDO.\nOn ‚ÄúAgent Name‚Äù give your agent a name, like DevTestAgent. And on ‚ÄúAgent Pool‚Äù a name for your pool, a new like DevTestPool or an existing one as Default.\nOn ‚ÄúAccount Name‚Äù use the same user that we‚Äôll use in our pipeline later. Remember this. And on ‚ÄúAccount Password‚Äù its password. Using secrets with a KeyVault is better, but I won‚Äôt explain this here.\nAnd, finally, set ‚ÄúReplace Agent‚Äù to true.\n0.4.5.1.2. Option B: Configure Azure DevOps Agent in the VM To do this you have to create a VM from the base image you created before and then go to C:\\DynamicsSDK and run the SetupBuildAgent script with the needed parameters:\n1  SetupBuildAgent.ps1 \\-VSO\\_ProjectCollection \"https://dev.azure.com/YOUR\\_ORG\" \\-ServiceAccountName \"myUser\" \\-ServiceAccountPassword \"mYPassword\" \\-AgentName \"DevTestAgent\" \\-AgentPoolName \"DevTestPool\" \\-VSOAccessToken \"YOUR\\_VSTS\\_TOKEN\"   WARNING: If you choose option B you must create a new base image from the VM where you‚Äôve run the script. Then repeat the WinRM steps to generate the new ARM template which we‚Äôll see next.\n0.4.5.2. ARM template Then go to the ‚ÄúAdvanced Settings‚Äù tab and click the ‚ÄúView ARM template‚Äù button:\nGet the ARM template\nThis will display the ARM template to create the VM from our pipeline. It‚Äôs something like this:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351  { \"$schema\": \"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json\", \"contentVersion\": \"1.0.0.0\", \"parameters\": { \"newVMName\": { \"type\": \"string\", \"defaultValue\": \"aariste001\" }, \"labName\": { \"type\": \"string\", \"defaultValue\": \"aristeinfo\" }, \"size\": { \"type\": \"string\", \"defaultValue\": \"Standard\\_B4ms\" }, \"userName\": { \"type\": \"string\", \"defaultValue\": \"myUser\" }, \"password\": { \"type\": \"securestring\", \"defaultValue\": \"\\[\\[\\[VmPassword\\]\\]\" }, \"Configure\\_WinRM\\_hostName\": { \"type\": \"string\", \"defaultValue\": \"Public IP address\" }, \"Azure\\_Pipelines\\_Agent\\_vstsAccount\": { \"type\": \"string\", \"defaultValue\": \"ariste\" }, \"Azure\\_Pipelines\\_Agent\\_vstsPassword\": { \"type\": \"securestring\" }, \"Azure\\_Pipelines\\_Agent\\_agentName\": { \"type\": \"string\", \"defaultValue\": \"DevTestAgent\" }, \"Azure\\_Pipelines\\_Agent\\_agentNameSuffix\": { \"type\": \"string\", \"defaultValue\": \"\" }, \"Azure\\_Pipelines\\_Agent\\_poolName\": { \"type\": \"string\", \"defaultValue\": \"DevTestPool\" }, \"Azure\\_Pipelines\\_Agent\\_RunAsAutoLogon\": { \"type\": \"bool\", \"defaultValue\": false }, \"Azure\\_Pipelines\\_Agent\\_windowsLogonAccount\": { \"type\": \"string\", \"defaultValue\": \"aariste\" }, \"Azure\\_Pipelines\\_Agent\\_windowsLogonPassword\": { \"type\": \"securestring\" }, \"Azure\\_Pipelines\\_Agent\\_driveLetter\": { \"type\": \"string\", \"defaultValue\": \"C\" }, \"Azure\\_Pipelines\\_Agent\\_workDirectory\": { \"type\": \"string\", \"defaultValue\": \"DevTestAgent\" }, \"Azure\\_Pipelines\\_Agent\\_replaceAgent\": { \"type\": \"bool\", \"defaultValue\": true } }, \"variables\": { \"labSubnetName\": \"\\[concat(variables('labVirtualNetworkName'), 'Subnet')\\]\", \"labVirtualNetworkId\": \"\\[resourceId('Microsoft.DevTestLab/labs/virtualnetworks', parameters('labName'), variables('labVirtualNetworkName'))\\]\", \"labVirtualNetworkName\": \"\\[concat('Dtl', parameters('labName'))\\]\", \"vmId\": \"\\[resourceId ('Microsoft.DevTestLab/labs/virtualmachines', parameters('labName'), parameters('newVMName'))\\]\", \"vmName\": \"\\[concat(parameters('labName'), '/', parameters('newVMName'))\\]\" }, \"resources\": \\[ { \"apiVersion\": \"2018-10-15-preview\", \"type\": \"Microsoft.DevTestLab/labs/virtualmachines\", \"name\": \"\\[variables('vmName')\\]\", \"location\": \"\\[resourceGroup().location\\]\", \"properties\": { \"labVirtualNetworkId\": \"\\[variables('labVirtualNetworkId')\\]\", \"notes\": \"Dynamics365FnO10013AgentLessV2\", \"customImageId\": \"/subscriptions/6715778f-c852-453d-b6bb-907ac34f280f/resourcegroups/devtestlabs365/providers/microsoft.devtestlab/labs/devtestd365/customimages/dynamics365fno10013agentlessv2\", \"size\": \"\\[parameters('size')\\]\", \"userName\": \"\\[parameters('userName')\\]\", \"password\": \"\\[parameters('password')\\]\", \"isAuthenticationWithSshKey\": false, \"artifacts\": \\[ { \"artifactId\": \"\\[resourceId('Microsoft.DevTestLab/labs/artifactSources/artifacts', parameters('labName'), 'public repo', 'windows-winrm')\\]\", \"parameters\": \\[ { \"name\": \"hostName\", \"value\": \"\\[parameters('Configure\\_WinRM\\_hostName')\\]\" } \\] }, { \"artifactId\": \"\\[resourceId('Microsoft.DevTestLab/labs/artifactSources/artifacts', parameters('labName'), 'public repo', 'windows-vsts-build-agent')\\]\", \"parameters\": \\[ { \"name\": \"vstsAccount\", \"value\": \"\\[parameters('Azure\\_Pipelines\\_Agent\\_vstsAccount')\\]\" }, { \"name\": \"vstsPassword\", \"value\": \"\\[parameters('Azure\\_Pipelines\\_Agent\\_vstsPassword')\\]\" }, { \"name\": \"agentName\", \"value\": \"\\[parameters('Azure\\_Pipelines\\_Agent\\_agentName')\\]\" }, { \"name\": \"agentNameSuffix\", \"value\": \"\\[parameters('Azure\\_Pipelines\\_Agent\\_agentNameSuffix')\\]\" }, { \"name\": \"poolName\", \"value\": \"\\[parameters('Azure\\_Pipelines\\_Agent\\_poolName')\\]\" }, { \"name\": \"RunAsAutoLogon\", \"value\": \"\\[parameters('Azure\\_Pipelines\\_Agent\\_RunAsAutoLogon')\\]\" }, { \"name\": \"windowsLogonAccount\", \"value\": \"\\[parameters('Azure\\_Pipelines\\_Agent\\_windowsLogonAccount')\\]\" }, { \"name\": \"windowsLogonPassword\", \"value\": \"\\[parameters('Azure\\_Pipelines\\_Agent\\_windowsLogonPassword')\\]\" }, { \"name\": \"driveLetter\", \"value\": \"\\[parameters('Azure\\_Pipelines\\_Agent\\_driveLetter')\\]\" }, { \"name\": \"workDirectory\", \"value\": \"\\[parameters('Azure\\_Pipelines\\_Agent\\_workDirectory')\\]\" }, { \"name\": \"replaceAgent\", \"value\": \"\\[parameters('Azure\\_Pipelines\\_Agent\\_replaceAgent')\\]\" } \\] } \\], \"labSubnetName\": \"\\[variables('labSubnetName')\\]\", \"disallowPublicIpAddress\": true, \"storageType\": \"Premium\", \"allowClaim\": false, \"networkInterface\": { \"sharedPublicIpAddressConfiguration\": { \"inboundNatRules\": \\[ { \"transportProtocol\": \"tcp\", \"backendPort\": 3389 } \\] } } } } \\], \"outputs\": { \"labVMId\": { \"type\": \"string\", \"value\": \"\\[variables('vmId')\\]\" } } }   NOTE: if you‚Äôre using option B you won‚Äôt have the artifact node for the VSTS agent.\nThis JSON file will be used as the base to create our VMs from the Azure DevOps pipeline. This is known as Infrastructure as Code (IaC) and it‚Äôs a way of defining our infrastructure in a file as it were code. It‚Äôs another part of the DevOps practice that should solve the ‚Äúit works on my machine‚Äù issue.\nIf we take a look to the JSON‚Äôs parameters node there‚Äôs the following information:\n newVMName and labName will be the name of the VM and the DevTest Labs lab we‚Äôre using. The VM name is not really important because we‚Äôll set the name later in the pipeline. size is the VM size, a D3 V2 in the example above, but we can change it and will do it later. userName \u0026 passWord will be the credentials to access the VM and must be the same we‚Äôve used to configure the Azure DevOps agent. Configure_WinRM_hostName is the artifact we added to the VM template that will allow the pipelines to run in this machine.  To do it faster and for demo purposes I‚Äôm using a plain text password in the ARM template, changing the password node to something like this:\n1 2 3 4  \"password\": { \"type\": \"string\", \"defaultValue\": \"yourPassword\" },   I will do the same with all the secureString nodes, but you shouldn‚Äôt and should instead use an Azure KeyVault which comes with the DevTest Labs account.\nOf course you would never upload this template to Azure DevOps with a password in plain text. There‚Äôs plenty of resources online that teach how to use parameters, Azure KeyVault, etc. to accomplish this, for example this one: 6 Ways Passing Secrets to ARM Templates.\nOK, now grab that file and save it to your Azure DevOps repo. I‚Äôve created a folder in my repo‚Äôs root called ARM where I‚Äôm saving all the ARM templates:\nARM templates on Azure DevOps\n0.4.6. Preparing the VM The VHD image you download can be used as a developer VM with no additional work, just run Visual Studio, connect it to your AZDO project and done. But if you want to use it as a build box you need to do several things first.\nRemember that the default user and password for these VHDs are Administrator and Pass@word1.\n0.4.6.1. Disable services First of all we will stop and disable services like the Batch, Management Reporter, SSAS, SSIS, etc. Anything you see that‚Äôs not needed to run a build.\n0.4.6.2. Create a new SQL user Open SSMS (as an Administrator) and create a new SQL user as a copy of the axdbadmin one. Then open the web.config file and update the DB user and password to use the one you‚Äôve just created.\n0.4.6.3. Prepare SSRS (optional) If you want to deploy reports as part of your build pipeline you need to go to SSMS again (and as an Admin again), and open a new query in the reporting DB to execute the following query:\n1  execDeleteEncryptedContent  0.4.6.4. PowerShell Scripts The default build definition that runs on a build VM uses several PowerShell scripts to run some tasks. I‚Äôm adding an additional script called PrepareForAgent.\nThe scripts can be found in the C:\\DynamicsSDK folder of the VM.\n0.4.6.4.1. PrepareForBuild This script comes with the VM and we need to modify it to avoid one thing: the PackagesLocalDirectory backup which is usually done in the first build. We need to get rid of this or we‚Äôll waste around an hour per run until the files are copied.\nWe don‚Äôt need this because our VM will be new each time we run the pipeline!\nSo open the script, go to line 696 and look for this piece of code:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  # Create packages backup (if it does not exist). $NewBackupCreated \\= Backup-AX7Packages \\-BackupPath $PackagesBackupPath \\-DeploymentPackagesPath $DeploymentPackagesPath \\-LogLocation $LogLocation # Restore packages backup (unless a new backup was just created). if (!$NewBackupCreated) { Restore-AX7Packages \\-BackupPath $PackagesBackupPath \\-DeploymentPackagesPath $DeploymentPackagesPath \\-LogLocation $LogLocation \\-RestoreAllFiles:$RestorePackagesAllFiles } if (!$DatabaseBackupToRestore) { $DatabaseBackupPath \\= Get-BackupPath \\-Purpose \"Databases\" Backup-AX7Database \\-BackupPath $DatabaseBackupPath } else { # Restore a database backup (if specified). Restore-AX7Database \\-DatabaseBackupToRestore $DatabaseBackupToRestore }   We need to modify it until we end up with this:\n1 2 3 4  if ($DatabaseBackupToRestore) { Restore-AX7Database \\-DatabaseBackupToRestore $DatabaseBackupToRestore }   We just need the DB restore part and skip the backup, otherwise we‚Äôll be losing 45 minutes in each run for something we don‚Äôt need because the VM will be deleted when the build is completed.\n0.4.6.5. Optional (but recommended): install d365fo.tools Just run this:\n1  Install-Module -Name d365fo.tools   We can use the tools to do a module sync, partial sync or deploy just our reports instead of all.\n0.4.7. Create a new image Once we‚Äôve done all these prepare steps we can log out of this VM and stop it. Do not delete it yet! Go to ‚ÄúCreate custom image‚Äù, give the new image a name, select ‚ÄúI have not generalized this virtual machine‚Äù and click the ‚ÄúOK‚Äù button.\nThis will generate a new image that you can use as a base image with all the changes you‚Äôve done to the original VHD.\n0.4.8. Azure DevOps Pipelines We‚Äôre ready to setup our new build pipeline in Azure DevOps. This pipeline will consist of three steps: create a new VM, run all the build steps, and delete the VM:\nFirst of all check that your pipeline runs on Azure pipelines (aka Azure-hosted):\nDevTest Labs Azure Pipelines\nThe create and delete steps will run on the Azure Pipelines pool. The build step will run on our DevTestLabs pool, or the name you gave it when configuring the artifact on DevTest Labs or the script on the VM.\n0.4.8.1. Create Azure DevTest Labs VM Create a new pipeline and choose the ‚ÄúUse the classic editor‚Äù option. Make sure you‚Äôve selected TFVC as your source and click ‚ÄúContinue‚Äù and ‚ÄúEmpty job‚Äù. Add a new task to the pipeline, look for ‚ÄúAzure DevTest Labs Create VM‚Äù. We just need to fill in the missing parameters with our subscription, lab, etc.\nCreate VM Azure DevTest Labs\nRemember this step must run on the Azure-hosted pipeline.\n0.4.8.2. Build This is an easy one. Just export a working pipeline and import it. And this step needs to run on your self-hosted pool:\nRuns on self-hosted pool\n0.4.8.2.1. Optional: use SelectiveSync (not recommended, see next option) You can replace the Database Sync task for a PowerShell script that will only sync the tables in your models:\nSelectiveSync.ps1\nThanks Joris for the tip!\n0.4.8.2.2. Optional: use d365fo.tools to sync your packages/models This is a better option than the SelectiveSync above. You can synchronize your packages or models only to gain some time. This cmdlet uses sync.exe like Visual Studio does and should be better than SelectiveSync.\nAdd a new PowerShell task, select Inline Script and this is the command:\n1  Invoke-D365DbSyncModule -Module \"Module1\", \"Module2\" -ShowOriginalProgress -Verbose   0.4.8.2.3. Optional: use d365fo.tools to deploy SSRS reports If you really want to add the report deployment step to your pipeline you can save some more extra time using d365fo.tools and just deploy the reports in your models like we‚Äôve done with the DB sync.\nRun this in a new PowerShell task to do it:\n1  Publish-D365SsrsReport -Module YOUR\\_MODULE -ReportName \\*   0.4.8.3. Delete Azure DevTest Labs VM It‚Äôs almost the same as the create step, complete the subscription, lab and VM fields and done:\nDelete VM\nAnd this step, like the create one, will run on the Azure-hosted agent.\n0.4.8.4. Dependencies and conditions When all three steps are configured we need to add dependencies and conditions to some of them. For example, to make sure that the delete VM step runs when the build step fails, but it doesn‚Äôt when the create VM step fails.\n0.4.8.4.1. Build The build step depends on the create VM step, and will only run if the previous step succeeds:\nBuild step dependencies and conditions\n0.4.8.4.2. Delete VM The delete step depends on all previous steps and must run when the create VM step succeeds. If the create step fails there‚Äôs no VM and we don‚Äôt need to delete it:\nDependencies and conditions on delete VM step\nThis is the custom condition we‚Äôll use:\n1  and(always(), eq(dependencies.Job\\_1.status, 'Succeeded'))   If you need to know your first step‚Äôs job name just export the pipeline to YAML and you‚Äôll find it there:\nExport pipeline to YAML\nJob name on YAML\nIf this step fails when the pipeline is run, wait to delete the VM manually, first change the VM name in the delete step, save your pipeline and then use the dropdown to show the VMs in the selected subscription, and save the pipeline.\n0.4.9. Run the build And, I think, we‚Äôre done and ready to run our Azure DevTest Labs pipeline for Dynamics 365 Finance and Operations‚Ä¶ click ‚ÄúRun pipeline‚Äù and wait‚Ä¶\nTadaaaa!!\n0.4.10. Times The pipeline from the image above is one with real code from a customer but I can‚Äôt compare the times with the Azure-hosted builds because there‚Äôs no sync, or tests there. Regarding the build time the Azure-hosted takes one minute less, but it needs to install the nugets first.\nBut for example this is a comparison I did:\nAzure DevTest Labs B2ms vs B4ms\nIt takes around 1 hour to create the VM, build, do a full DB synch, deploy reports, run tests, generate a Deployable Package and, finally, delete the VM:\nIf you skip deploying the SSRS reports your build will run in 15 minutes less, that‚Äôs around 45 minutes.\nIf you use the partial sync process instead of a full DB sync it‚Äôll be 5-7 minutes less.\nThis would leave us with a 35-40 minutes build.\n0.4.10.1. Comparison 1 No DB Sync\nThe image above shows a simple package being compiled, without any table, so the selective sync goes really fast. The build times improve with VM size.\n0.4.10.2. Comparison 2 Same code Full DB Sync\nThis one is compiling the same codebase but is doing a full DB sync. The sync time improves in the B4ms VM compared to the B2ms but it‚Äôs almost the same in the B8ms. Build times are better for larger VM sizes.\n0.4.10.3. Comparison 3 Real code + full sync\nAnd in the image above we see a more realistic build. The codebase is larger and we‚Äôre doing a full DB sync.\nSimilar as the comparison before there a good enhancement between a B2ms and a B4ms, but not between a B4ms and B8ms.\n0.4.11. Show me the money! I think this is the interesting comparison. How did a Tier-1 MS-hosted build VM cost? Around 400‚Ç¨? How does it compare to using the Azure DevTest Labs alternative?\nThere‚Äôs only one fix cost when using Azure DevTest Labs: the blob storage where the VHD is uploaded. The VHD‚Äôs size is around 130GB and this should have a cost of, more or less, 5 euros/month. Keep in mind that you need to clean up your custom images when yours is prepared, the new ones are created as snapshots and also take space in the storage account.\nThen we have the variable costs that come with the deployment of a VM each build but it‚Äôs just absurd. Imagine we‚Äôre using a B4ms VM, with a 256GB Premium SSD disk, we would pay 0.18‚Ç¨/hour for the VM plus the proportional part of 35.26‚Ç¨/month of the SSD disk, which would be like 5 cents/hour?\nBut this can run on a B2ms VM too which is half the compute price of the VM, down to 9 cents per hour.\nIf we run this build once a day each month, 30 times, the cost of a B4ms would be like‚Ä¶ 7‚Ç¨? Add the blob storage and we‚Äôll be paying 12‚Ç¨ per month to run our builds with DB sync and tests.\nIs it cheaper than deploying a cloud-hosted environment, and starting and stopping it using the new d365fo.tools Cmdlets each time we run the build? Yes it is! Because if we deploy a CHE we‚Äôll be paying the price of the SSD disk for the whole month!\n0.4.12. Some final remarks  I have accomplished this mostly through trial-and-error. There‚Äôs lots of enhancements and best practices to be applied to all the process, specially using an Azure Key Vault to store all the secrets to be used in the Azure DevOps Agent artifact and the pipeline. This in another clear example that X++ developers need to step outside of X++ and Dynamics 365 FnO. We‚Äôre not X++ only developers anymore, we‚Äôre very lucky to be working on a product that is using Azure. I‚Äôm sure there‚Äôs scenarios where using DevTest Labs to create a build VM is useful. Maybe not for an implementation partner, but maybe it is for an ISV partner. It‚Äôs just an additional option. The only bad thing to me is that we need to apply the version upgrades manually to the VHDs because they‚Äôre published only twice a year. As I said at the beginning of the post, it may have worked to me with all these steps, but if you try you maybe need to change some things. But it‚Äôs a good way to start.  Add and build .NET projects I bet that most of us have had to develop some .NET class library to solve something in Dynamics 365 Finance and Operations. You create a C# project, build it, and add the DLL as a reference in your FnO project. Don‚Äôt do that anymore! You can add the .NET project to source control, build it in your pipeline, and the DLL gets added to the deployable package!\nI‚Äôve been trying this during the last days after a conversation on Yammer, and while I‚Äôve managed to build .NET and X++ code in the same pipeline, I‚Äôve found some issues or limitations.\n0.5.1. Build .NET in your pipeline Note: what I show in this post is done using the Azure-hosted pipeline but it should also be possible to do it using a self-hosted agent (aka old build VM).\nThe build step of the pipeline invokes msbuild.exe which can build .NET code. If we check the logs of the build step we will see it:\nmsbuild.exe builds C# projects and our X++ ones too!\nRemember that X++ is part of the .NET family after all‚Ä¶ a second cousin or something like it.\nBuild folder\nIf you‚Äôve read the blog post about Azure-hosted builds you must‚Äôve seen I‚Äôm putting the solution that references all my models in a folder called Build at the root of my source control tree (left image).\nThat‚Äôs just a personal preference that helps me keep the .config files and the solution I use to build all the models in a single, separate place.\nBy using a solution and pointing the build process to use it I also keep control of what‚Äôs being built in a single place.\n0.5.2. Add a C# project to FnO Our first step will usually be creating a Finance and Operations project. Once it‚Äôs created we right-click on the solution and select ‚ÄúAdd new project‚Äù. Then we select a Visual C# Class Library project:\nC# project in Dynamics 365\nNow we should have a solution with a FnO Project and a C# project (right image).\nTo demo this I‚Äôll create a class called Calculator with a single method that accepts two decimal values as parameters and returns it‚Äôs sum. An add method.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  public class Calculator { public decimal Add(decimal a, decimal b) { return a + b; } } public class Calculator { public decimal Add(decimal a, decimal b) { return a + b; } }   Now compile the C# project alone, not the whole solution. This will create the DLL in the bin folder of the project. We have to do this before adding the C# project as a reference to the FnO project.\nRight click on the References node of the FnO project and select ‚ÄúAdd Reference‚Ä¶‚Äù:\nAdd reference to FnO project\nA window will open and you should see the C# project in the ‚ÄúProjects‚Äù tab:\nAdd C# project reference to FnO project\nSelect it and click the Ok button. That will add the C# project as a reference to our FnO project, but we still need to do something or this won‚Äôt compile in our pipeline. We have to manually add the reference to the project that has been created in the AOT. So, right-click on the reference and select ‚ÄúAdd to source control‚Äù:\nAdd the reference to source control\nIn the FnO project add a Runnable Class, we‚Äôll call the C# library there:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  using AASBuildNetDemoLibrary; class AASBuildNetTest { public static void main(Args \\_args) { var calc = new Calculator(); calc.Add(4, 5); } } using AASBuildNetDemoLibrary; class AASBuildNetTest { public static void main(Args \\_args) { var calc \\= new Calculator(); calc.Add(4, 5); } }   Add the solution to source control if you haven‚Äôt, make sure all the objects are also added and check it in.\n0.5.3. Build pipeline If I go to my Azure DevOps repo we‚Äôll see the following:\nProjects and objects\nYou can see I‚Äôve checked-in the solution under the Build folder, as I said earlier this is my personal preference and I do that to keep the solutions I‚Äôll use to build the code under control.\nIn my build pipeline I make sure I‚Äôm using this solution to build the code:\nBuild Dynamics 365 solution\nRun the pipeline and when it‚Äôs done you can check the build step and you‚Äôll see a line that reads:\n1  Copying file from \"D:\\\\a\\\\9\\\\s\\\\Build\\\\AASBuildNetDemo\\\\AASBuildNetDemoLibrary\\\\bin\\\\Debug\\\\AASBuildNetDemoLibrary.dll\" to \"D:\\\\a\\\\9\\\\b\\\\AASDemo\\\\bin\\\\AASBuildNetDemoLibrary.dll\".   And if you download the DP, unzip it, navigate to AOSService\\Packages\\files and unzip the file in there, then open the bin folder, you‚Äôll see our library‚Äôs DLL there:\nVictory!\n0.5.4. Things I don‚Äôt like/understand/need to investigate I‚Äôve always done this with a single solution and only one C# project. I have some doubts about how this will work with many C# projects, models, solutions, etc.\nFor example, if a model has a dependency on the DLL but it‚Äôs built before the DLL the build will fail. I‚Äôm sure there‚Äôs a way to set an order to solve dependencies like there is for FnO projects within a solution.\nOr maybe I could try building all the C#/.NET projects before, pack them in a nuget and use the DLLs later in the FnO build, something similar to what Paul Heisterkamp explained in his blog.\nAnyway, it‚Äôs your choice how to manage your C# projects and what solution fits your workflow the best, but at least you‚Äôve got an example here üôÇ\nSetup Release Pipelines We‚Äôve seen how the default build definition is created and how we can modify it. Now we‚Äôll see how to configure our release pipelines!\nThe release pipelines allow us to automatically deploy our Deployable Packages to a Tier 2+ environment. This is part of the Continuous Delivery (CD) strategy. We can only do this for the UAT environments, it‚Äôs not possible to automate the deployment to the production environment.\n0.6.1. Setting up Release Pipeline in Azure DevOps for Dynamics 365 for Finance and Operations To configure the release pipeline, we need:\n AAD app registration LCS project An Azure DevOps project linked to the LCS project above A service account  I recommend a service account to do this, with a non-expiring password and no MFA enabled. It must have enough privileges on LCS, Azure and Azure DevOps too. This is not mandatory and can be done even with your user (if it has enough rights) for testing purposes, but if you‚Äôre setting this up don‚Äôt use your user and go for a service account.\n0.6.2. AAD app creation The first step to take is creating an app registration on Azure Active Directory to upload the generated deployable package to LCS. Head to¬†Azure portal¬†and once logged in go to Azure ActiveDirectory, then App Registrations and create a new Native app:\nNext go to ‚ÄúSettings‚Äù and ‚ÄúRequired permissions‚Äù to add the Dynamics Lifecycle Services API:\nIn the dialog that will open change to the ‚ÄúAPIs my organization uses‚Äù tab and select ‚ÄúDynamics Lifecycle Services‚Äù:\nSelect the only available permission in the next screen and click on the ‚ÄúAdd permissions‚Äù button. Finally press the ‚ÄúGrant admin consent‚Äù button to apply the changes. This last step can be easily forgotten and the package upload to LCS cannot be done if not granted. Once done take note of the Application ID, we‚Äôll use it later.\n0.6.3. Create the release pipeline in DevOps Go to Azure DevOps, and to Pipelines - Releases to create the new release. Select ‚ÄúNew release pipeline‚Äù and choose ‚ÄúEmpty job‚Äù from the list.\nOn the artifact box select the build which will be used for this release definition:\nPick the build definition you want to use for the release in ‚ÄúSource‚Äù, ‚ÄúLatest‚Äù in ‚ÄúDefault version‚Äù and push ‚ÄúAdd‚Äù.\n0.6.3.1. Upload to LCS The next step we‚Äôll take is adding a Task with the release pipeline for Dynamics. Go to the Tasks tab and press the plus button. A list with extension will appear, look for ‚ÄúDynamics 365 Unified Operations Tools‚Äù:\nIf the extension hasn‚Äôt been added previously it can be done in this screen. In order to add it, the user used to create the release must have admin rights on the Azure DevOps account, not only in the project in which we‚Äôre creating the pipeline.\nWhen the task is created we need to fill some parameters:![Release Dynamics Operations](./MSDyn365 \u0026 Azure DevOps ALM - ariste.info_files/Captura-de-pantalla-2019-02-03-a-les-0.43.11-1024x508.png.webp ‚ÄúMSDyn365 \u0026 Azure DevOps ALM 84‚Äù)\n0.6.3.2. Apply deployable package This step is finally available for self-service environments! If you already set this for a regular environment you can still change the task to the new version.\nAzure DevOps asset deployment\nThe new task version 1 works for both type of environments: Microsoft managed (regular environments) and self-service environments. The task version 0 is the old one and will only work with regular environments. You can safely switch your deploy tasks to version 1.\nWhat‚Äôs different in task version 1? I guess that some work behind it that we don‚Äôt see to make it support self-service, but in the UI we only see a new field called ‚ÄúName for the update‚Äú.\nName for the update field\nThis field is needed only for the self-service environments deployments, it will be ignored for regular ones, and corresponds to the field with the same name that appears on LCS when we apply an update to a sandbox environment:\nName for this update in LCS\nThe default field‚Äôs value is the variable $(Release.ReleaseName) that is the name of the release, but you can change it, for example I‚Äôll be using a pattern like PREFIX BRANCH $(Build.BuildNumber) to have the same name we have for the builds and identifying what we‚Äôre deploying to prod quickier.\n0.6.4. Creating the LCS connection The first step in the task is setting up the link to LCS using the AAD app we created before. Press New and let‚Äôs fill the fields in the following screen:\nIt‚Äôs only necessary to fill in the connection name, username, password (from the user and Application (Client) ID fields. Use the App ID we got in the first step for the App ID field. The endpoint fields should be automatically filled in. Finally, press OK and the LCS connection is ready.\nIn the LCS Project Id field, use the ID from the LCS project URL, for example in https://lcs.dynamics.com/V2/ProjectOverview/1234567 the project is is 1234567.\nPress the button next to ‚ÄúFile to upload‚Äù and select the deployable package file generated by the build:\nIf the build definition hasn‚Äôt been modified, the output DP will have a name like AXDeployableRuntime_VERSION_BUILDNUMBER.zip. Change the fixed Build Number for the DevOps variable $(Build.BuildNumber) like in the image below:\nThe package name and description in LCS are defined in ‚ÄúLCS Asset Name‚Äù and ‚ÄúLCS Asset Description‚Äù. For these fields, Azure DevOps‚Äô build variables and release variables can be used. Use whatever fits your project, for example a prefix to distinguish between prod and pre-prod packages followed by $(Build.BuildNumber), will upload the DP to LCS with a name like Prod 2019.1.29.1, using the date as a DP name.\nSave the task and release definition and let‚Äôs test it. In the Releases select the one we have just created and press the ‚ÄúCreate a release‚Äù button, in the dialog just press OK. The release will start and, if everything is OK we‚Äôll see the DP in LCS when it finishes:\nThe release part can be automated, just press the lightning button on the artifact and enable the trigger:\nAnd that‚Äôs all! Now the build and the releases are both configured. Once the deployment package is published the CI scenario will be complete.\nMore automation! I‚Äôve already explained in the past how to automate the builds, create the CI builds and create the release pipelines on Azure DevOps, what I want to talk about in this post is about adding a little bit more automation.\nBuilds In the build definition go to the ‚ÄúTriggers‚Äù tab and enable a scheduled build:\nThis will automatically trigger the build at the time and days you select. In the example image, every weekday at 16.30h a new build will be launched. But everyday? Nope! What the ‚ÄúOnly schedule builds if the source or pipeline has changed‚Äù checkbox below the time selector makes is only triggering the build if there‚Äôs been any change to the codebase, meaning that if there‚Äôs no changeset checked-in during that day no build will be triggered.\nReleases First step done, let‚Äôs see what can we do with the releases:\nThe release pipeline in the image above is the one that launches after the build I‚Äôve created in the first step. For this pipeline I‚Äôve added the following:\nThe continuous deployment trigger has been enabled, meaning that after the build finishes this release will be automatically run. No need to define a schedule but you could also do that.\nAs you can see, the schedule screen is exactly the same as in the builds, even the changed pipeline checkbox is there.¬†You can use any of these two approaches, CD or scheduled release, it‚Äôs up to your project or team needs.\nWith these two small steps you can have your full CI and CD strategy automatized and update a UAT environment each night to have all the changes done during that day ready for testing, with no human interaction!\nBut I like to add some human touch to it If you don‚Äôt like not knowing if an environment is being updated‚Ä¶ well that‚Äôs IMPOSSIBLE because LCS will SPAM you to make sure you know what‚Äôs going on. But if you don‚Äôt want to be completely replaced by robots you can add approvals to your release flow:\nClicking the left lightning + person button on your release you can set the approvers, a person or a group (which is quite practical), and the kind of approval (all or single approver) and the timeout. You will also receive an email with a link to the approval form:\nAnd you can also postpone the deployment! Everything is awesome!\nExtra bonus! A little tip. Imagine you have the following release:\nThis will update 3 environments, but will also upload the same Deployable Package three times to LCS. Wouldn‚Äôt it be nice to have a single upload and that all the deployments used that file? Yes, but we can‚Äôt pass the output variable from the upload to other stages üôÅ Yes that‚Äôs unfortunately right. But we can do something with a little help from our friend Powershell!\nUpdate a variable in a release What we need to do is create a variable in the release definition and set its scope to ‚ÄúRelease‚Äù:\nThen, for each stage, we need to enable this checkbox in the agent job:\nI explain later why we‚Äôre enabling this. We now only need to update this variable after uploading the DP to LCS. Add an inline Powershell step after the upload one and do this:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49  # Populate store value to update pipeline $assetId\\= \"$(GoldenUpload.FileAssetId)\" Write\\-Output ('##vso\\[task.setvariable variable=localAsset\\]{0}' \\-f $assetId) #region variables  $ReleaseVariableName \\= 'axzfileid' $releaseurl \\= ('{0}{1}/\\_apis/release/releases/{2}?api-version=5.0' \\-f $($env:SYSTEM\\_TEAMFOUNDATIONSERVERURI), $($env:SYSTEM\\_TEAMPROJECTID), $($env:RELEASE\\_RELEASEID) ) #endregion  #region Get Release Definition  Write\\-Host \"URL: $releaseurl\" $Release \\= Invoke\\-RestMethod \\-Uri $releaseurl \\-Headers @{ Authorization \\= \"Bearer $env:SYSTEM\\_ACCESSTOKEN\" } #endregion  #region Output current Release Pipeline  #Write-Output ('Release Pipeline variables output: {0}' -f $($Release.variables | #ConvertTo-Json -Depth 10)) #endregion  #Update axzfileid with new value $release.variables.($ReleaseVariableName).value \\= $assetId #region update release pipeline  Write\\-Output ('Updating Release Definition') $json \\= @($release) | ConvertTo\\-Json \\-Depth 99 $enc \\= \\[System.Text.Encoding\\]::UTF8 $json\\= $enc.GetBytes($json) Invoke\\-RestMethod \\-Uri $releaseurl \\-Method Put \\-Body $json \\-ContentType \"application/json\" \\-Headers @{Authorization \\= \"Bearer $env:SYSTEM\\_ACCESSTOKEN\" } #endregion   You need to change the following:\n Line 2: $assetId= ‚Äú$(GoldenUpload.FileAssetId)‚Äù. Change $(GoldenUpload.FileAssetId) for your output variable name. Line 6: $ReleaseVariableName = ‚Äòaxzfileid‚Äô. Change axzfileid for your Release variable name.  And you‚Äôre done. This script uses Azure DevOps‚Äô REST API to update the variable value with the file id, and we enabled the OAuth token checkbox to allow the usage of this API without having to pass any user credentials. This is not my idea obviously, I‚Äôve done this thanks to this post from Stefan Stranger‚Äôs blog.\nNow, in the deploy stages you need to retrieve your variable‚Äôs value in the following way:\nDon‚Äôt forget the ( ) or it won‚Äôt work!\nAnd with these small changes you can have a release like this:\nWith a single DP upload to LCS and multiple deployments using the file uploaded in the first stage. With approvals, and delays, and emails, and everything!\nLCS DB API Call the LCS Database Movement API from your Azure DevOps Pipelines 2.1.1. What for? Basically, automation. Right now the API only allows the refresh from one Microsoft Dynamics 365 for Finance and Operations environment to another, so the idea is having fresh data from production in our UAT environments daily. I don‚Äôt know which new operations the API will support in the future but another idea could be adding the DB export operation (creating a bacpac) to the pipeline and having a copy of prod ready to be restored in a Dev environment.\nDon‚Äôt forget that the API has a limit of 3 refresh operations per environment per 24 hours. Don‚Äôt do this on a CI build! (it makes no sense either). Probably the best idea is to run this nightly with all your tests, once a day.\n2.1.2. Calling the API I‚Äôll use PowerShell to call the API from a pipeline. PowerShell has a command called Invoke-RestMethod that makes HTTP/HTTPS requests. It‚Äôs really easy and we just need to do the same we did to call the API in my post.\n2.1.2.1. Getting the token 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  $projectId \\= \"1234567\" $tokenUrl \\= \"https://login.microsoftonline.com/common/oauth2/token\" $clientId \\= \"12345678-abcd-432a-0666-22de4c4321aa\" $clientSecret \\= \"superSeCrEt12345678\" $username \\= \"youruser@tenant.com\" $password \\= \"strongerThan123456\" $tokenBody \\= @{ grant\\_type \\= \"password\" client\\_id \\= $clientId client\\_secret \\= $clientSecret resource \\= \"https://lcsapi.lcs.dynamics.com\" username \\= $username password \\= $password } $tokenResponse \\= Invoke\\-RestMethod \\-Method 'POST' \\-Uri $tokenUrl \\-Body $tokenBody $token \\= $tokenResponse.access\\_token   To get the token we‚Äôll use this script. Just change the variables for the ones of your project, AAD App registration, user (remember it needs access to the preview) and password and run it. If everything is OK you‚Äôll get the JSON response in the $tokenResponse variable and from there you can get the token‚Äôs value using dot notation.\n2.1.2.2. Requesting the DB refresh 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  $projectId \\= \"1234567\" $sourceEnvironmentId \\= \"fad26410-03cd-4c3e-89b8-85d2bddc4933\" $targetEnvironmentId \\= \"cab68410-cd13-9e48-12a3-32d585aaa548\" $refreshUrl \\= \"https://lcsapi.lcs.dynamics.com/databasemovement/v1/databases/project/$projectId/source/$sourceEnvironmentId/target/$targetEnvironmentId\" $refreshHeader \\= @{ Authorization \\= \"Bearer $token\" \"x-ms-version\" \\= '2017-09-15' \"Content-Type\" \\= \"application/json\" } $refreshResponse \\= Invoke\\-RestMethod $refreshUrl\u0026nbsp;\\-Method 'POST' \\-Headers $refreshHeader   This will be the call to trigger the refresh. We‚Äôll need the token we‚Äôve just obtained in the first step to use it in the header and the source and target environment Ids.\nIf it‚Äôs successful the response will be a 200 OK.\n2.1.3. Add it to your pipeline Adding this to an Azure DevOps pipeline is no mistery. Select and edit your pipeline, I‚Äôm doing it on a nigthly build (it‚Äôs called continuous but it‚Äôs not‚Ä¶) that runs after the environment has been updated with code, and add a new PowerShell task:\nSelect the task and change it to ‚ÄúInline‚Äù:\nThen just paste the script we‚Äôve created in the Script field and done! You‚Äôll get a refresh after the tests!\nYou can also run this on your release pipeline BUT if you do it after the deploy step remember to mark the ‚ÄúWait for Completion‚Äù option or the operation will fail because the environment will already be servicing! And even then it could fail if the servicing goes over the timeout time. So‚Ä¶ don‚Äôt run this on your release pipeline!\nAnd that‚Äôs all. Let‚Äôs which new operations will be added to the API and what we can do with them.\n2.1.4. Use d365fo.tools in your Azure Pipeline Thanks to M√∂tz‚Äôs comment pointing me to how to add d365fo.tools to a hosted pipeline I‚Äôve created a pipeline which will install the tools and run the commands. It‚Äôs even easier to do than with the Invoke-RestMethod.\n2.1.4.1. But first‚Ä¶ Make sure that in your Azure Active Directory app registration you‚Äôve selected ‚ÄúTreat application as a public client‚Äù under Authentication:\n2.1.4.2. The task First we need to install d365fo.tools and then we can use its commands to call the LCS API:\n1 2 3 4 5 6 7 8 9  Install\\-PackageProvider nuget \\-Scope CurrentUser \\-Force \\-Confirm:$false Install\\-Module \\-Name AZ \\-AllowClobber \\-Scope CurrentUser \\-Force \\-Confirm:$False \\-SkipPublisherCheck Install\\-Module \\-Name d365fo.tools \\-AllowClobber \\-Scope CurrentUser \\-Force \\-Confirm:$false Get\\-D365LcsApiToken \\-ClientId \"{YOUR\\_APP\\_ID}\" \\-Username \"{USERNAME}\" \\-Password \"{PASSWORD}\" \\-LcsApiUri \"https://lcsapi.lcs.dynamics.com\" \\-Verbose | Set\\-D365LcsApiConfig \\-ProjectId 1234567 Invoke\\-D365LcsDatabaseRefresh \\-SourceEnvironmentId \"958ae597-f089-4811-abbd-c1190917eaae\" \\-TargetEnvironmentId \"13cc7700-c13b-4ea3-81cd-2d26fa72ec5e\" \\-SkipInitialStatusFetch   As you can see it a bit easier to do the refresh using d365fo.tools. We get the token and pipeline the output to the Set-D365LcsApiConfig command which will store the token (and others). This also helps to not having to duplicate AppIds, users, etc. and as you can see to call the refresh operation we just need the source and target environment Ids!\nAutomating Prod to Dev DB copies The new LCS DB API endpoint to create a database export has been published! With it we now have a way of automating and scheduling a database refresh from your Dynamics 365 FnO production environment to a developer or Tier 1 VM.\nUsing the LCS DB API\n2.2.1. The bacpac issue One of the main setbacks we currently have with prod DB refreshes is that it‚Äôs not a quick thing to do because you need to:\n Refresh a Tier 2+ environment with prod‚Äôs DB Export a bacpac from the Tier 2+ environment Restore the bacpac on a Tier 1 VM.  This happens because Tier 2+ environments use Azure SQL as the DB engine and Tier 1 VMs use SQL Server.\nThe time it takes to complete the process depends on the size of the database and the performance of the VM you‚Äôll restore it to. But it‚Äôs not a fast process at all. For a 60GB database you‚Äôll get a bacpac around 7GB that will take:\n 1 to 2 hours to refresh to UAT 2 to 4 hours for the bacpac to be exported At least 4 hours to restore it to a Tier 1 VM.  That‚Äôs between 7 and 11 hours until you have the DB on a developer machine. Once it‚Äôs there you can quickly get a BAK and share it. But you might need the time of a full working day to have that data available.\n2.2.2. Save us LCS DB API! Thanks to the new LCS DB API‚Äôs endpoint we can perform all these steps automatically, and with the help of d365fo.tools it‚Äôll be even easier. But first‚Ä¶\nDue to the extensive time it takes to complete all the process, we first have to decide a schedule (daily, weekly, etc.) and then this schedule must be compatible with the release cadence to UAT/Prod, because only one operation at a time can be done.\nThere‚Äôs still another problem but I‚Äôll talk about it after seeing the scripts.\n2.2.3. My proposal To do the last part of the LCS DB API flow from prod to dev, we need a Tier 1 VM where the bacpac will be restored. My idea is using the build VM on Microsoft‚Äôs subscription and an Azure DevOps pipeline to run all the scripts that will restore the DB in that VM. It‚Äôs an underused machine and it fits perfectly to this purpose.\nI want to clarify why I‚Äôve thought about doing this using the build VM. In most cases this VM will be doing nothing during the night, maybe only running some tests, and it‚Äôs during that period of time when I suggest doing all this. But be aware that depending on your DB size this won‚Äôt be possible or you‚Äôll run out of space after 2 o 3 restores.\nSo think about deploying an extra VM and install an agent there to do this, whatever you do don‚Äôt mess with the build VM if you don‚Äôt know what you‚Äôre doing! Try this on a dev VM or anywhere else if you‚Äôre afraid of breaking something. Remember you‚Äôll lose the capacity to generate DPs and run pipelines if this environments breaks!\nThis post is just an example of a possible solution, you need to decide what suits you best! End of the update.\nAs I said before I‚Äôll be using M√∂tz Jensen‚Äòs d365fo.tools, we could do everything without them but that would be a bit stupid because using the tools is easier, faster and makes everything clearer.\nI‚Äôve separated all the steps in 3 Powershell scripts: execute the refresh, export the bacpac and restore the bacpac.\n2.2.3.1. Refresh database This will refresh the prod environmnet to a Tier 2+:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  $clientId \\= \"ab12345-6220-4566-896a-19a4ad41783f\" $userName \\= \"admin@tenant\" $passWord \\= \"admin123456\" $projectId \\= \"1234567\" $sourceEnvId \\= \"958bc863-f089-4811-abbd-c1190917eaae\" $targetEnvId \\= \"13aa6872-c13b-4ea3-81cd-2d26fa72ec5e\" Get-D365LcsApiToken \\-ClientId $clientId \\-Username $userName \\-Password $passWord \\-LcsApiUri \"https://lcsapi.lcs.dynamics.com\" \\-Verbose | Set\\-D365LcsApiConfig \\-ProjectId $projectId Invoke-D365LcsDatabaseRefresh \\-SourceEnvironmentId $sourceEnvId \\-TargetEnvironmentId $targetEnvId \\-SkipInitialStatusFetch   2.2.3.2. Export database This part will trigger the bacpac export from the Tier 2+ environment which we‚Äôve just refreshed:\n1 2 3 4 5 6 7  $sourceEnvId \\= \"958bc863-f089-4811-abbd-c1190917eaae\" $targetEnvId \\= \"13aa6872-c13b-4ea3-81cd-2d26fa72ec5e\" Get-D365LcsApiConfig | Invoke-D365LcsApiRefreshToken | Set\\-D365LcsApiConfig Invoke-D365LcsDatabaseExport \\-SourceEnvironmentId $targetEnvId \\-BackupName $bacpacName   2.2.3.3. Restore bacpac And the final step will download the bacpac and restore it to a new database:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  $currentDate \\= Get-Date \\-Format yyyymmdd $bacpacName \\= \"UAT{0}\" \\-f $currentDate $downloadPath \\= \"D:\\\\UAT{0}.bacpac\" \\-f $currentDate $newDBName \\= \"AxDB\\_{0}\" \\-f $currentDate Get-D365LcsApiConfig | Invoke-D365LcsApiRefreshToken | Set\\-D365LcsApiConfig $backups \\= Get-D365LcsDatabaseBackups $fileLocation \\= $backups\\[0\\].FileLocation Invoke-D365AzCopyTransfer \\-SourceUri $fileLocation \\-DestinationUri $downloadPath Import-D365Bacpac \\-ImportModeTier1 \\-BacpacFile $downloadPath \\-NewDatabaseName $newDBName   2.2.3.4. Using it in an Azure DevOps pipeline Azure DevOps pipeline\nThis is it. Create a Powershell script, place it in the Build VM and call it in your pipeline. This is only valid for the agent hosted in the build VM. Everything can probably be run in an Azure hosted agent, but I‚Äôll not cover it here because I think that using the build VM, where we can restore the DB, is more useful to us.\n2.2.4. Timing These 3 scripts will call the LCS DB API to refresh, export and restore the DB. But there‚Äôs the timing issue.\nRefreshing the database takes some time and exporting it too. You need to find a way to control the status of the operations. The LCS DB API offers an operation you can use to get the status of the ongoing operation. Using d365fo.tools:\n1  Get-D365LcsDatabaseRefreshStatus \\-OperationActivityId 123456789 \\-EnvironmentId \"99ac6587-c13b-4ea3-81cd-2d26fa72ec5e\"   You can choose to control that inside your Powershell scripts, but if we use the agent on the build VM that means we cannot use it for anything else until everything is done.\nThat‚Äôs why I separated the process in 3 steps. You can manually schedule 3 pipelines, one for each step at the times you know each stage ends. Then you can choose the order: export, restore, refresh or refresh, export, restore.\nYou could also use Windows Task Scheduler and forget about AZDO Pipelines, but we‚Äôre not doing that because we love pipelines.\nAnd that‚Äôs all, we finally have a way of moving data without having to do it manually, we can schedule it, but we need to take some decisions on how we‚Äôll do things. And I‚Äôll leave that up to you üôÇ\nSecure your Azure Pipelines with Azure Key Vault But creating a pipeline with a password in plain sight was not very secure. How could we add extra security to a pipeline? Once again we can turn to an Azure tool to help us, the Azure Key Vault.\nAzure Key Vault A Key Vault is a service that allows us to safely store certificates or secrets and later use them in our applications and services. And like many other Azure services it has a cost but it‚Äôs really low and, for a normal use, you will be billed like a cent or none a month. Don‚Äôt be stingy with security!\nYou might already know about Azure Key Vault because we can use it in Microsoft Dynamics 365 for Finance and Operations under System Administration. For example it‚Äôs how the company certificates for the Spanish SII or Brazilian NF-e are stored and later retrieved to call the web services.\nSecuring your Azure DevOps Pipelines Thanks to the Azure Key Vault task (which is open source like many other tasks) getting a secret from a Key Vault has no secret (badum tssss).\n4.1.1. Create a Key Vault Go to your Azure subscription and look for Key Vaults in the top search bar. If you don‚Äôt have an Azure subscription you can get one free with a credit of 170‚Ç¨/200$ for 30 days and try this or other things.\nIn the Key Vault page click on ‚ÄúCreate key vault‚Äù and fill the fields\nYou can go through other tabs but I will just click ‚ÄúReview \u0026 Create‚Äù to create the vault.\n4.1.2. Add the task to DevOps Now go to Azure DevOps and create a new pipeline or edit an existing one. Add a task to the agent job and look for azure key vault:\nIt‚Äôs possible that you might need to get the task from the marketplace first, if so remember you need to have enough right on the organization and not only the AZDO project you‚Äôre in. Now go to the task and select your subscription:\nOnce selected click the ‚ÄúAuthorize‚Äù button. This will create a service principal in your subscription, we‚Äôll use it later. After authorizing you just need to select the key vault you‚Äôve created in the first step. And back to Azure.\n4.1.3. Setup and secret creation Go to your key vault, ‚ÄúAccess policies‚Äù and click ‚ÄúAdd Access Policy‚Äù:\nWhen we authorized the task to access our Azure subscription it created a service principal now we need to select it to list and get the secrets to be able to use them in our pipeline. Click on ‚ÄúSelect principal‚Äù:\nIn the search bar type your subscription‚Äôs name, the principal should start with it and end with the same ID of your subscription. Select it and click the ‚ÄúSelect‚Äù button at the bottom:\nNow click on the ‚ÄúSecret permissions‚Äù lookup and under ‚ÄúSecret Management Operations‚Äù select Get and List:\nIf you want to also use certificates or keys you should do the same. Finally click the ‚ÄúAdd‚Äù button and don‚Äôt forget to click ‚ÄúSave‚Äù!! Otherwise nothing will be saved:\nNow we can create a secret in the key vault. Go to secrets and click on ‚ÄúGenerate/Import‚Äù, complete the fields and finally click on the ‚ÄúCreate‚Äù button:\n4.1.4. Using the secrets in your pipelines We‚Äôre ready to use the secret in our pipeline. I will add a PowerShell task to call the LCS DB API using d365fo.tools but I‚Äôll change all the variables to the secrets:\n1 2 3 4 5 6  # Write your PowerShell commands here. Install\\-PackageProvider nuget \\-Scope CurrentUser \\-Force \\-Confirm:$false Install\\-Module \\-Name AZ \\-AllowClobber \\-Scope CurrentUser \\-Force \\-Confirm:$False \\-SkipPublisherCheck Install\\-Module \\-Name d365fo.tools \\-AllowClobber \\-Scope CurrentUser \\-Force \\-Confirm:$false Get\\-D365LcsApiToken \\-ClientId \"$(myAppId)\" \\-Username \"$(myUserName)\" \\-Password \"$(mySecretPassword)\" \\-LcsApiUri \"https://lcsapi.lcs.dynamics.com\" \\-Verbose | Set\\-D365LcsApiConfig \\-ProjectId $(myProjectId) Get\\-D365LcsDatabaseBackups   As you can see now even the AAD App Id is masked.\nWhat the Azure Key Vault task does is getting the secrets from Azure and storing them in variables when the pipeline runs:\nThen we can access it‚Äôs value with the $(variableName) notation in the PowerShell script. If you try to print the secrets‚Äô values using the Write-Host command all you‚Äôll get will be three asterisks, so you can see that using the Key Vault is more than safe. If we check the result of running the Get-D365LcsDatabaseBackups command we‚Äôll see how good is this:\nThe ProjectId value is not printed because it was one of our secret values!\nAnd this is how you can add extra security to your Dev ALM!\n","wordCount":"14092","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://nuxulu.com/2021-05-01-dynamics-365-for-finance-operations-and-azure-devops/"},"publisher":{"@type":"Organization","name":"Dynamics 365 Finance Operations \u0026 Power Platform","logo":{"@type":"ImageObject","url":"https://nuxulu.com/%7B%7Bsite.url%7D%7D/"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://nuxulu.com accesskey=h title="Dynamics 365 Finance Operations Archive (Alt + H)"><img src=/apple-touch-icon.png alt=logo aria-label=logo height=35>Dynamics 365 Finance Operations Archive</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://nuxulu.com/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://nuxulu.com/categories/ title=categories><span>categories</span></a></li><li><a href=https://nuxulu.com/tags/ title=tags><span>tags</span></a></li><li><a href=https://nuxulu.com/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://nuxulu.com>Home</a></div><h1 class=post-title>Dynamics 365 for Finance & Operations and Azure DevOps</h1></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><ul><li><a href=#httpsaristeinfoenmsdyn365-azure-devops-almdynamics-365-for-finance-operations-and-azure-devopsdynamics-365-for-finance--operations-and-azure-devops aria-label="Dynamics 365 for Finance &amp;amp; Operations and Azure DevOps"><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#dynamics-365-for-finance-operations-and-azure-devops></a><strong>Dynamics 365 for Finance & Operations and Azure DevOps</strong></a><ul><li><a href=#011-httpsaristeinfoenmsdyn365-azure-devops-almazure-devopsazure-devops aria-label="0.1.1. Azure DevOps">0.1.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#azure-devops></a>Azure DevOps</a></li><li><a href=#012-httpsaristeinfoenmsdyn365-azure-devops-almfirst-stepsfirst-steps aria-label="0.1.2. First steps">0.1.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#first-steps></a>First steps</a><ul><li><a href=#0121-httpsaristeinfoenmsdyn365-azure-devops-almcreate-an-azure-devops-organizationcreate-an-azure-devops-organization aria-label="0.1.2.1. Create an Azure DevOps organization">0.1.2.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#create-an-azure-devops-organization></a>Create an Azure DevOps organization</a></li></ul></li><li><a href=#013-httpsaristeinfoenmsdyn365-azure-devops-almthe-build-serverthe-build-server aria-label="0.1.3. The build server">0.1.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#the-build-server></a>The build server</a><ul><li><a href=#0131-httpsaristeinfoenmsdyn365-azure-devops-almthe-build-vmthe-build-vm aria-label="0.1.3.1. The build VM">0.1.3.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#the-build-vm></a>The build VM</a></li></ul></li><li><a href=#014-httpsaristeinfoenmsdyn365-azure-devops-almvisual-studiovisual-studio aria-label="0.1.4. Visual Studio">0.1.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#visual-studio></a>Visual Studio</a></li><li><a href=#015-httpsaristeinfoenmsdyn365-azure-devops-almsome-advicesome-advice aria-label="0.1.5. Some advice">0.1.5. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#some-advice></a>Some advice</a></li><li><a href=#016-httpsaristeinfoenmsdyn365-azure-devops-almbranching-strategiesbranching-strategies aria-label="0.1.6. Branching strategies">0.1.6. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#branching-strategies></a>Branching strategies</a><ul><li><a href=#0161-httpsaristeinfoenmsdyn365-azure-devops-almmain-releasemain-release aria-label="0.1.6.1. Main-Release">0.1.6.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#main-release></a>Main-Release</a></li><li><a href=#0162-httpsaristeinfoenmsdyn365-azure-devops-almdev-main-releasedev--main--release aria-label="0.1.6.2. Dev ‚Äì Main ‚Äì Release">0.1.6.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#dev-main-release></a>Dev ‚Äì Main ‚Äì Release</a></li></ul></li></ul></li><li><a href=#httpsaristeinfoenmsdyn365-azure-devops-almazure-pipelinesazure-pipelines aria-label="Azure Pipelines"><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#azure-pipelines></a>Azure Pipelines</a><ul><li><a href=#021-httpsaristeinfoenmsdyn365-azure-devops-almbuildsbuilds aria-label="0.2.1. Builds">0.2.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#builds></a>Builds</a></li><li><a href=#022-httpsaristeinfoenmsdyn365-azure-devops-almcontinuous-integrationcontinuous-integration aria-label="0.2.2. Continuous Integration">0.2.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#continuous-integration></a>Continuous Integration</a></li><li><a href=#023-httpsaristeinfoenmsdyn365-azure-devops-almgated-check-insgated-check-ins aria-label="0.2.3. Gated check-ins">0.2.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#gated-check-ins></a>Gated check-ins</a></li><li><a href=#024-httpsaristeinfoenmsdyn365-azure-devops-almset-up-the-new-azure-devops-tasks-for-packaging-and-model-versioningset-up-the-new-azure-devops-tasks-for-packaging-and-model-versioning aria-label="0.2.4. Set up the new Azure DevOps tasks for Packaging and Model Versioning">0.2.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#set-up-the-new-azure-devops-tasks-for-packaging-and-model-versioning></a>Set up the new Azure DevOps tasks for Packaging and Model Versioning</a><ul><li><a href=#0241-httpsaristeinfoenmsdyn365-azure-devops-almupdate-model-version-taskupdate-model-version-task aria-label="0.2.4.1. Update Model Version task">0.2.4.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#update-model-version-task></a>Update Model Version task</a></li><li><a href=#0242-httpsaristeinfoenmsdyn365-azure-devops-almcreate-deployable-package-taskcreate-deployable-package-task aria-label="0.2.4.2. Create Deployable Package task">0.2.4.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#create-deployable-package-task></a>Create Deployable Package task</a><ul><li><a href=#02421-httpsaristeinfoenmsdyn365-azure-devops-almx-tools-pathx-tools-path aria-label="0.2.4.2.1. X++ Tools Path">0.2.4.2.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#x-tools-path></a>X++ Tools Path</a></li><li><a href=#02422-httpsaristeinfoenmsdyn365-azure-devops-almlocation-of-the-x-binaries-to-packagelocation-of-the-x-binaries-to-package aria-label="0.2.4.2.2. Location of the X++ binaries to package">0.2.4.2.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#location-of-the-x-binaries-to-package></a>Location of the X++ binaries to package</a></li><li><a href=#02423-httpsaristeinfoenmsdyn365-azure-devops-almfilename-and-path-for-the-deployable-packagefilename-and-path-for-the-deployable-package aria-label="0.2.4.2.3. Filename and path for the deployable package">0.2.4.2.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#filename-and-path-for-the-deployable-package></a>Filename and path for the deployable package</a></li></ul></li><li><a href=#0243-httpsaristeinfoenmsdyn365-azure-devops-almadd-licenses-to-deployable-package-taskadd-licenses-to-deployable-package-task aria-label="0.2.4.3. Add Licenses to Deployable Package task">0.2.4.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#add-licenses-to-deployable-package-task></a>Add Licenses to Deployable Package task</a></li></ul></li></ul></li><li><a href=#httpsaristeinfoenmsdyn365-azure-devops-almazure-hosted-build-for-dynamics-365-finance-scmazure-hosted-build-for-dynamics-365-finance--scm aria-label="Azure hosted build for Dynamics 365 Finance &amp;amp; SCM"><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#azure-hosted-build-for-dynamics-365-finance-scm></a>Azure hosted build for Dynamics 365 Finance & SCM</a><ul><li><a href=#031-httpsaristeinfoenmsdyn365-azure-devops-almazure-agentsazure-agents aria-label="0.3.1. Azure agents">0.3.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#azure-agents></a>Azure agents</a></li><li><a href=#032-httpsaristeinfoenmsdyn365-azure-devops-almhow-does-it-workhow-does-it-work aria-label="0.3.2. How does it work?">0.3.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#how-does-it-work></a>How does it work?</a></li><li><a href=#033-httpsaristeinfoenmsdyn365-azure-devops-almwhat-do-i-needwhat-do-i-need aria-label="0.3.3. What do I need?">0.3.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#what-do-i-need></a>What do I need?</a></li><li><a href=#034-httpsaristeinfoenmsdyn365-azure-devops-almazure-devops-artifactazure-devops-artifact aria-label="0.3.4. Azure DevOps artifact">0.3.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#azure-devops-artifact></a>Azure DevOps artifact</a></li><li><a href=#035-httpsaristeinfoenmsdyn365-azure-devops-almprepare-azure-devopsprepare-azure-devops aria-label="0.3.5. Prepare Azure DevOps">0.3.5. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#prepare-azure-devops></a>Prepare Azure DevOps</a></li><li><a href=#036-httpsaristeinfoenmsdyn365-azure-devops-almconfigure-pipelineconfigure-pipeline aria-label="0.3.6. Configure pipeline">0.3.6. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#configure-pipeline></a>Configure pipeline</a><ul><li><a href=#0361-httpsaristeinfoenmsdyn365-azure-devops-almpipeline-rootpipeline-root aria-label="0.3.6.1. Pipeline root">0.3.6.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#pipeline-root></a>Pipeline root</a></li><li><a href=#0362-httpsaristeinfoenmsdyn365-azure-devops-almget-sourcesget-sources aria-label="0.3.6.2. Get sources">0.3.6.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#get-sources></a>Get sources</a></li><li><a href=#0363-httpsaristeinfoenmsdyn365-azure-devops-almnuget-install-packagesnuget-install-packages aria-label="0.3.6.3. NuGet install Packages">0.3.6.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#nuget-install-packages></a>NuGet install Packages</a></li><li><a href=#0364-httpsaristeinfoenmsdyn365-azure-devops-almupdate-model-versionupdate-model-version aria-label="0.3.6.4. Update Model Version">0.3.6.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#update-model-version></a>Update Model Version</a></li><li><a href=#0365-httpsaristeinfoenmsdyn365-azure-devops-almbuild-solutionbuild-solution aria-label="0.3.6.5. Build solution">0.3.6.5. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#build-solution></a>Build solution</a></li><li><a href=#0366-httpsaristeinfoenmsdyn365-azure-devops-almcreate-deployable-packagecreate-deployable-package aria-label="0.3.6.6. Create Deployable Package">0.3.6.6. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#create-deployable-package></a>Create Deployable Package</a></li><li><a href=#0367-httpsaristeinfoenmsdyn365-azure-devops-almadd-licenses-to-deployable-packageadd-licenses-to-deployable-package aria-label="0.3.6.7. Add Licenses to Deployable Package">0.3.6.7. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#add-licenses-to-deployable-package></a>Add Licenses to Deployable Package</a></li></ul></li><li><a href=#037-httpsaristeinfoenmsdyn365-azure-devops-almupdate-for-version-10-0-18update-for-version-10018 aria-label="0.3.7. Update for version 10.0.18">0.3.7. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#update-for-version-10-0-18></a>Update for version 10.0.18</a><ul><li><a href=#0371-httpsaristeinfoenmsdyn365-azure-devops-almpackages-configpackagesconfig aria-label="0.3.7.1. packages.config">0.3.7.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#packages-config></a>packages.config</a></li><li><a href=#0372-httpsaristeinfoenmsdyn365-azure-devops-almpipelinepipeline aria-label="0.3.7.2. Pipeline">0.3.7.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#pipeline></a>Pipeline</a></li></ul></li></ul></li><li><a href=#httpsaristeinfoenmsdyn365-azure-devops-almazure-devtest-labs-powered-buildsazure-devtest-labs-powered-builds aria-label="Azure DevTest Labs powered builds"><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#azure-devtest-labs-powered-builds></a>Azure DevTest Labs powered builds</a><ul><li><a href=#041-httpsaristeinfoenmsdyn365-azure-devops-almbut-firstbut-first aria-label="0.4.1. But first‚Ä¶">0.4.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#but-first></a>But first‚Ä¶</a></li><li><a href=#042-httpsaristeinfoenmsdyn365-azure-devops-almazure-devtest-labsazure-devtest-labs aria-label="0.4.2. Azure DevTest Labs">0.4.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#azure-devtest-labs></a>Azure DevTest Labs</a></li><li><a href=#043-httpsaristeinfoenmsdyn365-azure-devops-almgetting-and-preparing-the-vhdgetting-and-preparing-the-vhd aria-label="0.4.3. Getting and preparing the VHD">0.4.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#getting-and-preparing-the-vhd></a>Getting and preparing the VHD</a></li><li><a href=#044-httpsaristeinfoenmsdyn365-azure-devops-almcreate-a-devtest-labs-accountcreate-a-devtest-labs-account aria-label="0.4.4. Create a DevTest Labs account">0.4.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#create-a-devtest-labs-account></a>Create a DevTest Labs account</a></li><li><a href=#045-httpsaristeinfoenmsdyn365-azure-devops-almcreating-the-vmcreating-the-vm aria-label="0.4.5. Creating the VM">0.4.5. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#creating-the-vm></a>Creating the VM</a><ul><li><a href=#0451-httpsaristeinfoenmsdyn365-azure-devops-almconfigure-azure-devops-agent-serviceconfigure-azure-devops-agent-service aria-label="0.4.5.1. Configure Azure DevOps Agent Service">0.4.5.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#configure-azure-devops-agent-service></a>Configure Azure DevOps Agent Service</a><ul><li><a href=#04511-httpsaristeinfoenmsdyn365-azure-devops-almoption-a-use-an-artifactoption-a-use-an-artifact aria-label="0.4.5.1.1. Option A: use an artifact">0.4.5.1.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#option-a-use-an-artifact></a>Option A: use an artifact</a></li><li><a href=#04512-httpsaristeinfoenmsdyn365-azure-devops-almoption-b-configure-azure-devops-agent-in-the-vmoption-b-configure-azure-devops-agent-in-the-vm aria-label="0.4.5.1.2. Option B: Configure Azure DevOps Agent in the VM">0.4.5.1.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#option-b-configure-azure-devops-agent-in-the-vm></a>Option B: Configure Azure DevOps Agent in the VM</a></li></ul></li><li><a href=#0452-httpsaristeinfoenmsdyn365-azure-devops-almarm-templatearm-template aria-label="0.4.5.2. ARM template">0.4.5.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#arm-template></a>ARM template</a></li></ul></li><li><a href=#046-httpsaristeinfoenmsdyn365-azure-devops-almpreparing-the-vmpreparing-the-vm aria-label="0.4.6. Preparing the VM">0.4.6. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#preparing-the-vm></a>Preparing the VM</a><ul><li><a href=#0461-httpsaristeinfoenmsdyn365-azure-devops-almdisable-servicesdisable-services aria-label="0.4.6.1. Disable services">0.4.6.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#disable-services></a>Disable services</a></li><li><a href=#0462-httpsaristeinfoenmsdyn365-azure-devops-almcreate-a-new-sql-usercreate-a-new-sql-user aria-label="0.4.6.2. Create a new SQL user">0.4.6.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#create-a-new-sql-user></a>Create a new SQL user</a></li><li><a href=#0463-httpsaristeinfoenmsdyn365-azure-devops-almprepare-ssrs-optionalprepare-ssrs-optional aria-label="0.4.6.3. Prepare SSRS (optional)">0.4.6.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#prepare-ssrs-optional></a>Prepare SSRS (optional)</a></li><li><a href=#0464-httpsaristeinfoenmsdyn365-azure-devops-almpowershell-scriptspowershell-scripts aria-label="0.4.6.4. PowerShell Scripts">0.4.6.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#powershell-scripts></a>PowerShell Scripts</a><ul><li><a href=#04641-httpsaristeinfoenmsdyn365-azure-devops-almprepareforbuildprepareforbuild aria-label="0.4.6.4.1. PrepareForBuild">0.4.6.4.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#prepareforbuild></a>PrepareForBuild</a></li></ul></li><li><a href=#0465-httpsaristeinfoenmsdyn365-azure-devops-almoptional-but-recommended-install-d365fo-toolsoptional-but-recommended-install-d365fotoolshttpsgithubcomd365collaboratived365fotools aria-label="0.4.6.5. Optional (but recommended): install d365fo.tools">0.4.6.5. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#optional-but-recommended-install-d365fo-tools></a><strong>Optional (but recommended)</strong>: install <a href=https://github.com/d365collaborative/d365fo.tools>d365fo.tools</a></a></li></ul></li><li><a href=#047-httpsaristeinfoenmsdyn365-azure-devops-almcreate-a-new-imagecreate-a-new-image aria-label="0.4.7. Create a new image">0.4.7. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#create-a-new-image></a>Create a new image</a></li><li><a href=#048-httpsaristeinfoenmsdyn365-azure-devops-almazure-devops-pipelinesazure-devops-pipelines aria-label="0.4.8. Azure DevOps Pipelines">0.4.8. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#azure-devops-pipelines></a>Azure DevOps Pipelines</a><ul><li><a href=#0481-httpsaristeinfoenmsdyn365-azure-devops-almcreate-azure-devtest-labs-vmcreate-azure-devtest-labs-vm aria-label="0.4.8.1. Create Azure DevTest Labs VM">0.4.8.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#create-azure-devtest-labs-vm></a>Create Azure DevTest Labs VM</a></li><li><a href=#0482-httpsaristeinfoenmsdyn365-azure-devops-almbuildbuild aria-label="0.4.8.2. Build">0.4.8.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#build></a>Build</a><ul><li><a href=#04821-httpsaristeinfoenmsdyn365-azure-devops-almoptional-use-selectivesync-not-recommended-see-next-optionoptional-use-selectivesync-not-recommended-see-next-option aria-label="0.4.8.2.1. Optional: use SelectiveSync (not recommended, see next option)">0.4.8.2.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#optional-use-selectivesync-not-recommended-see-next-option></a>Optional: use SelectiveSync (not recommended, see next option)</a></li><li><a href=#04822-httpsaristeinfoenmsdyn365-azure-devops-almoptional-use-d365fo-tools-to-sync-your-packages-modelsoptional-use-d365fotools-to-sync-your-packagesmodels aria-label="0.4.8.2.2. Optional: use d365fo.tools to sync your packages/models">0.4.8.2.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#optional-use-d365fo-tools-to-sync-your-packages-models></a>Optional: use d365fo.tools to sync your packages/models</a></li><li><a href=#04823-httpsaristeinfoenmsdyn365-azure-devops-almoptional-use-d365fo-tools-to-deploy-ssrs-reportsoptional-use-d365fotools-to-deploy-ssrs-reports aria-label="0.4.8.2.3. Optional: use d365fo.tools to deploy SSRS reports">0.4.8.2.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#optional-use-d365fo-tools-to-deploy-ssrs-reports></a>Optional: use d365fo.tools to deploy SSRS reports</a></li></ul></li><li><a href=#0483-httpsaristeinfoenmsdyn365-azure-devops-almdelete-azure-devtest-labs-vmdelete-azure-devtest-labs-vm aria-label="0.4.8.3. Delete Azure DevTest Labs VM">0.4.8.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#delete-azure-devtest-labs-vm></a>Delete Azure DevTest Labs VM</a></li><li><a href=#0484-httpsaristeinfoenmsdyn365-azure-devops-almdependencies-and-conditionsdependencies-and-conditions aria-label="0.4.8.4. Dependencies and conditions">0.4.8.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#dependencies-and-conditions></a>Dependencies and conditions</a><ul><li><a href=#04841-httpsaristeinfoenmsdyn365-azure-devops-almbuildbuild aria-label="0.4.8.4.1. Build">0.4.8.4.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#build></a>Build</a></li><li><a href=#04842-httpsaristeinfoenmsdyn365-azure-devops-almdelete-vmdelete-vm aria-label="0.4.8.4.2. Delete VM">0.4.8.4.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#delete-vm></a>Delete VM</a></li></ul></li></ul></li><li><a href=#049-httpsaristeinfoenmsdyn365-azure-devops-almrun-the-buildrun-the-build aria-label="0.4.9. Run the build">0.4.9. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#run-the-build></a>Run the build</a></li><li><a href=#0410-httpsaristeinfoenmsdyn365-azure-devops-almtimestimes aria-label="0.4.10. Times">0.4.10. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#times></a>Times</a><ul><li><a href=#04101-httpsaristeinfoenmsdyn365-azure-devops-almcomparison-1comparison-1 aria-label="0.4.10.1. Comparison 1">0.4.10.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#comparison-1></a>Comparison 1</a></li><li><a href=#04102-httpsaristeinfoenmsdyn365-azure-devops-almcomparison-2comparison-2 aria-label="0.4.10.2. Comparison 2">0.4.10.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#comparison-2></a>Comparison 2</a></li><li><a href=#04103-httpsaristeinfoenmsdyn365-azure-devops-almcomparison-3comparison-3 aria-label="0.4.10.3. Comparison 3">0.4.10.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#comparison-3></a>Comparison 3</a></li></ul></li><li><a href=#0411-httpsaristeinfoenmsdyn365-azure-devops-almshow-me-the-moneyshow-me-the-money aria-label="0.4.11. Show me the money!">0.4.11. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#show-me-the-money></a>Show me the money!</a></li><li><a href=#0412-httpsaristeinfoenmsdyn365-azure-devops-almsome-final-remarkssome-final-remarks aria-label="0.4.12. Some final remarks">0.4.12. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#some-final-remarks></a>Some final remarks</a></li></ul></li><li><a href=#httpsaristeinfoenmsdyn365-azure-devops-almadd-and-build-net-projectsadd-and-build-net-projects aria-label="Add and build .NET projects"><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#add-and-build-net-projects></a>Add and build .NET projects</a><ul><li><a href=#051-httpsaristeinfoenmsdyn365-azure-devops-almbuild-net-in-your-pipelinebuild-net-in-your-pipeline aria-label="0.5.1. Build .NET in your pipeline">0.5.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#build-net-in-your-pipeline></a>Build .NET in your pipeline</a></li><li><a href=#052-httpsaristeinfoenmsdyn365-azure-devops-almadd-a-c-project-to-fnoadd-a-c-project-to-fno aria-label="0.5.2. Add a C# project to FnO">0.5.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#add-a-c-project-to-fno></a>Add a C# project to FnO</a></li><li><a href=#053-httpsaristeinfoenmsdyn365-azure-devops-almbuild-pipelinebuild-pipeline aria-label="0.5.3. Build pipeline">0.5.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#build-pipeline></a>Build pipeline</a></li><li><a href=#054-httpsaristeinfoenmsdyn365-azure-devops-almthings-i-dont-like-understand-need-to-investigatethings-i-dont-likeunderstandneed-to-investigate aria-label="0.5.4. Things I don‚Äôt like/understand/need to investigate">0.5.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#things-i-dont-like-understand-need-to-investigate></a>Things I don‚Äôt like/understand/need to investigate</a></li></ul></li><li><a href=#httpsaristeinfoenmsdyn365-azure-devops-almsetup-release-pipelinessetup-release-pipelines aria-label="Setup Release Pipelines"><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#setup-release-pipelines></a>Setup Release Pipelines</a><ul><li><a href=#061-httpsaristeinfoenmsdyn365-azure-devops-almsetting-up-release-pipeline-in-azure-devops-for-dynamics-365-for-finance-and-operationssetting-up-release-pipeline-in-azure-devops-for-dynamics-365-for-finance-and-operations aria-label="0.6.1. Setting up Release Pipeline in Azure DevOps for Dynamics 365 for Finance and Operations">0.6.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#setting-up-release-pipeline-in-azure-devops-for-dynamics-365-for-finance-and-operations></a>Setting up Release Pipeline in Azure DevOps for Dynamics 365 for Finance and Operations</a></li><li><a href=#062-httpsaristeinfoenmsdyn365-azure-devops-almaad-app-creationaad-app-creation aria-label="0.6.2. AAD app creation">0.6.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#aad-app-creation></a>AAD app creation</a></li><li><a href=#063-httpsaristeinfoenmsdyn365-azure-devops-almcreate-the-release-pipeline-in-devopscreate-the-release-pipeline-in-devops aria-label="0.6.3. Create the release pipeline in DevOps">0.6.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#create-the-release-pipeline-in-devops></a>Create the release pipeline in DevOps</a><ul><li><a href=#0631-httpsaristeinfoenmsdyn365-azure-devops-almupload-to-lcsupload-to-lcs aria-label="0.6.3.1. Upload to LCS">0.6.3.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#upload-to-lcs></a>Upload to LCS</a></li><li><a href=#0632-httpsaristeinfoenmsdyn365-azure-devops-almapply-deployable-packageapply-deployable-package aria-label="0.6.3.2. Apply deployable package">0.6.3.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#apply-deployable-package></a>Apply deployable package</a></li></ul></li><li><a href=#064-httpsaristeinfoenmsdyn365-azure-devops-almcreating-the-lcs-connectioncreating-the-lcs-connection aria-label="0.6.4. Creating the LCS connection">0.6.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#creating-the-lcs-connection></a>Creating the LCS connection</a></li></ul></li></ul><li><a href=#httpsaristeinfoenmsdyn365-azure-devops-almmore-automationmore-automation aria-label="More automation!"><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#more-automation></a>More automation!</a><ul><li><a href=#httpsaristeinfoenmsdyn365-azure-devops-almbuildsbuilds aria-label=Builds><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#builds></a>Builds</a></li><li><a href=#httpsaristeinfoenmsdyn365-azure-devops-almreleasesreleases aria-label=Releases><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#releases></a>Releases</a></li><li><a href=#httpsaristeinfoenmsdyn365-azure-devops-almbut-i-like-to-add-some-human-touch-to-itbut-i-like-to-add-some-human-touch-to-it aria-label="But I like to add some human touch to it"><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#but-i-like-to-add-some-human-touch-to-it></a>But I like to add some human touch to it</a></li><li><a href=#httpsaristeinfoenmsdyn365-azure-devops-almextra-bonusextra-bonus aria-label="Extra bonus!"><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#extra-bonus></a>Extra bonus!</a></li><li><a href=#httpsaristeinfoenmsdyn365-azure-devops-almupdate-a-variable-in-a-releaseupdate-a-variable-in-a-release aria-label="Update a variable in a release"><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#update-a-variable-in-a-release></a>Update a variable in a release</a></li></ul></li><li><a href=#httpsaristeinfoenmsdyn365-azure-devops-almlcs-db-apilcs-db-api aria-label="LCS DB API"><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#lcs-db-api></a>LCS DB API</a><ul><li><a href=#httpsaristeinfoenmsdyn365-azure-devops-almcall-the-lcs-database-movement-api-from-your-azure-devops-pipelinescall-the-lcs-database-movement-api-from-your-azure-devops-pipelines aria-label="Call the LCS Database Movement API from your Azure DevOps Pipelines"><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#call-the-lcs-database-movement-api-from-your-azure-devops-pipelines></a>Call the LCS Database Movement API from your Azure DevOps Pipelines</a><ul><li><a href=#211-httpsaristeinfoenmsdyn365-azure-devops-almwhat-forwhat-for aria-label="2.1.1. What for?">2.1.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#what-for></a>What for?</a></li><li><a href=#212-httpsaristeinfoenmsdyn365-azure-devops-almcalling-the-apicalling-the-api aria-label="2.1.2. Calling the API">2.1.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#calling-the-api></a>Calling the API</a><ul><li><a href=#2121-httpsaristeinfoenmsdyn365-azure-devops-almgetting-the-tokengetting-the-token aria-label="2.1.2.1. Getting the token">2.1.2.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#getting-the-token></a>Getting the token</a></li><li><a href=#2122-httpsaristeinfoenmsdyn365-azure-devops-almrequesting-the-db-refreshrequesting-the-db-refresh aria-label="2.1.2.2. Requesting the DB refresh">2.1.2.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#requesting-the-db-refresh></a>Requesting the DB refresh</a></li></ul></li><li><a href=#213-httpsaristeinfoenmsdyn365-azure-devops-almadd-it-to-your-pipelineadd-it-to-your-pipeline aria-label="2.1.3. Add it to your pipeline">2.1.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#add-it-to-your-pipeline></a>Add it to your pipeline</a></li><li><a href=#214-httpsaristeinfoenmsdyn365-azure-devops-almuse-d365fo-tools-in-your-azure-pipelineuse-d365fotools-in-your-azure-pipeline aria-label="2.1.4. Use d365fo.tools in your Azure Pipeline">2.1.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#use-d365fo-tools-in-your-azure-pipeline></a>Use d365fo.tools in your Azure Pipeline</a><ul><li><a href=#2141-httpsaristeinfoenmsdyn365-azure-devops-almbut-firstbut-first aria-label="2.1.4.1. But first‚Ä¶">2.1.4.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#but-first></a>But first‚Ä¶</a></li><li><a href=#2142-httpsaristeinfoenmsdyn365-azure-devops-almthe-taskthe-task aria-label="2.1.4.2. The task">2.1.4.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#the-task></a>The task</a></li></ul></li></ul></li><li><a href=#httpsaristeinfoenmsdyn365-azure-devops-almautomating-prod-to-dev-db-copiesautomating-prod-to-dev-db-copies aria-label="Automating Prod to Dev DB copies"><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#automating-prod-to-dev-db-copies></a>Automating Prod to Dev DB copies</a><ul><li><a href=#221-httpsaristeinfoenmsdyn365-azure-devops-almthe-bacpac-issuethe-bacpac-issue aria-label="2.2.1. The bacpac issue">2.2.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#the-bacpac-issue></a>The bacpac issue</a></li><li><a href=#222-httpsaristeinfoenmsdyn365-azure-devops-almsave-us-lcs-db-apisave-us-lcs-db-api aria-label="2.2.2. Save us LCS DB API!">2.2.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#save-us-lcs-db-api></a>Save us LCS DB API!</a></li><li><a href=#223-httpsaristeinfoenmsdyn365-azure-devops-almmy-proposalmy-proposal aria-label="2.2.3. My proposal">2.2.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#my-proposal></a>My proposal</a><ul><li><a href=#2231-httpsaristeinfoenmsdyn365-azure-devops-almrefresh-databaserefresh-database aria-label="2.2.3.1. Refresh database">2.2.3.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#refresh-database></a>Refresh database</a></li><li><a href=#2232-httpsaristeinfoenmsdyn365-azure-devops-almexport-databaseexport-database aria-label="2.2.3.2. Export database">2.2.3.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#export-database></a>Export database</a></li><li><a href=#2233-httpsaristeinfoenmsdyn365-azure-devops-almrestore-bacpacrestore-bacpac aria-label="2.2.3.3. Restore bacpac">2.2.3.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#restore-bacpac></a>Restore bacpac</a></li><li><a href=#2234-httpsaristeinfoenmsdyn365-azure-devops-almusing-it-in-an-azure-devops-pipelineusing-it-in-an-azure-devops-pipeline aria-label="2.2.3.4. Using it in an Azure DevOps pipeline">2.2.3.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#using-it-in-an-azure-devops-pipeline></a>Using it in an Azure DevOps pipeline</a></li></ul></li><li><a href=#224-httpsaristeinfoenmsdyn365-azure-devops-almtimingtiming aria-label="2.2.4. Timing">2.2.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#timing></a>Timing</a></li></ul></li></ul></li><li><a href=#httpsaristeinfoenmsdyn365-azure-devops-almsecure-your-azure-pipelines-with-azure-key-vaultsecure-your-azure-pipelines-with-azure-key-vault aria-label="Secure your Azure Pipelines with Azure Key Vault"><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#secure-your-azure-pipelines-with-azure-key-vault></a>Secure your Azure Pipelines with Azure Key Vault</a></li><li><a href=#httpsaristeinfoenmsdyn365-azure-devops-almazure-key-vaultazure-key-vault aria-label="Azure Key Vault"><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#azure-key-vault></a>Azure Key Vault</a><ul><li><a href=#httpsaristeinfoenmsdyn365-azure-devops-almsecuring-your-azure-devops-pipelinessecuring-your-azure-devops-pipelines aria-label="Securing your Azure DevOps Pipelines"><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#securing-your-azure-devops-pipelines></a>Securing your Azure DevOps Pipelines</a><ul><li><a href=#411-httpsaristeinfoenmsdyn365-azure-devops-almcreate-a-key-vaultcreate-a-key-vault aria-label="4.1.1. Create a Key Vault">4.1.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#create-a-key-vault></a>Create a Key Vault</a></li><li><a href=#412-httpsaristeinfoenmsdyn365-azure-devops-almadd-the-task-to-devopsadd-the-task-to-devops aria-label="4.1.2. Add the task to DevOps">4.1.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#add-the-task-to-devops></a>Add the task to DevOps</a></li><li><a href=#413-httpsaristeinfoenmsdyn365-azure-devops-almsetup-and-secret-creationsetup-and-secret-creation aria-label="4.1.3. Setup and secret creation">4.1.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#setup-and-secret-creation></a>Setup and secret creation</a></li><li><a href=#414-httpsaristeinfoenmsdyn365-azure-devops-almusing-the-secrets-in-your-pipelinesusing-the-secrets-in-your-pipelines aria-label="4.1.4. Using the secrets in your pipelines">4.1.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#using-the-secrets-in-your-pipelines></a>Using the secrets in your pipelines</a></li></ul></li></ul></li></ul></div></details></div><div class=post-content><h2 id=httpsaristeinfoenmsdyn365-azure-devops-almdynamics-365-for-finance-operations-and-azure-devopsdynamics-365-for-finance--operations-and-azure-devops><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#dynamics-365-for-finance-operations-and-azure-devops></a><strong>Dynamics 365 for Finance & Operations and Azure DevOps</strong><a hidden class=anchor aria-hidden=true href=#httpsaristeinfoenmsdyn365-azure-devops-almdynamics-365-for-finance-operations-and-azure-devopsdynamics-365-for-finance--operations-and-azure-devops>#</a></h2><h3 id=011-httpsaristeinfoenmsdyn365-azure-devops-almazure-devopsazure-devops>0.1.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#azure-devops></a>Azure DevOps<a hidden class=anchor aria-hidden=true href=#011-httpsaristeinfoenmsdyn365-azure-devops-almazure-devopsazure-devops>#</a></h3><p><a href=https://dev.azure.com/>Azure DevOps</a> will be the service we will use for source control. Microsoft Dynamics 365 for Finance and Operations supports TFVC out of the box as its version-control system.</p><p>But Azure DevOps does not only offer a source control tool. Of course, developers will be the most benefited of using it, but from project management to the functional team and customers, everybody can be involved in using Azure DevOps. <a href="https://docs.microsoft.com/en-us/dynamics365/unified-operations/dev-itpro/lifecycle-services/bpm-overview?WT.mc_id=BA-MVP-5003976">BPM</a> synchronization and task creation, team planning, source control, automated builds and <a href=https://ariste.info/en/2019/02/setting-up-release-pipeline-in-azure-devops-for-dynamics-365-for-finance-and-operations/>releases</a>, are some of the tools it offers. All these changes will need some learning from the team, but in the short-term all of this will help to better manage implementations.</p><p>As I said it looks like the technical team is the most affected by the addition of source control to Visual Studio, but it‚Äôs the most benefited too‚Ä¶</p><h3 id=012-httpsaristeinfoenmsdyn365-azure-devops-almfirst-stepsfirst-steps>0.1.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#first-steps></a>First steps<a hidden class=anchor aria-hidden=true href=#012-httpsaristeinfoenmsdyn365-azure-devops-almfirst-stepsfirst-steps>#</a></h3><p>To use all the features described in this guide we need to create an Azure DevOps project and connect it to LCS. This will be the first step and it‚Äôs mandatory so let‚Äôs see how we have to do everything.</p><h4 id=0121-httpsaristeinfoenmsdyn365-azure-devops-almcreate-an-azure-devops-organizationcreate-an-azure-devops-organization>0.1.2.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#create-an-azure-devops-organization></a>Create an Azure DevOps organization<a hidden class=anchor aria-hidden=true href=#0121-httpsaristeinfoenmsdyn365-azure-devops-almcreate-an-azure-devops-organizationcreate-an-azure-devops-organization>#</a></h4><p>You might or might not have to do this. If you or your customer already have an account, you can use it and just create a new project in it. Otherwise head to <a href=https://dev.azure.com/>https://dev.azure.com</a> and create a new organization:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/05/AzureDevOpsSign.png.webp alt="Azure DevOps sign up" title="MSDyn365 & Azure DevOps ALM 2"></p><p>Azure DevOps sign up</p><p>After creating it you need to create a new project with the following options:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/05/ProjType.png.webp alt="Create Azure DevOps project" title="MSDyn365 & Azure DevOps ALM 3"></p><p>Create Azure DevOps project</p><p>Press the ‚ÄúCreate project‚Äù button and you‚Äôre done. Now let‚Äôs connect this Azure DevOps project to our LCS project.</p><p>When a customer signs up for Finance and Operations the LCS project is of type ‚ÄúImplementation project‚Äù is created automatically. Your customers need to invite you to their project. If you‚Äôre an ISV you can use the ‚ÄúMigrate, create solutions, and learn‚Äù projects.</p><p>In any of both cases you need to go to ‚ÄúProject settings‚Äù and select the ‚ÄúVisual Studio Team Services‚Äù Tab. Scroll down and you should see two fields. Fill the field with your DevOps URL without the project part. If you got a <a href=https://dev.azure.com/YOUR>https://dev.azure.com/YOUR</a>_ORG URL type you need to change it to https://YOUR_ORG.visualstudio.com:</p><p><img loading=lazy src="https://i0.wp.com/ariste.info/wp-content/uploads/2020/05/LCS1.png?fit=1024%2C462&ssl=1" alt="Azure DevOps setup on LCS" title="MSDyn365 & Azure DevOps ALM 4"></p><p>Azure DevOps setup on LCS</p><p>And to get the ‚ÄúPersonal access token‚Äù we go back to our Azure DevOps project, click on the user settings icon, and then select ‚ÄúPersonal access tokens‚Äù:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/05/Azure-DevOps-personal-token.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 1" title="MSDyn365 & Azure DevOps ALM 5"></p><p>We add a new token, set its expiration and give it full access. Finally press the ‚ÄúCreate‚Äù button and a new dialog will appear with your token, copy it, and paste it in LCS.</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/05/Azure-DevOps-personal-token-2.png.webp alt="Azure DevOps personal token" title="MSDyn365 & Azure DevOps ALM 6"></p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/05/Azure-DevOps-personal-token-3.png.webp alt="Azure DevOps personal token" title="MSDyn365 & Azure DevOps ALM 7"></p><p>Back to LCS, once you‚Äôve pasted the token press the ‚ÄúContinue‚Äù button. On the next step just select your project, press ‚ÄúContinue‚Äù and finally ‚ÄúSave‚Äù on the last step.</p><p>If you have any problem you can take a look at the docs where everything is really well <a href="https://docs.microsoft.com/en-us/dynamics365/unified-operations/dev-itpro/lifecycle-services/support-experience?WT.mc_id=BA-MVP-5003976#configure-lcs">documented</a>.</p><h3 id=013-httpsaristeinfoenmsdyn365-azure-devops-almthe-build-serverthe-build-server>0.1.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#the-build-server></a>The build server<a hidden class=anchor aria-hidden=true href=#013-httpsaristeinfoenmsdyn365-azure-devops-almthe-build-serverthe-build-server>#</a></h3><p>Once we‚Äôve linked LCS and Azure DevOps we‚Äôll have to deploy the <a href=https://ariste.info/en/2019/02/unresponsive-builds-in-azure-devops/>build server</a>. This will be the heart of our CI/CD processes.</p><p>Even though the build virtual machine has the same topology as a developer box, it really isn‚Äôt a developer VM and should never be used as one, do not use it as a developer VM! It has Visual Studio installed in it, the AosService folder with all the standard packages and SQL Server with an AxDB, just like all other developer machines, but that‚Äôs not its purpose.</p><p>We won‚Äôt be using any of those features. The ‚Äúheart‚Äù of the build machine is the build agent, an application which Azure DevOps uses to execute the build definition‚Äôs tasks from Azure DevOps.</p><p>We can also use Azure hosted build agents. Azure hosted agents allow us to run a build without a VM, the pipeline runs on Azure. We‚Äôll see this later.</p><h4 id=0131-httpsaristeinfoenmsdyn365-azure-devops-almthe-build-vmthe-build-vm>0.1.3.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#the-build-vm></a>The build VM<a hidden class=anchor aria-hidden=true href=#0131-httpsaristeinfoenmsdyn365-azure-devops-almthe-build-vmthe-build-vm>#</a></h4><p>This VM is usually the dev box on Microsoft‚Äôs subscription but you can also use a regular cloud-hosted environment as a build VM.</p><p>When this VM is deployed there‚Äôs two things happening: the basic source code structure and the default build definition are created.</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/05/Azure-DevOps-source-control.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 2" title="MSDyn365 & Azure DevOps ALM 8"></p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/05/Azure-DevOps-default-build-pipeline.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 3" title="MSDyn365 & Azure DevOps ALM 9"></p><h3 id=014-httpsaristeinfoenmsdyn365-azure-devops-almvisual-studiovisual-studio>0.1.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#visual-studio></a>Visual Studio<a hidden class=anchor aria-hidden=true href=#014-httpsaristeinfoenmsdyn365-azure-devops-almvisual-studiovisual-studio>#</a></h3><p>We have the basics to start working. Log into your dev VM and start Visual Studio, we must map the Main folder to the development machine‚Äôs packages folder. Open the team explorer and select ‚ÄúConnect to a Project‚Ä¶‚Äù:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/05/Visual-Studio.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 4" title="MSDyn365 & Azure DevOps ALM 10"></p><p>It will ask for your credentials and then show all projects available with the account you‚Äôve used. Select the project we have created in the steps earlier and click on ‚ÄúConnect‚Äù:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/05/Visual-Studio-connect-DevOps.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 5" title="MSDyn365 & Azure DevOps ALM 11"></p><p>Now open the ‚ÄúSource Control Explorer‚Äù, select the Main folder and click on the ‚ÄúNot mapped‚Äù text:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/05/Map.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 6" title="MSDyn365 & Azure DevOps ALM 12"></p><p>Map the Main folder to the K:\AosService\PackagesLocalDirectory folder on your service drive (this could be drive C if you‚Äôre using a local VM instead of a cloud-hosted environment):</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/05/Map-to-PackagesLocalDirectory.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 7" title="MSDyn365 & Azure DevOps ALM 13"></p><p>What we‚Äôve done in this step is telling Visual Studio that what‚Äôs in our Azure DevOps project, inside the Main folder, will go into the K:\AosService\PackagesLocalDirectory folder of our development VM.</p><p>The Main folder we have in our source control tree is a regular folder, but we can <a href="https://docs.microsoft.com/en-us/azure/devops/repos/tfvc/branch-folders-files?view=azure-devops&WT.mc_id=DOP-MVP-5003976#convert-a-folder-to-a-branch">convert it into a branch</a> if we need it.</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/05/2020-05-16-12_00_27.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 8" title="MSDyn365 & Azure DevOps ALM 14"></p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/05/2020-05-16-12_00_45.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 9" title="MSDyn365 & Azure DevOps ALM 15"></p><p>In the image above, you can see the icon for Main changes when it‚Äôs converted to a branch. Branches allow us to perform some actions that aren‚Äôt available to folders. Some differences can be seen in the context menu:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/02/2019-02-11-14_13_11-ie-dev01dev.northeurope.cloudapp.azure_.com_61466-Remote-Desktop-Connection.png.webp alt="Men√∫ contextual carpeta" title="MSDyn365 & Azure DevOps ALM 16"></p><p>Folder context menu</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/02/2019-02-11-14_13_28-ie-dev01dev.northeurope.cloudapp.azure_.com_61466-Remote-Desktop-Connection.png.webp alt="Men√∫ contextual rama" title="MSDyn365 & Azure DevOps ALM 17"></p><p>Branch context menu</p><p>For instance, branches can display the hierarchy of all the project branches (in this case it‚Äôs only Main and Dev so it‚Äôs quite simple).</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/02/2019-02-11-14_14_11-ie-dev01dev.northeurope.cloudapp.azure_.com_61466-Remote-Desktop-Connection.png.webp alt="Jerarqu√≠a de las ramas" title="MSDyn365 & Azure DevOps ALM 18"></p><p>Properties dialogs are different too. The folder one:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/02/2019-02-11-14_10_06-ie-dev01dev.northeurope.cloudapp.azure_.com_61466-Remote-Desktop-Connection.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 10" title="MSDyn365 & Azure DevOps ALM 19"></p><p>And the branch one, where we can see the different relationships between the other branches created from Main:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/02/2019-02-11-14_09_23-ie-dev01dev.northeurope.cloudapp.azure_.com_61466-Remote-Desktop-Connection.png.webp alt="Propiedades de la rama" title="MSDyn365 & Azure DevOps ALM 20"></p><p>This might be not that interesting or useful, but one of the things converting a folder into a branch is seeing where has a changeset been merge into.</p><h3 id=015-httpsaristeinfoenmsdyn365-azure-devops-almsome-advicesome-advice>0.1.5. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#some-advice></a>Some advice<a hidden class=anchor aria-hidden=true href=#015-httpsaristeinfoenmsdyn365-azure-devops-almsome-advicesome-advice>#</a></h3><p>I strongly recommend moving the Projects folder out of the Main branch (or whatever you call it) into the root of the project, at the same level as BuildProcessTemplates and Trunk. In fact, and this is my personal preference, I would keep anything that‚Äôs not code outside of a branch. By doing this you only need to take care of the code when merging and branching.</p><p>Those who have been working with AX for several years were used to not use version-control systems. MSDyn365FO has taken us to uncharted territory, so it is not uncommon for different teams to work in different ways, depending on their experience and what they‚Äôve found in the path. Each team will need to invest some time to discover what‚Äôs better for them regarding code, branching and methodologies. Many times, this will be based on experimentation and trial and error, and with the pace of implementation projects trial and error turns out bad.</p><h3 id=016-httpsaristeinfoenmsdyn365-azure-devops-almbranching-strategiesbranching-strategies>0.1.6. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#branching-strategies></a>Branching strategies<a hidden class=anchor aria-hidden=true href=#016-httpsaristeinfoenmsdyn365-azure-devops-almbranching-strategiesbranching-strategies>#</a></h3><p>I want to make it clear in advance: I‚Äôm not an expert in managing code nor Azure DevOps, at all. All that I‚Äôve written here is product of my experience (good and bad) of over 4 years working with Finance and Operations. In this <a href="https://docs.microsoft.com/en-us/azure/devops/repos/tfvc/branching-strategies-with-tfvc?view=azure-devops&WT.mc_id=DOP-MVP-5003976">article on branching strategies from the docs</a> there‚Äôs more information regarding branching and links to articles of the DevOps team. And there‚Äôs even more info in the <a href=http://aka.ms/vsarsolutions>DevOps Rangers‚Äô Library of tooling and guidance solutions</a>!</p><h4 id=0161-httpsaristeinfoenmsdyn365-azure-devops-almmain-releasemain-release>0.1.6.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#main-release></a>Main-Release<a hidden class=anchor aria-hidden=true href=#0161-httpsaristeinfoenmsdyn365-azure-devops-almmain-releasemain-release>#</a></h4><p>One possible strategy is using a Main and a Release branch. We have already learnt that the Main branch is created when the Build VM is deployed. The usual is that in an implementation project all development will be done on that branch until the Go Live, and just before that a new Release branch will be created.</p><p>We will keep development work on the Main branch, and when that passes validation, we‚Äôll move it to Release. This branching strategy is really simple and will keep us mostly worry-free.</p><h4 id=0162-httpsaristeinfoenmsdyn365-azure-devops-almdev-main-releasedev--main--release>0.1.6.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#dev-main-release></a>Dev ‚Äì Main ‚Äì Release<a hidden class=anchor aria-hidden=true href=#0162-httpsaristeinfoenmsdyn365-azure-devops-almdev-main-releasedev--main--release>#</a></h4><p>This strategy is similar to the Main ‚Äì Release one but includes a Dev branch for each developer. This dev branch must be maintained by the developer using it. He can do as many check-ins as he wants during a development, and when it‚Äôs done merge all these changes to the Main branch in a single changeset. Of course, this adds some <em>bureaucracy</em> because we also need to forward integrate changes from Main into our Dev branch, but it will allow us to have a cleaner list of changesets when merging them from Main to the Release branch.</p><p>Whatever branching strategy you choose try to avoid having pending changesets to be merged for a long time. The amount of merge conflicts that will appear is directly proportional to the time the changeset has been waiting to be merged.</p><p>I wrote all of this based on my experience. It‚Äôs obviously not the same working for an ISV than for an implementation partner. An ISV has different needs, it must maintain different code versions to support all their customers and they don‚Äôt necessarily need to work in a Main ‚Äì Release manner. They could have one (or more) branch for each version. However, since the end of overlayering this is not necessary. More ideas about this can be found in the article linked at the beginning.</p><h2 id=httpsaristeinfoenmsdyn365-azure-devops-almazure-pipelinesazure-pipelines><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#azure-pipelines></a>Azure Pipelines<a hidden class=anchor aria-hidden=true href=#httpsaristeinfoenmsdyn365-azure-devops-almazure-pipelinesazure-pipelines>#</a></h2><h3 id=021-httpsaristeinfoenmsdyn365-azure-devops-almbuildsbuilds>0.2.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#builds></a>Builds<a hidden class=anchor aria-hidden=true href=#021-httpsaristeinfoenmsdyn365-azure-devops-almbuildsbuilds>#</a></h3><p>We‚Äôve already seen that the default build definition has all the default steps active. We can disable (or remove) all the steps we‚Äôre not going to use. For example, the testing steps can be removed if we have no unit testing. We can also create new build definitions from scratch, however it‚Äôs easier to clone the default one and modify it to other branches or needs.</p><p>Since version 8.1 all the X++ hotfixes are gone, the updates are applied in a single deployable package as binaries. This implies that the source-controlled Metadata folder will only contain our custom packages and models, no standard packages anymore.</p><h3 id=022-httpsaristeinfoenmsdyn365-azure-devops-almcontinuous-integrationcontinuous-integration>0.2.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#continuous-integration></a>Continuous Integration<a hidden class=anchor aria-hidden=true href=#022-httpsaristeinfoenmsdyn365-azure-devops-almcontinuous-integrationcontinuous-integration>#</a></h3><p>Continuous Integration (CI) is the process of automating the build and testing of code every time a team member commits changes to version control. (<a href="https://docs.microsoft.com/en-us/azure/devops/learn/what-is-continuous-integration?WT.mc_id=DOP-MVP-5003976">source</a>)</p><p>Should your project/team use CI? Yes, yes, yes. This is one of the key feature of using an automated build process.</p><p>This is how a build definition for CI that will only compile our codebase looks like:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/02/2019-02-20-15_06_43-AXZ-Dev-Continuous-Build-Azure-DevOps-Services.png.webp alt="Definicion build continua" title="MSDyn365 & Azure DevOps ALM 21"></p><p>Only the prepare and build steps. Then we need to go to the ‚ÄúTriggers‚Äù tab and enable the CI option:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/02/2019-02-20-15_07_54-AXZ-Dev-Continuous-Build-Azure-DevOps-Services.png.webp alt="DevOps continuous integration" title="MSDyn365 & Azure DevOps ALM 22"></p><p>Right after each developer check-in, a build will be queued, and the code compiled. In case there‚Äôs a compilation error we‚Äôll be notified about it. Of course, we all build the solutions before checking them in and don‚Äôt need this CI build. Right?</p><p>![tysonjaja](./MSDyn365 & Azure DevOps ALM - ariste.info_files/tysonjaja.gif &ldquo;MSDyn365 & Azure DevOps ALM 23&rdquo;)</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/02/tysonjaja.gif alt=tysonjaja title="MSDyn365 & Azure DevOps ALM 23"></p><p>And because we all know that ‚ÄúSlow and steady wins the race‚Äù, but at some point during a project that‚Äôs not possible, so this kind of build definition can help us out. Especially when merging code between branches. This will allow us to be 100% sure when creating a DP to release to production that it‚Äôll work. I can tell you that having to do a release to prod in a hurry and seeing the Main build failing is not nice.</p><h3 id=023-httpsaristeinfoenmsdyn365-azure-devops-almgated-check-insgated-check-ins>0.2.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#gated-check-ins></a>Gated check-ins<a hidden class=anchor aria-hidden=true href=#023-httpsaristeinfoenmsdyn365-azure-devops-almgated-check-insgated-check-ins>#</a></h3><p>A gated check-in is a bit different than a CI build. The gated check-in will trigger an automated build BEFORE checking-in the code. If it fails, the changeset is not cheked-in until the errors are fixed and checked-in again.</p><p>This option might seem perfect for the merge check-ins to the Main branch. I‚Äôve found some issues trying to use it, for example:</p><ul><li>If multiple merges & check-ins from the same development are done and the first fails but the second doesn‚Äôt, you‚Äôll still have pending merges to be done. You can try batching the builds, but I haven‚Äôt tried that.</li><li>Issues with error notifications and pending code on dev VMs.</li><li>If many check-ins are made, you‚Äôll end up with lots of queued builds (and we only have one available agent per DevOps project). This can also be solved using the ‚ÄúBatch changes while a build is in progress‚Äù.</li></ul><p>I think the CI option is working perfectly to validate code. As I‚Äôve already said several times, choose the strategy that better suits your team and your needs. Experiment with CI and Gated check-in builds and decide what is better for you.</p><h3 id=024-httpsaristeinfoenmsdyn365-azure-devops-almset-up-the-new-azure-devops-tasks-for-packaging-and-model-versioningset-up-the-new-azure-devops-tasks-for-packaging-and-model-versioning>0.2.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#set-up-the-new-azure-devops-tasks-for-packaging-and-model-versioning></a>Set up the new Azure DevOps tasks for Packaging and Model Versioning<a hidden class=anchor aria-hidden=true href=#024-httpsaristeinfoenmsdyn365-azure-devops-almset-up-the-new-azure-devops-tasks-for-packaging-and-model-versioningset-up-the-new-azure-devops-tasks-for-packaging-and-model-versioning>#</a></h3><p>Almost all the tasks of the default build definition use PowerShell scripts that run on the Build VM. We can change 3 of those steps for newer tasks. In order to use these newer tasks, we need to install the ‚ÄúDynamics 365 Unified Operations Tools‚Äù. We‚Äôll be using them to set up our release pipeline too so consider doing it now.</p><h4 id=0241-httpsaristeinfoenmsdyn365-azure-devops-almupdate-model-version-taskupdate-model-version-task>0.2.4.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#update-model-version-task></a>Update Model Version task<a hidden class=anchor aria-hidden=true href=#0241-httpsaristeinfoenmsdyn365-azure-devops-almupdate-model-version-taskupdate-model-version-task>#</a></h4><p>This one is the easiest, just add it to your build definition under the current model versioning task, disable the original one and you‚Äôre done. If you have any filters in your current task, like excluding any model, you must add the filter in the <em>Descriptor Search Pattern</em> field using <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/file-matching-patterns?view=azure-devops&WT.mc_id=DOP-MVP-5003976">Azure DevOps pattern syntax</a>.</p><h4 id=0242-httpsaristeinfoenmsdyn365-azure-devops-almcreate-deployable-package-taskcreate-deployable-package-task>0.2.4.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#create-deployable-package-task></a>Create Deployable Package task<a hidden class=anchor aria-hidden=true href=#0242-httpsaristeinfoenmsdyn365-azure-devops-almcreate-deployable-package-taskcreate-deployable-package-task>#</a></h4><p>This task will replace the <em>Generate packages</em> from the current build definitions. To set it up we just need to do a pair of changes to the default values:</p><h5 id=02421-httpsaristeinfoenmsdyn365-azure-devops-almx-tools-pathx-tools-path>0.2.4.2.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#x-tools-path></a>X++ Tools Path<a hidden class=anchor aria-hidden=true href=#02421-httpsaristeinfoenmsdyn365-azure-devops-almx-tools-pathx-tools-path>#</a></h5><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/09/2019-09-05-11_25_12-AXZ-Dev-Build-DP-test-new-Azure-DevOps-Services.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 11" title="MSDyn365 & Azure DevOps ALM 24"></p><p>This is your build VM‚Äôs physical bin folder, the AosService folder is usually on the unit K for cloud-hosted VMs. I guess this will change when we go VM-less to do the builds.</p><p><strong>Update!:</strong> the route to the unit can be changed for $(ServiceDrive), getting a path like $(ServiceDrive)\AOSService\PackagesLocalDirectory\bin.</p><h5 id=02422-httpsaristeinfoenmsdyn365-azure-devops-almlocation-of-the-x-binaries-to-packagelocation-of-the-x-binaries-to-package>0.2.4.2.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#location-of-the-x-binaries-to-package></a>Location of the X++ binaries to package<a hidden class=anchor aria-hidden=true href=#02422-httpsaristeinfoenmsdyn365-azure-devops-almlocation-of-the-x-binaries-to-packagelocation-of-the-x-binaries-to-package>#</a></h5><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/09/2019-09-05-11_29_55-AXZ-Dev-Build-DP-test-new-Azure-DevOps-Services.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 12" title="MSDyn365 & Azure DevOps ALM 25"></p><p>The task comes with this field filled in as <em>$(Build.BinariesDirectory)</em> but this didn‚Äôt work out for our build definitions, maybe the variable isn‚Äôt set up on the proj file. After changing this to <em>$(Agent.BuildDirectory)\Bin</em> the package is generated.</p><h5 id=02423-httpsaristeinfoenmsdyn365-azure-devops-almfilename-and-path-for-the-deployable-packagefilename-and-path-for-the-deployable-package>0.2.4.2.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#filename-and-path-for-the-deployable-package></a>Filename and path for the deployable package<a hidden class=anchor aria-hidden=true href=#02423-httpsaristeinfoenmsdyn365-azure-devops-almfilename-and-path-for-the-deployable-packagefilename-and-path-for-the-deployable-package>#</a></h5><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/09/2019-09-05-11_33_28-AXZ-Dev-Build-DP-test-new-Azure-DevOps-Services.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 13" title="MSDyn365 & Azure DevOps ALM 26"></p><p>The path on the image should be changed to <em>$(Build.ArtifactStagingDirectory)\Packages\AXDeployableRuntime_$(Build.BuildNumber).zip</em>. You can leave it without the <em>Packages</em> folder in the path, but if you do that you will need to change the <em>Path to Publish</em> field in the <em>Publish Artifact: Package</em> step of the definition.</p><h4 id=0243-httpsaristeinfoenmsdyn365-azure-devops-almadd-licenses-to-deployable-package-taskadd-licenses-to-deployable-package-task>0.2.4.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#add-licenses-to-deployable-package-task></a>Add Licenses to Deployable Package task<a hidden class=anchor aria-hidden=true href=#0243-httpsaristeinfoenmsdyn365-azure-devops-almadd-licenses-to-deployable-package-taskadd-licenses-to-deployable-package-task>#</a></h4><p>This task will add the license files to an existing Deployable Package. Remember that the path of the deployable package must be the same as the one in the <em>Create Deployable Package</em> task.</p><h2 id=httpsaristeinfoenmsdyn365-azure-devops-almazure-hosted-build-for-dynamics-365-finance-scmazure-hosted-build-for-dynamics-365-finance--scm><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#azure-hosted-build-for-dynamics-365-finance-scm></a>Azure hosted build for Dynamics 365 Finance & SCM<a hidden class=anchor aria-hidden=true href=#httpsaristeinfoenmsdyn365-azure-devops-almazure-hosted-build-for-dynamics-365-finance-scmazure-hosted-build-for-dynamics-365-finance--scm>#</a></h2><p>The day we‚Äôve been waiting for has come! The <a href="https://docs.microsoft.com/en-us/dynamics365/fin-ops-core/dev-itpro/dev-tools/hosted-build-automation?WT.mc_id=BA-MVP-5003976">Azure hosted builds</a> are in public preview since PU35!! We can now stop asking <a href=https://twitter.com/jorisdg>Joris</a> when will this be available, because it already is! <strong><a href="https://docs.microsoft.com/en-us/dynamics365/fin-ops-core/dev-itpro/dev-tools/hosted-build-automation?WT.mc_id=BA-MVP-5003976">Check the docs</a>!</strong></p><p>I‚Äôve been able to write this because, thanks to <a href=https://twitter.com/_Gilabert_>Antonio Gilabert</a>, we‚Äôve been testing this at <a href=https://www.axazure.com/>Axazure</a> for a few months with access to the private preview. And of course thanks to Joris for inviting us to the preview!</p><p><img loading=lazy src="https://i1.wp.com/ariste.info/wp-content/uploads/2020/05/AzureDevOpsPipeline-2.png?fit=702%2C1024&ssl=1" alt="Azure hosted build" title="MSDyn365 & Azure DevOps ALM 27"></p><p>Riding the Azure Pipelines by <a href=https://cazapelusas.com/>Caza Pelusas</a></p><p>What does this mean? We no longer need a VM to run the build pipelines! <strong>Nah, we still need!</strong> If you‚Äôre <strong>running tests or synchronizing the DB</strong> as a part of your build pipeline you still need the VM. But we can move CI builds to the Azure hosted agent!</p><p>You can also read my full guide on <a href=https://ariste.info/en/msdyn365-azure-devops-alm/>MSDyn365FO & Azure DevOps ALM</a>.</p><p>Remember <strong>this is a public preview</strong>. If you want to join the preview you first need to be part of the Dynamics 365 <a href=https://experience.dynamics.com/>Insider Program</a> where you can join the ‚Äú<strong>Dynamics 365 for Finance and Operations Insider Community</strong>‚Äú. Once invited you should see a new LCS project called PEAP Assets, and inside its Asset Library you‚Äôll find the nugets in the Nuget package section.</p><h3 id=031-httpsaristeinfoenmsdyn365-azure-devops-almazure-agentsazure-agents>0.3.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#azure-agents></a>Azure agents<a hidden class=anchor aria-hidden=true href=#031-httpsaristeinfoenmsdyn365-azure-devops-almazure-agentsazure-agents>#</a></h3><p>With the capacity to run an <strong>extra</strong> Azure-hosted build we get another agent to run a pipeline and can run multiple pipelines at the same time. But it <strong>still won‚Äôt be parallel pipelines</strong>, because we only get one VM-less agent. This means <strong>we can run a self-hosted and azure hosted pipeline at the same time, but we cannot run two of the same type in parallel</strong>. If we want that we need to <a href="https://docs.microsoft.com/en-us/azure/devops/organizations/billing/buy-more-build-vs?view=azure-devops&WT.mc_id=DOP-MVP-5003976#microsoft-hosted-cicd">purchase extra agents</a>.</p><p>With a private Azure DevOps project we get 2GB of Artifacts space (we‚Äôll see that later) and one self-hosted and one Microsoft hosted agent with 1800 free minutes:</p><p><img loading=lazy src="https://i1.wp.com/ariste.info/wp-content/uploads/2020/04/08CEA665-618A-4F15-B9EC-F86A405FA7D8.jpeg?fit=909%2C1024&ssl=1" alt="08CEA665 618A 4F15 B9EC F86A405FA7D8" title="MSDyn365 & Azure DevOps ALM 28"></p><p>Azure hosted build: Azure DevOps project pricing</p><p><strong>We‚Äôll still keep the build VM</strong>, so it‚Äôs difficult to tell a customer we need to pay extra money without getting rid of its cost. Plus we‚Äôve been doing everything with one agent until now and it‚Äôs been fine, right? So <strong>take this like extra capacity</strong>, we can divide the build between both agents and leave the MS hosted one for short builds to squeeze the 1800 free minutes as much as possible.</p><h3 id=032-httpsaristeinfoenmsdyn365-azure-devops-almhow-does-it-workhow-does-it-work>0.3.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#how-does-it-work></a>How does it work?<a hidden class=anchor aria-hidden=true href=#032-httpsaristeinfoenmsdyn365-azure-devops-almhow-does-it-workhow-does-it-work>#</a></h3><p>There‚Äôs really no magic in this. We move from a self-hosted agent in the build VM to a <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/hosted?WT.mc_id=DOP-MVP-5003976&view=azure-devops">Microsoft-hosted agent.</a></p><p>The Azure hosted build relies on <a href="https://docs.microsoft.com/en-us/nuget/what-is-nuget?WT.mc_id=DOP-MVP-5003976">nuget packages</a> to compile our X++ code. The contents of the PackagesLocalDirectory folder, platform and the compiler tools have basically been put into nugets and what we have in the build VM is now on 3 nugets.</p><p>When the build runs it downloads & installs the nugets and uses them to compile our code on the Azure hosted build along the standard packages.</p><h3 id=033-httpsaristeinfoenmsdyn365-azure-devops-almwhat-do-i-needwhat-do-i-need>0.3.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#what-do-i-need></a>What do I need?<a hidden class=anchor aria-hidden=true href=#033-httpsaristeinfoenmsdyn365-azure-devops-almwhat-do-i-needwhat-do-i-need>#</a></h3><p>To configure the Azure hosted build we need:</p><ul><li><p>The 3 nuget packages from <a href=https://lcs.dynamics.com/>LCS</a>: Compiler tools, Platform X++ and Application X++.</p></li><li><p><a href=https://www.nuget.org/downloads>nuget.exe</a></p></li><li><p>A user with rights at the organization level to upload the nugets to Azure DevOps.</p></li><li><p>Some patience to get everything running üôÇ</p></li></ul><p>So the first step is going to the PEAP LCS‚Äô Asset Library and downloading the 3 nuget packages:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/04/2020-04-24-13_44_51.png.webp alt="Nugets for the Azure Hosted Build" title="MSDyn365 & Azure DevOps ALM 29"></p><p>Nugets for the Azure Hosted Build</p><h3 id=034-httpsaristeinfoenmsdyn365-azure-devops-almazure-devops-artifactazure-devops-artifact>0.3.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#azure-devops-artifact></a>Azure DevOps artifact<a hidden class=anchor aria-hidden=true href=#034-httpsaristeinfoenmsdyn365-azure-devops-almazure-devops-artifactazure-devops-artifact>#</a></h3><p>All of this can be done on your PC or in a dev VM, but you‚Äôll need to add some files and <strong>a VS project to your source control</strong> so you need to use the developer box for sure.</p><p>Head to your Azure DevOps project and go to the Artifacts section. Here we‚Äôll create a new feed and give it a name:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/04/2020-04-24-09_24_19.png.webp alt="Azure DevOps artifact feed" title="MSDyn365 & Azure DevOps ALM 30"></p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/04/2020-04-24-09_24_55.png.webp alt="Azure DevOps artifact feed" title="MSDyn365 & Azure DevOps ALM 31"></p><p>You get 2GB for artifacts, the 3 nuget packages‚Äô size is around 500MB, you should have no issues with space unless you have other artifacts in your project.</p><p>Now press the ‚ÄúConnect to feed‚Äù button and select nuget.exe. You‚Äôll find the instructions to continue there but I‚Äôll explain it anyway.</p><p>Then you need to <a href=https://www.nuget.org/downloads>download nuget.exe</a> and put it in the Windows PATH. You can also get the nugets and nuget.exe in the same folder and forget about the PATH. Up to you. Finally, install the credential provider: download <a href=https://raw.githubusercontent.com/microsoft/artifacts-credprovider/master/helpers/installcredprovider.ps1>this Powershell script</a> and run it. If the script keeps asking for your credentials and fails try adding -AddNetfx as a parameter. Thanks to Erik Norell for finding this and sharing in the¬†<a href=https://ariste.info/en/2020/05/azure-hosted-build-dynamics365-finance-scm/#comment-1793>comments of the original post</a>!</p><p>Create a new file called <em>nuget.config</em> in the same folder where you‚Äôve downloaded the nugets. It will have the content you can see in the ‚ÄúConnect to feed‚Äù page, something like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-xml data-lang=xml><span class=cp>&lt;?xml version\=&#34;1.0&#34; encoding\=&#34;utf-8&#34;?&gt;</span>
<span class=nt>&lt;configuration</span><span class=err>\</span><span class=nt>&gt;</span>
 <span class=nt>&lt;packageSources</span><span class=err>\</span><span class=nt>&gt;</span>
 <span class=nt>&lt;clear</span> <span class=err>/\</span><span class=nt>&gt;</span>
 <span class=nt>&lt;add</span> <span class=err>key\=&#34;AASBuild&#34;</span> <span class=err>value\=&#34;https://pkgs.dev.azure.com/aariste/aariste365FO/\_packaging/AASBuild/nuget/v3/index.json&#34;</span> <span class=err>/\</span><span class=nt>&gt;</span>
 <span class=err>&lt;</span>/packageSources\&gt;
<span class=err>&lt;</span>/configuration\&gt;
</code></pre></td></tr></table></div></div><p><strong>This file‚Äôs content has to be exactly the same as what‚Äôs displayed in your ‚ÄúConnect to feed‚Äù page.</strong></p><p>And finally, we‚Äôll push (upload) the nugets to our artifacts feed. We have to do this for each one of the 3 nugets we‚Äôve downloaded:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=n>nuget</span><span class=p>.</span><span class=n>exe</span> <span class=n>push</span> <span class=n>-Source</span> <span class=s2>&#34;AASBuild&#34;</span> <span class=n>-ApiKey</span> <span class=n>az</span> <span class=p>&lt;</span><span class=n>packagePath</span><span class=p>&gt;</span>
</code></pre></td></tr></table></div></div><p>You‚Äôll get prompted for the user. Remember it needs to have enough rights on the project.</p><p>Of course, you need to change ‚ÄúAASBuild‚Äù for your artifact feed name. And we‚Äôre done with the artifacts.</p><h3 id=035-httpsaristeinfoenmsdyn365-azure-devops-almprepare-azure-devopsprepare-azure-devops>0.3.5. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#prepare-azure-devops></a>Prepare Azure DevOps<a hidden class=anchor aria-hidden=true href=#035-httpsaristeinfoenmsdyn365-azure-devops-almprepare-azure-devopsprepare-azure-devops>#</a></h3><p>This new agent needs a solution to build our packages. This means we have to create an empty solution in Visual Studio and set the package of the project to our main package. Like this:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/04/2020-04-24-14_20_58.png.webp alt="2020 04 24 14 20 58" title="MSDyn365 & Azure DevOps ALM 32"></p><p>Visual Studio solution</p><p>If you have more than one package or models, you need to add a project to this solution for each separate model you have.</p><p>We have to create another file called <em>packages.config</em> with the following content:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-xml data-lang=xml><span class=cp>&lt;?xml version\=&#34;1.0&#34; encoding\=&#34;utf-8&#34;?&gt;</span>
<span class=nt>&lt;packages&gt;</span>
 <span class=nt>&lt;package</span> <span class=err>id\=&#34;Microsoft.Dynamics.AX.Platform.DevALM.BuildXpp&#34;</span> <span class=err>version\=&#34;7.0.5644.16778&#34;</span> <span class=err>targetFramework\=&#34;net40&#34;</span> <span class=nt>/&gt;</span>
 <span class=nt>&lt;package</span> <span class=err>id\=&#34;Microsoft.Dynamics.AX.Application.DevALM.BuildXpp&#34;</span> <span class=err>version\=&#34;10.0.464.13&#34;</span> <span class=err>targetFramework\=&#34;net40&#34;</span> <span class=nt>/&gt;</span>
 <span class=nt>&lt;package</span> <span class=err>id\=&#34;Microsoft.Dynamics.AX.Platform.CompilerPackage&#34;</span> <span class=err>version\=&#34;7.0.5644.16778&#34;</span> <span class=err>targetFramework\=&#34;net40&#34;</span> <span class=nt>/&gt;</span>
<span class=nt>&lt;/packages&gt;</span>
</code></pre></td></tr></table></div></div><p>The version tag will depend on when you‚Äôre reading this, but the one above is the correct one for PU35. <strong>We‚Äôll need to update this file each time a new version of the nugets is published.</strong></p><p>And, to end with this part, we need to add the solution, the nuget.config and the packages.config files to TFVC. This is what I‚Äôve done:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/04/2020-04-24-14_29_01.png.webp alt="2020 04 24 14 29 01" title="MSDyn365 & Azure DevOps ALM 33"></p><p>Azure DevOps</p><p>You can see I‚Äôve created a Build folder in the root of my DevOps project. That‚Äôs only my preference, but I like to only have code in my branches, even the projects are outside of the branches, I only want the code to move between merges and branches. Place the files and solution inside the Build folder (or wherever you decide).</p><h3 id=036-httpsaristeinfoenmsdyn365-azure-devops-almconfigure-pipelineconfigure-pipeline>0.3.6. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#configure-pipeline></a>Configure pipeline<a hidden class=anchor aria-hidden=true href=#036-httpsaristeinfoenmsdyn365-azure-devops-almconfigure-pipelineconfigure-pipeline>#</a></h3><p>Now we need to create a new pipeline, you can just import <a href=https://github.com/microsoft/Dynamics365-Xpp-Samples-Tools/blob/master/CI-CD/Pipeline-Samples/xpp-classic-ci.json>this template</a> from the newly created <a href=https://github.com/microsoft/Dynamics365-Xpp-Samples-Tools>X++ (Dynamics 365) Samples and Tools Github project</a>. After importing the template we‚Äôll modify it a bit. Initially, it will look like this:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/04/2020-04-24-14_35_07-1.png.webp alt="2020 04 24 14 35 07 1" title="MSDyn365 & Azure DevOps ALM 34"></p><p>Azure hosted build: Default imported pipeline</p><p>As you can see the pipeline has all the steps needed to generate the DP, but some of them, the ones contained in the Dynamics 365 tasks, won‚Äôt load correctly after the import. <strong>You just need to add those steps to your pipeline manually and complete its setup.</strong></p><h4 id=0361-httpsaristeinfoenmsdyn365-azure-devops-almpipeline-rootpipeline-root>0.3.6.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#pipeline-root></a>Pipeline root<a hidden class=anchor aria-hidden=true href=#0361-httpsaristeinfoenmsdyn365-azure-devops-almpipeline-rootpipeline-root>#</a></h4><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/04/2020-04-24-14_38_27.png.webp alt="2020 04 24 14 38 27" title="MSDyn365 & Azure DevOps ALM 35"></p><p>You need to select the Hosted Azure Pipelines for the Agent pool, and vs2017-win2016 as Agent Specification.</p><h4 id=0362-httpsaristeinfoenmsdyn365-azure-devops-almget-sourcesget-sources>0.3.6.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#get-sources></a>Get sources<a hidden class=anchor aria-hidden=true href=#0362-httpsaristeinfoenmsdyn365-azure-devops-almget-sourcesget-sources>#</a></h4><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/04/2020-04-24-14_42_07.png.webp alt="DevOps mappings" title="MSDyn365 & Azure DevOps ALM 36"></p><p>Azure hosted build: Our mappings</p><p>I‚Äôve mapped 2 things here: our codebase in the first mapping and the Build folder where I‚Äôve added the solution and config files. If you‚Äôve placed these files inside your Metadata folder you don‚Äôt need the extra mapping.</p><h4 id=0363-httpsaristeinfoenmsdyn365-azure-devops-almnuget-install-packagesnuget-install-packages>0.3.6.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#nuget-install-packages></a>NuGet install Packages<a hidden class=anchor aria-hidden=true href=#0363-httpsaristeinfoenmsdyn365-azure-devops-almnuget-install-packagesnuget-install-packages>#</a></h4><p>This step gets the nugets from our artifacts feeds and the installs to be used in each pipeline execution.</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/04/2020-04-25-12_41_47-1.png.webp alt="2020 04 25 12 41 47 1" title="MSDyn365 & Azure DevOps ALM 37"></p><p>Azure hosted build: nuget install</p><p>The command uses the config files we have uploaded to the Build folder, and as you can see it‚Äôs fetching the files from the <em>$(build.sourcesDirectory)\Build</em> directory we‚Äôve configured in the Get sources step. If you‚Äôve placed those files in a diferent place you need to change the paths as needed.</p><h4 id=0364-httpsaristeinfoenmsdyn365-azure-devops-almupdate-model-versionupdate-model-version>0.3.6.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#update-model-version></a>Update Model Version<a hidden class=anchor aria-hidden=true href=#0364-httpsaristeinfoenmsdyn365-azure-devops-almupdate-model-versionupdate-model-version>#</a></h4><p>This is one of the steps that are displaying issues even though I got the Dynamics 365 tools installed from the Azure DevOps marketplace. If you got it right you probably don‚Äôt need to change anything. If you have the same issue as me, just add a new step and select the ‚ÄúUpdate Model Version‚Äù task and change the fields so it looks like this:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/04/2020-04-24-14_53_56-1.png.webp alt="Update Model Version" title="MSDyn365 & Azure DevOps ALM 38"></p><p>Azure hosted build: Update Model Version</p><h4 id=0365-httpsaristeinfoenmsdyn365-azure-devops-almbuild-solutionbuild-solution>0.3.6.5. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#build-solution></a>Build solution<a hidden class=anchor aria-hidden=true href=#0365-httpsaristeinfoenmsdyn365-azure-devops-almbuild-solutionbuild-solution>#</a></h4><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/09/2020-09-25-09_33_56.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 14" title="MSDyn365 & Azure DevOps ALM 39"></p><p>Build solution step</p><p>In the build solution step, you have a wildcard in the solution field: **\\*.sln. If you leave this wildcard it will build all the projects you have in the repo and, depending on the number of projects you have, the build could time out.</p><p>I solve this by selecting a solution, that contains all the models I have, that I have placed in the Build folder in my repo, and update that solution if you add or remove any model.</p><p>Thanks to <a href=https://twitter.com/IevgenMir>Ievgen Miroshnikov</a> for pointing this out!</p><p>There could be an additional issue with the rnrproj files as <a href=https://ariste.info/en/2020/05/azure-hosted-build-dynamics365-finance-scm/#comment-5584>Josh Williams points out in a comment</a>. If your project was created pre-PU27 try creating a new solution to avoid problems.</p><h4 id=0366-httpsaristeinfoenmsdyn365-azure-devops-almcreate-deployable-packagecreate-deployable-package>0.3.6.6. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#create-deployable-package></a>Create Deployable Package<a hidden class=anchor aria-hidden=true href=#0366-httpsaristeinfoenmsdyn365-azure-devops-almcreate-deployable-packagecreate-deployable-package>#</a></h4><p>This is another one of the steps that are not loading correctly for me. Again, add it and change as needed:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/04/2020-04-24-14_55_32.png.webp alt="2020 04 24 14 55 32" title="MSDyn365 & Azure DevOps ALM 40"></p><p>Azure hosted build: Create Deployable Package</p><h4 id=0367-httpsaristeinfoenmsdyn365-azure-devops-almadd-licenses-to-deployable-packageadd-licenses-to-deployable-package>0.3.6.7. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#add-licenses-to-deployable-package></a>Add Licenses to Deployable Package<a hidden class=anchor aria-hidden=true href=#0367-httpsaristeinfoenmsdyn365-azure-devops-almadd-licenses-to-deployable-packageadd-licenses-to-deployable-package>#</a></h4><p>Another step with issues. Do the same as with the others:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/04/2020-04-24-14_57_35.png.webp alt="2020 04 24 14 57 35" title="MSDyn365 & Azure DevOps ALM 41"></p><p>Azure hosted build: Add Licenses to Deployable Package</p><p>And that‚Äôs all. You can queue the build to test if it‚Äôs working. For the first runs you can disable the steps after the ‚ÄúBuild solution‚Äù one to see if the nugets are downloaded correctly and your code built. After that try generating the DP and publishing the artifact.</p><p>You‚Äôve configured your Azure hosted build, now it‚Äôs your turn to decide in which cases will you use the self-hosted or the azure hosted build.</p><h3 id=037-httpsaristeinfoenmsdyn365-azure-devops-almupdate-for-version-10-0-18update-for-version-10018>0.3.7. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#update-for-version-10-0-18></a>Update for version 10.0.18<a hidden class=anchor aria-hidden=true href=#037-httpsaristeinfoenmsdyn365-azure-devops-almupdate-for-version-10-0-18update-for-version-10018>#</a></h3><p>Since version 10.0.18 we‚Äôll be getting 4 NuGet packages instead of 3 because of the Microsoft.Dynamics.AX.Application.DevALM.BuildXpp NuGet size is getting near or over the max size which is 500MB and will come as 2 NuGet packages from now on.</p><p><a href="https://docs.microsoft.com/en-us/dynamics365/fin-ops-core/dev-itpro/dev-tools/pipeline-nuget-split?WT.mc_id=BA-MVP-5003976">You can read about this in the docs</a>.</p><p>There just 2 small changes we need to do to the pipeline if we‚Äôre already using it, one to the packages.config file and another one to the pipeline.</p><h4 id=0371-httpsaristeinfoenmsdyn365-azure-devops-almpackages-configpackagesconfig>0.3.7.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#packages-config></a>packages.config<a hidden class=anchor aria-hidden=true href=#0371-httpsaristeinfoenmsdyn365-azure-devops-almpackages-configpackagesconfig>#</a></h4><p>The packages.config file will have an additional line for the Application Suite NuGet.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-xml data-lang=xml><span class=cp>&lt;?xml version\=&#34;1.0&#34; encoding\=&#34;utf-8&#34;?&gt;</span>

<span class=nt>&lt;packages</span><span class=err>\</span><span class=nt>&gt;</span>

 <span class=nt>&lt;package</span> <span class=err>id\=&#34;Microsoft.Dynamics.AX.Platform.DevALM.BuildXpp&#34;</span> <span class=err>version\=&#34;7.0.5968.16973&#34;</span> <span class=err>targetFramework\=&#34;net40&#34;</span> <span class=err>/\</span><span class=nt>&gt;</span>

 <span class=nt>&lt;package</span> <span class=err>id\=&#34;Microsoft.Dynamics.AX.Application.DevALM.BuildXpp&#34;</span> <span class=err>version\=&#34;10.0.793.16&#34;</span> <span class=err>targetFramework\=&#34;net40&#34;</span> <span class=err>/\</span><span class=nt>&gt;</span>

 <span class=nt>&lt;package</span> <span class=err>id\=&#34;Microsoft.Dynamics.AX.ApplicationSuite.DevALM.BuildXpp&#34;</span> <span class=err>version\=&#34;10.0.793.16&#34;</span> <span class=err>targetFramework\=&#34;net40&#34;</span> <span class=err>/\</span><span class=nt>&gt;</span>

 <span class=nt>&lt;package</span> <span class=err>id\=&#34;Microsoft.Dynamics.AX.Platform.CompilerPackage&#34;</span> <span class=err>version\=&#34;7.0.5968.16973&#34;</span> <span class=err>targetFramework\=&#34;net40&#34;</span> <span class=err>/\</span><span class=nt>&gt;</span>

<span class=err>&lt;</span>/packages\&gt;
</code></pre></td></tr></table></div></div><h4 id=0372-httpsaristeinfoenmsdyn365-azure-devops-almpipelinepipeline>0.3.7.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#pipeline></a>Pipeline<a hidden class=anchor aria-hidden=true href=#0372-httpsaristeinfoenmsdyn365-azure-devops-almpipelinepipeline>#</a></h4><p>We need to add a new variable to the pipeline variables called AppSuitePackage with the value Microsoft.Dynamics.<em>AX.ApplicationSuite.DevALM.BuildXpp</em>.</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2021/05/image-1024x664.png.webp alt="New Azure DevOps pipeline variable" title="MSDyn365 & Azure DevOps ALM 42"></p><p>New Azure DevOps pipeline variable</p><p>And then use it in the build step and change it to:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=p>/</span><span class=n>p:BuildTasksDirectory</span><span class=p>\=</span><span class=s2>&#34;</span><span class=p>$(</span><span class=n>NugetsPath</span><span class=p>)</span><span class=s2>\\</span><span class=p>$(</span><span class=n>ToolsPackage</span><span class=p>)</span><span class=s2>\\DevAlm&#34;</span> <span class=p>/</span><span class=n>p:MetadataDirectory</span><span class=p>\=</span><span class=s2>&#34;</span><span class=p>$(</span><span class=n>MetadataPath</span><span class=p>)</span><span class=s2>&#34;</span> <span class=p>/</span><span class=n>p:FrameworkDirectory</span><span class=p>\=</span><span class=s2>&#34;</span><span class=p>$(</span><span class=n>NuGetsPath</span><span class=p>)</span><span class=s2>\\</span><span class=p>$(</span><span class=n>ToolsPackage</span><span class=p>)</span><span class=s2>&#34;</span> <span class=p>/</span><span class=n>p:ReferenceFolder</span><span class=p>\=</span><span class=s2>&#34;</span><span class=p>$(</span><span class=n>NuGetsPath</span><span class=p>)</span><span class=s2>\\</span><span class=p>$(</span><span class=n>PlatPackage</span><span class=p>)</span><span class=s2>\\ref\\net40;</span><span class=p>$(</span><span class=n>NuGetsPath</span><span class=p>)</span><span class=s2>\\</span><span class=p>$(</span><span class=n>AppPackage</span><span class=p>)</span><span class=s2>\\ref\\net40;</span><span class=p>$(</span><span class=n>MetadataPath</span><span class=p>)</span><span class=s2>;</span><span class=p>$(</span><span class=n>Build</span><span class=p>.</span><span class=n>BinariesDirectory</span><span class=p>)</span><span class=s2>;</span><span class=p>$(</span><span class=n>NuGetsPath</span><span class=p>)</span><span class=s2>\\</span><span class=p>$(</span><span class=n>AppSuitePackage</span><span class=p>)</span><span class=s2>\\ref\\net40&#34;</span> <span class=p>/</span><span class=n>p:ReferencePath</span><span class=p>\=</span><span class=s2>&#34;</span><span class=p>$(</span><span class=n>NuGetsPath</span><span class=p>)</span><span class=s2>\\</span><span class=p>$(</span><span class=n>ToolsPackage</span><span class=p>)</span><span class=s2>&#34;</span> <span class=p>/</span><span class=n>p:OutputDirectory</span><span class=p>\=</span><span class=s2>&#34;</span><span class=p>$(</span><span class=n>Build</span><span class=p>.</span><span class=n>BinariesDirectory</span><span class=p>)</span><span class=s2>&#34;</span>
</code></pre></td></tr></table></div></div><h2 id=httpsaristeinfoenmsdyn365-azure-devops-almazure-devtest-labs-powered-buildsazure-devtest-labs-powered-builds><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#azure-devtest-labs-powered-builds></a>Azure DevTest Labs powered builds<a hidden class=anchor aria-hidden=true href=#httpsaristeinfoenmsdyn365-azure-devops-almazure-devtest-labs-powered-buildsazure-devtest-labs-powered-builds>#</a></h2><p>The <strong><a href=https://ariste.info/en/2020/10/tier-1-microsoft-managed-removed/>end of Tier-1 Microsoft-managed build VMs</a> is near</strong>, and this will leave us without the capacity to synchronize the DB or run tests in a pipeline, unless we deploy a new build VM in our, or our customer‚Äôs, Azure subscription. Of course, there might be a cost concern with it, and there‚Äôs where <strong>Azure DevTest Labs</strong> can help us!</p><p><strong>This post has been written thanks to <a href=https://twitter.com/jorisdg>Joris de Gruyter</a>‚Äòs session in the past <a href=https://dynamicscon.com/>DynamicsCon</a></strong>: <a href="https://www.youtube.com/watch?v=VIib-m6Q8LQ">Azure Devops Automation for Finance and Operations Like You‚Äôve Never Seen!</a> And there‚Äôs also been some investigation and (a lot of) trial-and-error from my side until everything has been working.</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2021/01/adtl-1024x1024.png.webp alt="Azure DevTest Labs" title="MSDyn365 & Azure DevOps ALM 43"></p><p>Configuring the build VM in Azure DevTest Labs</p><p>If you want to know more about builds, releases, and the Dev ALM of Dynamics 365 you can read my full guide on <a href=https://ariste.info/en/msdyn365-azure-devops-alm/>MSDyn365 & Azure DevOps ALM</a>.</p><h3 id=041-httpsaristeinfoenmsdyn365-azure-devops-almbut-firstbut-first>0.4.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#but-first></a>But first‚Ä¶<a hidden class=anchor aria-hidden=true href=#041-httpsaristeinfoenmsdyn365-azure-devops-almbut-firstbut-first>#</a></h3><p>What I‚Äôm showing in this post is not a perfect blueprint. There‚Äôs a high probability that if you try exactly the same as I do here, you won‚Äôt get the same result. But it‚Äôs a good guide to get started and do some investigation on your own and learn.</p><h3 id=042-httpsaristeinfoenmsdyn365-azure-devops-almazure-devtest-labsazure-devtest-labs>0.4.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#azure-devtest-labs></a>Azure DevTest Labs<a hidden class=anchor aria-hidden=true href=#042-httpsaristeinfoenmsdyn365-azure-devops-almazure-devtest-labsazure-devtest-labs>#</a></h3><p><a href="https://azure.microsoft.com/en-us/services/devtest-lab?WT.mc_id=BA-MVP-5003976">Azure DevTest Labs</a> is an Azure tool/service that allows us to <strong>deploy virtual machines and integrate them with Azure DevOps pipelines</strong>, and many other things, but what I‚Äôm going to explain is just the VM and pipeline part.</p><p>What will I show in this post? How to <strong>prepare a Dynamics 365 Finance and Operations VHD image to be used as the base to create a build virtual machine from an Azure DevOps pipeline</strong>, build our codebase, synchronize the DB, run tests, even deploy the reports, generate the deployable package and delete the VM.</p><h3 id=043-httpsaristeinfoenmsdyn365-azure-devops-almgetting-and-preparing-the-vhdgetting-and-preparing-the-vhd>0.4.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#getting-and-preparing-the-vhd></a>Getting and preparing the VHD<a hidden class=anchor aria-hidden=true href=#043-httpsaristeinfoenmsdyn365-azure-devops-almgetting-and-preparing-the-vhdgetting-and-preparing-the-vhd>#</a></h3><p>This is by far the most tedious part of all the process because you need to download 11 ZIP files from LCS‚Äô Shared Asset Library, and we all know how fast things download from LCS.</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/12/fast.png.webp alt="LCS download speed" title="MSDyn365 & Azure DevOps ALM 44"></p><p>How is LCS download speed?</p><p>And to speed it up we can create a blob storage account on Azure and once more turn to <a href=https://mobile.twitter.com/splaxi>M√∂tz Jensen</a>‚Äòs <a href=https://github.com/d365collaborative/d365fo.tools>d365fo.tools</a> and use the Invoke-D365AzCopyTransfer cmdlet. Just go to LCS, click on the ‚ÄúGenerate SAS link‚Äù button for each file, use it as the source parameter in the command and your blob SAS URL as the destination one. Once you have all the files in your blob you can download them to your local PC at a good speed.</p><p>Once you‚Äôve unzipped the VHD you need to change it from Dynamic to Fixed using this PowerShell command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=nb>Convert-VHD</span> <span class=err>‚Äì</span><span class=n>Path</span> <span class=n>VHDLOCATION</span><span class=p>.</span><span class=n>vhd</span> <span class=err>‚Äì</span><span class=n>DestinationPath</span> <span class=n>NEWVHD</span><span class=p>.</span><span class=n>vhd</span> <span class=err>‚Äì</span><span class=n>VHDType</span> <span class=n>Fixed</span>
</code></pre></td></tr></table></div></div><p>The reason is <strong>you can‚Äôt create an Azure VM from a dynamically-sized VHD</strong>. And it took me several attempts to notice this üôÇ</p><h3 id=044-httpsaristeinfoenmsdyn365-azure-devops-almcreate-a-devtest-labs-accountcreate-a-devtest-labs-account>0.4.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#create-a-devtest-labs-account></a>Create a DevTest Labs account<a hidden class=anchor aria-hidden=true href=#044-httpsaristeinfoenmsdyn365-azure-devops-almcreate-a-devtest-labs-accountcreate-a-devtest-labs-account>#</a></h3><p>To do this part <strong>you need an Azure account</strong>. If you don‚Äôt have one you can <a href="https://azure.microsoft.com/en-us/free?WT.mc_id=BA-MVP-5003976">sign up for a free Azure account</a> with a credit of 180 Euros (200 US Dollars) to be spent during 30 days, plus many other free services during 12 months.</p><p>Search for DevTest Labs in the top bar and create a new DevTest Lab. Once it‚Äôs created open the details and you should see something like this:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/12/DevTest1.png.webp alt="Azure DevTest Labs" title="MSDyn365 & Azure DevOps ALM 45"></p><p>Azure DevTest Labs</p><p>Click on the ‚ÄúConfiguration and policies‚Äù menu item at the bottom of the list and scroll down in the menu until you see the ‚ÄúVirtual machine bases‚Äù section:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/12/DevTest2.png.webp alt="DevTest Labs custom VHD image" title="MSDyn365 & Azure DevOps ALM 46"></p><p>DevTest Labs custom image</p><p>And now comes the second funniest part of the process: <strong>we need to upload the 130GB VHD image to a blob storage account</strong>! So, click the ‚ÄúAdd‚Äù button on top and in the new dialog that will open click the ‚ÄúUpload a VHD using PowerShell‚Äù. This will generate a PowerShell script to upload the VHD to the DevTest Labs blob. For example:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell>
<span class=cm>&lt;# Generated script to upload a local VHD to Azure. WARNING: The destination will be publicly available for 24 hours, after which it will expire. Ensure you complete your upload by then. Run the following command in a Azure PowerShell console after entering the LocalFilePath to your VHD. #&gt;</span> 
<span class=nb>Add-AzureRmVhd</span> <span class=n>-Destination</span> <span class=s2>&#34;https://YOURBLOB.blob.core.windows.net/uploads/tempImage.vhd?sv=2019-07-07&amp;st=2020-12-27T09%3A08%3A26Z&amp;se=2020-12-28T09%3A23%3A26Z&amp;sr=b&amp;sp=rcw&amp;sig=YTeXpxpVEJdSM7KZle71w8NVw9oznNizSnYj8Q3hngI%3D&#34;</span> <span class=n>-LocalFilePath</span> <span class=s2>&#34;&lt;Enter VHD location here&gt;&#34;</span>
</code></pre></td></tr></table></div></div><p>Generated script to upload a local VHD to Azure.</p><p>WARNING: The destination will be publicly available for 24 hours, after which it will expire.</p><p>Ensure you complete your upload by then.</p><p>Run the following command in a Azure PowerShell console after entering</p><p>the LocalFilePath to your VHD.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=nb>Add-AzureRmVhd</span> <span class=p>\</span><span class=n>-Destination</span> <span class=s2>&#34;https://YOURBLOB.blob.core.windows.net/uploads/tempImage.vhd?sv=2019-07-07&amp;st=2020-12-27T09%3A08%3A26Z&amp;se=2020-12-28T09%3A23%3A26Z&amp;sr=b&amp;sp=rcw&amp;sig=YTeXpxpVEJdSM7KZle71w8NVw9oznNizSnYj8Q3hngI%3D&#34;</span> <span class=p>\</span><span class=n>-LocalFilePath</span> <span class=s2>&#34;&lt;Enter VHD location here&gt;&#34;</span>
</code></pre></td></tr></table></div></div><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/12/DevTest3.png.webp alt="DevTest Labs custom image upload" title="MSDyn365 & Azure DevOps ALM 47"></p><p>DevTest Labs custom image upload</p><p>An alternative to this is using the Azure Storage Explorer as you can see in the image on the left.</p><p>You should upload the VHD to the uploads blob.</p><p>Any of these methods is good to upload the VHD and I don‚Äôt really know which one is faster.</p><p>Once the VHD is uploaded open the ‚ÄúCustom images‚Äù option again and you should see the VHD in the drop-down:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/12/DevTest4.png.webp alt="DevTest Labs custom image" title="MSDyn365 & Azure DevOps ALM 48"></p><p>DevTest Labs custom image</p><p>Give the image a name and click OK.</p><p>What we have now is the <strong>base for a Dynamics 365 Finance and Operations dev VM</strong> which we need to prepare to use it as a build VM.</p><h3 id=045-httpsaristeinfoenmsdyn365-azure-devops-almcreating-the-vmcreating-the-vm>0.4.5. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#creating-the-vm></a>Creating the VM<a hidden class=anchor aria-hidden=true href=#045-httpsaristeinfoenmsdyn365-azure-devops-almcreating-the-vmcreating-the-vm>#</a></h3><p>We‚Äôve got the essential, a VHD ready to be used as a base to create a virtual machine in Azure. Our next step is finding a way to make the deployment of this VM <strong>predictable and automated</strong>. We will attain this thanks to <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview?WT.mc_id=BA-MVP-5003976">Azure ARM templates</a>.</p><p>Go back to your DevTest Labs overview page and click the ‚ÄúAdd‚Äù button, on the ‚ÄúChoose base‚Äù page select the base you‚Äôve just created, and on the next screen click on the ‚ÄúAdd or Remove Artifacts‚Äù link:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/12/DevTest5.png.webp alt="Add artifacts to the VM" title="MSDyn365 & Azure DevOps ALM 49"></p><p>Add artifacts to the VM</p><p>Search for <strong>WinRM</strong>, select ‚ÄúConfigure WinRM‚Äù, and on the next screen enter ‚ÄúShared IP address‚Äù as the hostname box and click ‚ÄúAdd‚Äù.</p><p><strong>Note</strong>: if when the VM runs the artifacts can‚Äôt be installed check whether the <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/agent-windows?WT.mc_id=BA-MVP-5003976#manual-installation">Azure VM Agent</a> is installed on the base VHD. Thanks to Joris for pointing this out!</p><h4 id=0451-httpsaristeinfoenmsdyn365-azure-devops-almconfigure-azure-devops-agent-serviceconfigure-azure-devops-agent-service>0.4.5.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#configure-azure-devops-agent-service></a>Configure Azure DevOps Agent Service<a hidden class=anchor aria-hidden=true href=#0451-httpsaristeinfoenmsdyn365-azure-devops-almconfigure-azure-devops-agent-serviceconfigure-azure-devops-agent-service>#</a></h4><h5 id=04511-httpsaristeinfoenmsdyn365-azure-devops-almoption-a-use-an-artifactoption-a-use-an-artifact>0.4.5.1.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#option-a-use-an-artifact></a>Option A: use an artifact<a hidden class=anchor aria-hidden=true href=#04511-httpsaristeinfoenmsdyn365-azure-devops-almoption-a-use-an-artifactoption-a-use-an-artifact>#</a></h5><p><strong>Update</strong>: thanks to <strong><a href=https://ariste.info/en/2021/02/azure-devtest-labs-build-dynamics-365-fno/#comment-7107>Florian Hopfner</a></strong> for reminding me this because I forgot‚Ä¶ If you choose Option A to install the agent service you need to do some things first!</p><p>The first thing we need to do is running some PowerShell scripts that create registry entries and environment variables in the VM, go to C:\DynamicsSDK and run these:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=nb>Import-Module</span> <span class=p>$(</span><span class=nb>Join-Path</span> <span class=p>\</span><span class=n>-Path</span> <span class=s2>&#34;C:\\DynamicsSDK&#34;</span> <span class=p>\</span><span class=n>-ChildPath</span> <span class=s2>&#34;DynamicsSDKCommon.psm1&#34;</span><span class=p>)</span> <span class=p>\</span><span class=n>-Function</span> <span class=s2>&#34;Write-Message&#34;</span><span class=p>,</span> <span class=s2>&#34;Set-AX7SdkRegistryValues&#34;</span><span class=p>,</span> <span class=s2>&#34;Set-AX7SdkEnvironmentVariables&#34;</span>

<span class=n>Set</span><span class=p>\</span><span class=n>-AX7SdkEnvironmentVariables</span> <span class=p>\</span><span class=n>-DynamicsSDK</span> <span class=s2>&#34;C:\\DynamicsSDK&#34;</span>

<span class=n>Set</span><span class=p>\</span><span class=n>-AX7SdkRegistryValues</span> <span class=p>\</span><span class=n>-DynamicsSDK</span> <span class=s2>&#34;c:\\DynamicsSDK&#34;</span> <span class=p>\</span><span class=n>-TeamFoundationServerUrl</span> <span class=s2>&#34;https://dev.azure.com/YOUR\_ORG&#34;</span> <span class=p>\</span><span class=n>-AosWebsiteName</span> <span class=nv>$AosWebsiteName</span> <span class=s2>&#34;AosService&#34;</span>
</code></pre></td></tr></table></div></div><p>The first one will load the functions and make them available in the command-line and the other two create the registry entries and environment variables.</p><p>Now we need to <strong>add an artifact for the Azure DevOps agent service</strong>. This will configure the agent service on the VM each time the VM is deployed. Search for ‚ÄúAzure Pipelines Agent‚Äù and click it. You will see this:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2021/01/DevTest1-311x1024.png.webp alt="DevTest Labs Azure DevOps Agent" title="MSDyn365 & Azure DevOps ALM 50"></p><p>DevTest Labs Azure DevOps Agent</p><p>We need to fill some information:</p><p>On ‚Äú<strong>Azure DevOps Organization Name</strong>‚Äù you need to provide the name of your organization. For example if your AZDO URL is <a href=https://dev.azure.com/blackbeltcorp>https://dev.azure.com/blackbeltcorp</a> you need to use blackbeltcorp.</p><p>On ‚Äú<strong>AZDO Personal Access Token</strong>‚Äù you need to provide a token generated from AZDO.</p><p>On ‚Äú<strong>Agent Name</strong>‚Äù give your agent a name, like DevTestAgent. And on ‚ÄúAgent Pool‚Äù a name for your pool, a new like DevTestPool or an existing one as Default.</p><p>On ‚Äú<strong>Account Name</strong>‚Äù use the same user that we‚Äôll use in our pipeline later. Remember this. And on ‚Äú<strong>Account Password</strong>‚Äù its password. Using secrets with a KeyVault is better, but I won‚Äôt explain this here.</p><p>And, finally, set ‚Äú<strong>Replace Agent</strong>‚Äù to true.</p><h5 id=04512-httpsaristeinfoenmsdyn365-azure-devops-almoption-b-configure-azure-devops-agent-in-the-vmoption-b-configure-azure-devops-agent-in-the-vm>0.4.5.1.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#option-b-configure-azure-devops-agent-in-the-vm></a>Option B: Configure Azure DevOps Agent in the VM<a hidden class=anchor aria-hidden=true href=#04512-httpsaristeinfoenmsdyn365-azure-devops-almoption-b-configure-azure-devops-agent-in-the-vmoption-b-configure-azure-devops-agent-in-the-vm>#</a></h5><p>To do this you have to create a VM from the base image you created before and then go to C:\DynamicsSDK and run the SetupBuildAgent script with the needed parameters:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=n>SetupBuildAgent</span><span class=p>.</span><span class=n>ps1</span> <span class=p>\</span><span class=n>-VSO</span><span class=p>\</span><span class=n>_ProjectCollection</span> <span class=s2>&#34;https://dev.azure.com/YOUR\_ORG&#34;</span> <span class=p>\</span><span class=n>-ServiceAccountName</span> <span class=s2>&#34;myUser&#34;</span> <span class=p>\</span><span class=n>-ServiceAccountPassword</span> <span class=s2>&#34;mYPassword&#34;</span> <span class=p>\</span><span class=n>-AgentName</span> <span class=s2>&#34;DevTestAgent&#34;</span> <span class=p>\</span><span class=n>-AgentPoolName</span> <span class=s2>&#34;DevTestPool&#34;</span> <span class=p>\</span><span class=n>-VSOAccessToken</span> <span class=s2>&#34;YOUR\_VSTS\_TOKEN&#34;</span>
</code></pre></td></tr></table></div></div><p><strong>WARNING</strong>: If you choose option B you must create a new base image from the VM where you‚Äôve run the script. Then repeat the WinRM steps to generate the new ARM template which we‚Äôll see next.</p><h4 id=0452-httpsaristeinfoenmsdyn365-azure-devops-almarm-templatearm-template>0.4.5.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#arm-template></a>ARM template<a hidden class=anchor aria-hidden=true href=#0452-httpsaristeinfoenmsdyn365-azure-devops-almarm-templatearm-template>#</a></h4><p>Then go to the ‚ÄúAdvanced Settings‚Äù tab and click the ‚Äú<strong>View ARM template</strong>‚Äù button:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/12/DevTest6.png.webp alt="Get the ARM template" title="MSDyn365 & Azure DevOps ALM 51"></p><p>Get the ARM template</p><p>This will display the ARM template to create the VM from our pipeline. It‚Äôs something like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span><span class=lnt>344
</span><span class=lnt>345
</span><span class=lnt>346
</span><span class=lnt>347
</span><span class=lnt>348
</span><span class=lnt>349
</span><span class=lnt>350
</span><span class=lnt>351
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>

 <span class=nt>&#34;$schema&#34;</span><span class=p>:</span> <span class=s2>&#34;https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json&#34;</span><span class=p>,</span>

 <span class=nt>&#34;contentVersion&#34;</span><span class=p>:</span> <span class=s2>&#34;1.0.0.0&#34;</span><span class=p>,</span>

 <span class=nt>&#34;parameters&#34;</span><span class=p>:</span> <span class=p>{</span>

 <span class=nt>&#34;newVMName&#34;</span><span class=p>:</span> <span class=p>{</span>

 <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>

 <span class=nt>&#34;defaultValue&#34;</span><span class=p>:</span> <span class=s2>&#34;aariste001&#34;</span>

 <span class=p>},</span>

 <span class=nt>&#34;labName&#34;</span><span class=p>:</span> <span class=p>{</span>

 <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>

 <span class=nt>&#34;defaultValue&#34;</span><span class=p>:</span> <span class=s2>&#34;aristeinfo&#34;</span>

 <span class=p>},</span>

 <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=p>{</span>

 <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>

 <span class=nt>&#34;defaultValue&#34;</span><span class=p>:</span> <span class=s2>&#34;Standard\_B4ms&#34;</span>

 <span class=p>},</span>

 <span class=nt>&#34;userName&#34;</span><span class=p>:</span> <span class=p>{</span>

 <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>

 <span class=nt>&#34;defaultValue&#34;</span><span class=p>:</span> <span class=s2>&#34;myUser&#34;</span>

 <span class=p>},</span>

 <span class=nt>&#34;password&#34;</span><span class=p>:</span> <span class=p>{</span>

 <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;securestring&#34;</span><span class=p>,</span>

 <span class=nt>&#34;defaultValue&#34;</span><span class=p>:</span> <span class=s2>&#34;\[\[\[VmPassword\]\]&#34;</span>

 <span class=p>},</span>

 <span class=nt>&#34;Configure\_WinRM\_hostName&#34;</span><span class=p>:</span> <span class=p>{</span>

 <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>

 <span class=nt>&#34;defaultValue&#34;</span><span class=p>:</span> <span class=s2>&#34;Public IP address&#34;</span>

 <span class=p>},</span>

 <span class=nt>&#34;Azure\_Pipelines\_Agent\_vstsAccount&#34;</span><span class=p>:</span> <span class=p>{</span>

 <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>

 <span class=nt>&#34;defaultValue&#34;</span><span class=p>:</span> <span class=s2>&#34;ariste&#34;</span>

 <span class=p>},</span>

 <span class=nt>&#34;Azure\_Pipelines\_Agent\_vstsPassword&#34;</span><span class=p>:</span> <span class=p>{</span>

 <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;securestring&#34;</span>

 <span class=p>},</span>

 <span class=nt>&#34;Azure\_Pipelines\_Agent\_agentName&#34;</span><span class=p>:</span> <span class=p>{</span>

 <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>

 <span class=nt>&#34;defaultValue&#34;</span><span class=p>:</span> <span class=s2>&#34;DevTestAgent&#34;</span>

 <span class=p>},</span>

 <span class=nt>&#34;Azure\_Pipelines\_Agent\_agentNameSuffix&#34;</span><span class=p>:</span> <span class=p>{</span>

 <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>

 <span class=nt>&#34;defaultValue&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>

 <span class=p>},</span>

 <span class=nt>&#34;Azure\_Pipelines\_Agent\_poolName&#34;</span><span class=p>:</span> <span class=p>{</span>

 <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>

 <span class=nt>&#34;defaultValue&#34;</span><span class=p>:</span> <span class=s2>&#34;DevTestPool&#34;</span>

 <span class=p>},</span>

 <span class=nt>&#34;Azure\_Pipelines\_Agent\_RunAsAutoLogon&#34;</span><span class=p>:</span> <span class=p>{</span>

 <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;bool&#34;</span><span class=p>,</span>

 <span class=nt>&#34;defaultValue&#34;</span><span class=p>:</span> <span class=kc>false</span>

 <span class=p>},</span>

 <span class=nt>&#34;Azure\_Pipelines\_Agent\_windowsLogonAccount&#34;</span><span class=p>:</span> <span class=p>{</span>

 <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>

 <span class=nt>&#34;defaultValue&#34;</span><span class=p>:</span> <span class=s2>&#34;aariste&#34;</span>

 <span class=p>},</span>

 <span class=nt>&#34;Azure\_Pipelines\_Agent\_windowsLogonPassword&#34;</span><span class=p>:</span> <span class=p>{</span>

 <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;securestring&#34;</span>

 <span class=p>},</span>

 <span class=nt>&#34;Azure\_Pipelines\_Agent\_driveLetter&#34;</span><span class=p>:</span> <span class=p>{</span>

 <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>

 <span class=nt>&#34;defaultValue&#34;</span><span class=p>:</span> <span class=s2>&#34;C&#34;</span>

 <span class=p>},</span>

 <span class=nt>&#34;Azure\_Pipelines\_Agent\_workDirectory&#34;</span><span class=p>:</span> <span class=p>{</span>

 <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>

 <span class=nt>&#34;defaultValue&#34;</span><span class=p>:</span> <span class=s2>&#34;DevTestAgent&#34;</span>

 <span class=p>},</span>

 <span class=nt>&#34;Azure\_Pipelines\_Agent\_replaceAgent&#34;</span><span class=p>:</span> <span class=p>{</span>

 <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;bool&#34;</span><span class=p>,</span>

 <span class=nt>&#34;defaultValue&#34;</span><span class=p>:</span> <span class=kc>true</span>

 <span class=p>}</span>

 <span class=p>},</span>

 <span class=nt>&#34;variables&#34;</span><span class=p>:</span> <span class=p>{</span>

 <span class=nt>&#34;labSubnetName&#34;</span><span class=p>:</span> <span class=s2>&#34;\[concat(variables(&#39;labVirtualNetworkName&#39;), &#39;Subnet&#39;)\]&#34;</span><span class=p>,</span>

 <span class=nt>&#34;labVirtualNetworkId&#34;</span><span class=p>:</span> <span class=s2>&#34;\[resourceId(&#39;Microsoft.DevTestLab/labs/virtualnetworks&#39;, parameters(&#39;labName&#39;), variables(&#39;labVirtualNetworkName&#39;))\]&#34;</span><span class=p>,</span>

 <span class=nt>&#34;labVirtualNetworkName&#34;</span><span class=p>:</span> <span class=s2>&#34;\[concat(&#39;Dtl&#39;, parameters(&#39;labName&#39;))\]&#34;</span><span class=p>,</span>

 <span class=nt>&#34;vmId&#34;</span><span class=p>:</span> <span class=s2>&#34;\[resourceId (&#39;Microsoft.DevTestLab/labs/virtualmachines&#39;, parameters(&#39;labName&#39;), parameters(&#39;newVMName&#39;))\]&#34;</span><span class=p>,</span>

 <span class=nt>&#34;vmName&#34;</span><span class=p>:</span> <span class=s2>&#34;\[concat(parameters(&#39;labName&#39;), &#39;/&#39;, parameters(&#39;newVMName&#39;))\]&#34;</span>

 <span class=p>},</span>

 <span class=nt>&#34;resources&#34;</span><span class=p>:</span> <span class=err>\</span><span class=p>[</span>

 <span class=p>{</span>

 <span class=nt>&#34;apiVersion&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-10-15-preview&#34;</span><span class=p>,</span>

 <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;Microsoft.DevTestLab/labs/virtualmachines&#34;</span><span class=p>,</span>

 <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;\[variables(&#39;vmName&#39;)\]&#34;</span><span class=p>,</span>

 <span class=nt>&#34;location&#34;</span><span class=p>:</span> <span class=s2>&#34;\[resourceGroup().location\]&#34;</span><span class=p>,</span>

 <span class=nt>&#34;properties&#34;</span><span class=p>:</span> <span class=p>{</span>

 <span class=nt>&#34;labVirtualNetworkId&#34;</span><span class=p>:</span> <span class=s2>&#34;\[variables(&#39;labVirtualNetworkId&#39;)\]&#34;</span><span class=p>,</span>

 <span class=nt>&#34;notes&#34;</span><span class=p>:</span> <span class=s2>&#34;Dynamics365FnO10013AgentLessV2&#34;</span><span class=p>,</span>

 <span class=nt>&#34;customImageId&#34;</span><span class=p>:</span> <span class=s2>&#34;/subscriptions/6715778f-c852-453d-b6bb-907ac34f280f/resourcegroups/devtestlabs365/providers/microsoft.devtestlab/labs/devtestd365/customimages/dynamics365fno10013agentlessv2&#34;</span><span class=p>,</span>

 <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=s2>&#34;\[parameters(&#39;size&#39;)\]&#34;</span><span class=p>,</span>

 <span class=nt>&#34;userName&#34;</span><span class=p>:</span> <span class=s2>&#34;\[parameters(&#39;userName&#39;)\]&#34;</span><span class=p>,</span>

 <span class=nt>&#34;password&#34;</span><span class=p>:</span> <span class=s2>&#34;\[parameters(&#39;password&#39;)\]&#34;</span><span class=p>,</span>

 <span class=nt>&#34;isAuthenticationWithSshKey&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>

 <span class=nt>&#34;artifacts&#34;</span><span class=p>:</span> <span class=err>\</span><span class=p>[</span>

 <span class=p>{</span>

 <span class=nt>&#34;artifactId&#34;</span><span class=p>:</span> <span class=s2>&#34;\[resourceId(&#39;Microsoft.DevTestLab/labs/artifactSources/artifacts&#39;, parameters(&#39;labName&#39;), &#39;public repo&#39;, &#39;windows-winrm&#39;)\]&#34;</span><span class=p>,</span>

 <span class=nt>&#34;parameters&#34;</span><span class=p>:</span> <span class=err>\</span><span class=p>[</span>

 <span class=p>{</span>

 <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;hostName&#34;</span><span class=p>,</span>

 <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;\[parameters(&#39;Configure\_WinRM\_hostName&#39;)\]&#34;</span>

 <span class=p>}</span>

 <span class=err>\</span><span class=p>]</span>

 <span class=p>},</span>

 <span class=p>{</span>

 <span class=nt>&#34;artifactId&#34;</span><span class=p>:</span> <span class=s2>&#34;\[resourceId(&#39;Microsoft.DevTestLab/labs/artifactSources/artifacts&#39;, parameters(&#39;labName&#39;), &#39;public repo&#39;, &#39;windows-vsts-build-agent&#39;)\]&#34;</span><span class=p>,</span>

 <span class=nt>&#34;parameters&#34;</span><span class=p>:</span> <span class=err>\</span><span class=p>[</span>

 <span class=p>{</span>

 <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;vstsAccount&#34;</span><span class=p>,</span>

 <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;\[parameters(&#39;Azure\_Pipelines\_Agent\_vstsAccount&#39;)\]&#34;</span>

 <span class=p>},</span>

 <span class=p>{</span>

 <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;vstsPassword&#34;</span><span class=p>,</span>

 <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;\[parameters(&#39;Azure\_Pipelines\_Agent\_vstsPassword&#39;)\]&#34;</span>

 <span class=p>},</span>

 <span class=p>{</span>

 <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;agentName&#34;</span><span class=p>,</span>

 <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;\[parameters(&#39;Azure\_Pipelines\_Agent\_agentName&#39;)\]&#34;</span>

 <span class=p>},</span>

 <span class=p>{</span>

 <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;agentNameSuffix&#34;</span><span class=p>,</span>

 <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;\[parameters(&#39;Azure\_Pipelines\_Agent\_agentNameSuffix&#39;)\]&#34;</span>

 <span class=p>},</span>

 <span class=p>{</span>

 <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;poolName&#34;</span><span class=p>,</span>

 <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;\[parameters(&#39;Azure\_Pipelines\_Agent\_poolName&#39;)\]&#34;</span>

 <span class=p>},</span>

 <span class=p>{</span>

 <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;RunAsAutoLogon&#34;</span><span class=p>,</span>

 <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;\[parameters(&#39;Azure\_Pipelines\_Agent\_RunAsAutoLogon&#39;)\]&#34;</span>

 <span class=p>},</span>

 <span class=p>{</span>

 <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;windowsLogonAccount&#34;</span><span class=p>,</span>

 <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;\[parameters(&#39;Azure\_Pipelines\_Agent\_windowsLogonAccount&#39;)\]&#34;</span>

 <span class=p>},</span>

 <span class=p>{</span>

 <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;windowsLogonPassword&#34;</span><span class=p>,</span>

 <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;\[parameters(&#39;Azure\_Pipelines\_Agent\_windowsLogonPassword&#39;)\]&#34;</span>

 <span class=p>},</span>

 <span class=p>{</span>

 <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;driveLetter&#34;</span><span class=p>,</span>

 <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;\[parameters(&#39;Azure\_Pipelines\_Agent\_driveLetter&#39;)\]&#34;</span>

 <span class=p>},</span>

 <span class=p>{</span>

 <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;workDirectory&#34;</span><span class=p>,</span>

 <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;\[parameters(&#39;Azure\_Pipelines\_Agent\_workDirectory&#39;)\]&#34;</span>

 <span class=p>},</span>

 <span class=p>{</span>

 <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;replaceAgent&#34;</span><span class=p>,</span>

 <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;\[parameters(&#39;Azure\_Pipelines\_Agent\_replaceAgent&#39;)\]&#34;</span>

 <span class=p>}</span>

 <span class=err>\</span><span class=p>]</span>

 <span class=p>}</span>

 <span class=err>\</span><span class=p>],</span>

 <span class=nt>&#34;labSubnetName&#34;</span><span class=p>:</span> <span class=s2>&#34;\[variables(&#39;labSubnetName&#39;)\]&#34;</span><span class=p>,</span>

 <span class=nt>&#34;disallowPublicIpAddress&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>

 <span class=nt>&#34;storageType&#34;</span><span class=p>:</span> <span class=s2>&#34;Premium&#34;</span><span class=p>,</span>

 <span class=nt>&#34;allowClaim&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>

 <span class=nt>&#34;networkInterface&#34;</span><span class=p>:</span> <span class=p>{</span>

 <span class=nt>&#34;sharedPublicIpAddressConfiguration&#34;</span><span class=p>:</span> <span class=p>{</span>

 <span class=nt>&#34;inboundNatRules&#34;</span><span class=p>:</span> <span class=err>\</span><span class=p>[</span>

 <span class=p>{</span>

 <span class=nt>&#34;transportProtocol&#34;</span><span class=p>:</span> <span class=s2>&#34;tcp&#34;</span><span class=p>,</span>

 <span class=nt>&#34;backendPort&#34;</span><span class=p>:</span> <span class=mi>3389</span>

 <span class=p>}</span>

 <span class=err>\</span><span class=p>]</span>

 <span class=p>}</span>

 <span class=p>}</span>

 <span class=p>}</span>

 <span class=p>}</span>

 <span class=err>\</span><span class=p>],</span>

 <span class=nt>&#34;outputs&#34;</span><span class=p>:</span> <span class=p>{</span>

 <span class=nt>&#34;labVMId&#34;</span><span class=p>:</span> <span class=p>{</span>

 <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>

 <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;\[variables(&#39;vmId&#39;)\]&#34;</span>

 <span class=p>}</span>

 <span class=p>}</span>

<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>NOTE</strong>: if you‚Äôre using option B you won‚Äôt have the artifact node for the VSTS agent.</p><p>This JSON file will be used as the base to create our VMs from the Azure DevOps pipeline. This is known as <a href="https://docs.microsoft.com/en-us/azure/devops/learn/what-is-infrastructure-as-code?WT.mc_id=BA-MVP-5003976">Infrastructure as Code</a> (IaC) and it‚Äôs a way of defining our infrastructure in a file as it were code. It‚Äôs another part of the DevOps practice that should solve the ‚Äúit works on my machine‚Äù issue.</p><p>If we take a look to the JSON‚Äôs parameters node there‚Äôs the following information:</p><ul><li>newVMName and labName will be the name of the VM and the DevTest Labs lab we‚Äôre using. The VM name is not really important because we‚Äôll set the name later in the pipeline.</li><li>size is the VM size, a D3 V2 in the example above, but we can change it and will do it later.</li><li>userName & passWord will be the credentials to access the VM and must be the same we‚Äôve used to configure the Azure DevOps agent.</li><li>Configure_WinRM_hostName is the artifact we added to the VM template that will allow the pipelines to run in this machine.</li></ul><p>To do it faster and for demo purposes I‚Äôm using a plain text password in the ARM template, changing the password node to something like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-json data-lang=json><span class=s2>&#34;password&#34;</span><span class=err>:</span> <span class=p>{</span>
 <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>
 <span class=nt>&#34;defaultValue&#34;</span><span class=p>:</span> <span class=s2>&#34;yourPassword&#34;</span>
 <span class=p>}</span><span class=err>,</span>
</code></pre></td></tr></table></div></div><p>I will do the same with all the <em>secureString</em> nodes, but you shouldn‚Äôt and should instead use an Azure KeyVault which comes with the DevTest Labs account.</p><p>Of course <strong>you would never upload this template to Azure DevOps with a password in plain text</strong>. There‚Äôs plenty of resources online that teach how to use parameters, Azure KeyVault, etc. to accomplish this, for example this one: <a href=https://devkimchi.com/2019/04/24/6-ways-passing-secrets-to-arm-templates/>6 Ways Passing Secrets to ARM Templates</a>.</p><p>OK, now grab that file and save it to your Azure DevOps repo. I‚Äôve created a folder in my repo‚Äôs root called ARM where I‚Äôm saving all the ARM templates:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2021/01/DevTestLabs2.png.webp alt="ARM templates on Azure DevOps" title="MSDyn365 & Azure DevOps ALM 52"></p><p>ARM templates on Azure DevOps</p><h3 id=046-httpsaristeinfoenmsdyn365-azure-devops-almpreparing-the-vmpreparing-the-vm>0.4.6. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#preparing-the-vm></a>Preparing the VM<a hidden class=anchor aria-hidden=true href=#046-httpsaristeinfoenmsdyn365-azure-devops-almpreparing-the-vmpreparing-the-vm>#</a></h3><p>The VHD image you download can be used as a developer VM with no additional work, just run Visual Studio, connect it to your AZDO project and done. But if you want to use it as a build box you need to do several things first.</p><p>Remember that the default user and password for these VHDs are Administrator and Pass@word1.</p><h4 id=0461-httpsaristeinfoenmsdyn365-azure-devops-almdisable-servicesdisable-services>0.4.6.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#disable-services></a>Disable services<a hidden class=anchor aria-hidden=true href=#0461-httpsaristeinfoenmsdyn365-azure-devops-almdisable-servicesdisable-services>#</a></h4><p>First of all we will stop and disable services like the Batch, Management Reporter, SSAS, SSIS, etc. Anything you see that‚Äôs not needed to run a build.</p><h4 id=0462-httpsaristeinfoenmsdyn365-azure-devops-almcreate-a-new-sql-usercreate-a-new-sql-user>0.4.6.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#create-a-new-sql-user></a>Create a new SQL user<a hidden class=anchor aria-hidden=true href=#0462-httpsaristeinfoenmsdyn365-azure-devops-almcreate-a-new-sql-usercreate-a-new-sql-user>#</a></h4><p>Open <a href="https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver15&WT.mc_id=BA-MVP-5003976">SSMS</a> (as an Administrator) and create a new SQL user as a copy of the axdbadmin one. Then open the web.config file and update the DB user and password to use the one you‚Äôve just created.</p><h4 id=0463-httpsaristeinfoenmsdyn365-azure-devops-almprepare-ssrs-optionalprepare-ssrs-optional>0.4.6.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#prepare-ssrs-optional></a>Prepare SSRS (optional)<a hidden class=anchor aria-hidden=true href=#0463-httpsaristeinfoenmsdyn365-azure-devops-almprepare-ssrs-optionalprepare-ssrs-optional>#</a></h4><p>If you want to deploy reports as part of your build pipeline you need to go to SSMS again (and as an Admin again), and open a new query in the reporting DB to execute the following query:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sql data-lang=sql><span class=k>exec</span><span class=w> </span><span class=n>DeleteEncryptedContent</span><span class=w>
</span></code></pre></td></tr></table></div></div><h4 id=0464-httpsaristeinfoenmsdyn365-azure-devops-almpowershell-scriptspowershell-scripts>0.4.6.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#powershell-scripts></a>PowerShell Scripts<a hidden class=anchor aria-hidden=true href=#0464-httpsaristeinfoenmsdyn365-azure-devops-almpowershell-scriptspowershell-scripts>#</a></h4><p>The default build definition that runs on a build VM uses several PowerShell scripts to run some tasks. I‚Äôm adding an additional script called PrepareForAgent.</p><p>The scripts can be found in the C:\DynamicsSDK folder of the VM.</p><h5 id=04641-httpsaristeinfoenmsdyn365-azure-devops-almprepareforbuildprepareforbuild>0.4.6.4.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#prepareforbuild></a>PrepareForBuild<a hidden class=anchor aria-hidden=true href=#04641-httpsaristeinfoenmsdyn365-azure-devops-almprepareforbuildprepareforbuild>#</a></h5><p>This script comes with the VM and <strong>we need to modify it</strong> to avoid one thing: the PackagesLocalDirectory backup which is usually done in the first build. We need to get rid of this or we‚Äôll waste around an hour per run until the files are copied.</p><p>We don‚Äôt need this because our VM will be new each time we run the pipeline!</p><p>So open the script, go to line 696 and look for this piece of code:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-PowerShell data-lang=PowerShell><span class=c># Create packages backup (if it does not exist).</span>

<span class=nv>$NewBackupCreated</span> <span class=p>\=</span> <span class=nb>Backup-AX7Packages</span> <span class=p>\</span><span class=n>-BackupPath</span> <span class=nv>$PackagesBackupPath</span> <span class=p>\</span><span class=n>-DeploymentPackagesPath</span> <span class=nv>$DeploymentPackagesPath</span> <span class=p>\</span><span class=n>-LogLocation</span> <span class=nv>$LogLocation</span>

<span class=c># Restore packages backup (unless a new backup was just created).</span>

<span class=k>if</span> <span class=p>(!</span><span class=nv>$NewBackupCreated</span><span class=p>)</span>

<span class=p>{</span>

 <span class=nb>Restore-AX7Packages</span> <span class=p>\</span><span class=n>-BackupPath</span> <span class=nv>$PackagesBackupPath</span> <span class=p>\</span><span class=n>-DeploymentPackagesPath</span> <span class=nv>$DeploymentPackagesPath</span> <span class=p>\</span><span class=n>-LogLocation</span> <span class=nv>$LogLocation</span> <span class=p>\</span><span class=n>-RestoreAllFiles</span><span class=err>:</span><span class=nv>$RestorePackagesAllFiles</span>

<span class=p>}</span>

<span class=k>if</span> <span class=p>(!</span><span class=nv>$DatabaseBackupToRestore</span><span class=p>)</span>

<span class=p>{</span>
 <span class=nv>$DatabaseBackupPath</span> <span class=p>\=</span> <span class=nb>Get-BackupPath</span> <span class=p>\</span><span class=n>-Purpose</span> <span class=s2>&#34;Databases&#34;</span>
 <span class=nb>Backup-AX7Database</span> <span class=p>\</span><span class=n>-BackupPath</span> <span class=nv>$DatabaseBackupPath</span>
<span class=p>}</span>
<span class=k>else</span>
<span class=p>{</span>
 <span class=c># Restore a database backup (if specified).</span>
 <span class=nb>Restore-AX7Database</span> <span class=p>\</span><span class=n>-DatabaseBackupToRestore</span> <span class=nv>$DatabaseBackupToRestore</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>We need to modify it until we end up with this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-PowerShell data-lang=PowerShell><span class=k>if</span> <span class=p>(</span><span class=nv>$DatabaseBackupToRestore</span><span class=p>)</span>
<span class=p>{</span>
 <span class=nb>Restore-AX7Database</span> <span class=p>\</span><span class=n>-DatabaseBackupToRestore</span> <span class=nv>$DatabaseBackupToRestore</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>We just need the DB restore part and skip the backup, otherwise we‚Äôll be losing 45 minutes in each run for something we don‚Äôt need because the VM will be deleted when the build is completed.</p><h4 id=0465-httpsaristeinfoenmsdyn365-azure-devops-almoptional-but-recommended-install-d365fo-toolsoptional-but-recommended-install-d365fotoolshttpsgithubcomd365collaboratived365fotools>0.4.6.5. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#optional-but-recommended-install-d365fo-tools></a><strong>Optional (but recommended)</strong>: install <a href=https://github.com/d365collaborative/d365fo.tools>d365fo.tools</a><a hidden class=anchor aria-hidden=true href=#0465-httpsaristeinfoenmsdyn365-azure-devops-almoptional-but-recommended-install-d365fo-toolsoptional-but-recommended-install-d365fotoolshttpsgithubcomd365collaboratived365fotools>#</a></h4><p>Just run this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-PowerShell data-lang=PowerShell><span class=nb>Install-Module</span> <span class=n>-Name</span> <span class=n>d365fo</span><span class=p>.</span><span class=n>tools</span>
</code></pre></td></tr></table></div></div><p>We can use the tools to do a module sync, partial sync or deploy just our reports instead of all.</p><h3 id=047-httpsaristeinfoenmsdyn365-azure-devops-almcreate-a-new-imagecreate-a-new-image>0.4.7. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#create-a-new-image></a>Create a new image<a hidden class=anchor aria-hidden=true href=#047-httpsaristeinfoenmsdyn365-azure-devops-almcreate-a-new-imagecreate-a-new-image>#</a></h3><p>Once we‚Äôve done all these prepare steps we can log out of this VM and stop it. <strong>Do not delete it yet!</strong> Go to ‚ÄúCreate custom image‚Äù, give the new image a name, select ‚ÄúI have not generalized this virtual machine‚Äù and click the ‚ÄúOK‚Äù button.</p><p>This will generate a new image that you can use as a base image with all the changes you‚Äôve done to the original VHD.</p><h3 id=048-httpsaristeinfoenmsdyn365-azure-devops-almazure-devops-pipelinesazure-devops-pipelines>0.4.8. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#azure-devops-pipelines></a>Azure DevOps Pipelines<a hidden class=anchor aria-hidden=true href=#048-httpsaristeinfoenmsdyn365-azure-devops-almazure-devops-pipelinesazure-devops-pipelines>#</a></h3><p>We‚Äôre ready to setup our new build pipeline in Azure DevOps. This pipeline will consist of three steps: create a new VM, run all the build steps, and delete the VM:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2021/01/DevTestLabs4.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 15" title="MSDyn365 & Azure DevOps ALM 53"></p><p>First of all check that your pipeline runs on Azure pipelines (aka Azure-hosted):</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2021/01/image-2.png.webp alt="DevTest Labs Azure Pipelines" title="MSDyn365 & Azure DevOps ALM 54"></p><p>DevTest Labs Azure Pipelines</p><p>The create and delete steps will run on the Azure Pipelines pool. The build step will run on our DevTestLabs pool, or the name you gave it when configuring the artifact on DevTest Labs or the script on the VM.</p><h4 id=0481-httpsaristeinfoenmsdyn365-azure-devops-almcreate-azure-devtest-labs-vmcreate-azure-devtest-labs-vm>0.4.8.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#create-azure-devtest-labs-vm></a>Create Azure DevTest Labs VM<a hidden class=anchor aria-hidden=true href=#0481-httpsaristeinfoenmsdyn365-azure-devops-almcreate-azure-devtest-labs-vmcreate-azure-devtest-labs-vm>#</a></h4><p>Create a new pipeline and choose the ‚ÄúUse the classic editor‚Äù option. Make sure you‚Äôve selected TFVC as your source and click ‚ÄúContinue‚Äù and ‚ÄúEmpty job‚Äù. Add a new task to the pipeline, look for ‚ÄúAzure DevTest Labs Create VM‚Äù. We just need to fill in the missing parameters with our subscription, lab, etc.</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2021/01/DevTestLabs5.png.webp alt="Create VM Azure DevTest Labs" title="MSDyn365 & Azure DevOps ALM 55"></p><p>Create VM Azure DevTest Labs</p><p>Remember this step must run on the Azure-hosted pipeline.</p><h4 id=0482-httpsaristeinfoenmsdyn365-azure-devops-almbuildbuild>0.4.8.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#build></a>Build<a hidden class=anchor aria-hidden=true href=#0482-httpsaristeinfoenmsdyn365-azure-devops-almbuildbuild>#</a></h4><p>This is an easy one. Just export a working pipeline and import it. And this step needs to run on your self-hosted pool:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2021/01/image-3.png.webp alt="Runs on self-hosted pool" title="MSDyn365 & Azure DevOps ALM 56"></p><p>Runs on self-hosted pool</p><h5 id=04821-httpsaristeinfoenmsdyn365-azure-devops-almoptional-use-selectivesync-not-recommended-see-next-optionoptional-use-selectivesync-not-recommended-see-next-option>0.4.8.2.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#optional-use-selectivesync-not-recommended-see-next-option></a>Optional: use SelectiveSync (not recommended, see next option)<a hidden class=anchor aria-hidden=true href=#04821-httpsaristeinfoenmsdyn365-azure-devops-almoptional-use-selectivesync-not-recommended-see-next-optionoptional-use-selectivesync-not-recommended-see-next-option>#</a></h5><p>You can replace the Database Sync task for a PowerShell script that will only sync the tables in your models:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2021/01/image-9.png.webp alt=SelectiveSync.ps1 title="MSDyn365 & Azure DevOps ALM 57"></p><p>SelectiveSync.ps1</p><p>Thanks Joris for the tip!</p><h5 id=04822-httpsaristeinfoenmsdyn365-azure-devops-almoptional-use-d365fo-tools-to-sync-your-packages-modelsoptional-use-d365fotools-to-sync-your-packagesmodels>0.4.8.2.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#optional-use-d365fo-tools-to-sync-your-packages-models></a>Optional: use d365fo.tools to sync your packages/models<a hidden class=anchor aria-hidden=true href=#04822-httpsaristeinfoenmsdyn365-azure-devops-almoptional-use-d365fo-tools-to-sync-your-packages-modelsoptional-use-d365fotools-to-sync-your-packagesmodels>#</a></h5><p>This is a better option than the SelectiveSync above. You can synchronize your packages or models only to gain some time. This cmdlet uses sync.exe like Visual Studio does and should be better than SelectiveSync.</p><p>Add a new PowerShell task, select Inline Script and this is the command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-PowerShell data-lang=PowerShell><span class=nb>Invoke-D365DbSyncModule</span> <span class=n>-Module</span> <span class=s2>&#34;Module1&#34;</span><span class=p>,</span> <span class=s2>&#34;Module2&#34;</span> <span class=n>-ShowOriginalProgress</span> <span class=n>-Verbose</span>
</code></pre></td></tr></table></div></div><h5 id=04823-httpsaristeinfoenmsdyn365-azure-devops-almoptional-use-d365fo-tools-to-deploy-ssrs-reportsoptional-use-d365fotools-to-deploy-ssrs-reports>0.4.8.2.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#optional-use-d365fo-tools-to-deploy-ssrs-reports></a>Optional: use d365fo.tools to deploy SSRS reports<a hidden class=anchor aria-hidden=true href=#04823-httpsaristeinfoenmsdyn365-azure-devops-almoptional-use-d365fo-tools-to-deploy-ssrs-reportsoptional-use-d365fotools-to-deploy-ssrs-reports>#</a></h5><p>If you really want to add the report deployment step to your pipeline you can save some more extra time using <a href=https://github.com/d365collaborative/d365fo.tools>d365fo.tools</a> and just deploy the reports in your models like we‚Äôve done with the DB sync.</p><p>Run this in a new PowerShell task to do it:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-PowerShell data-lang=PowerShell><span class=nb>Publish-D365SsrsReport</span> <span class=n>-Module</span> <span class=n>YOUR</span><span class=p>\</span><span class=n>_MODULE</span> <span class=n>-ReportName</span> <span class=p>\*</span>
</code></pre></td></tr></table></div></div><h4 id=0483-httpsaristeinfoenmsdyn365-azure-devops-almdelete-azure-devtest-labs-vmdelete-azure-devtest-labs-vm>0.4.8.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#delete-azure-devtest-labs-vm></a>Delete Azure DevTest Labs VM<a hidden class=anchor aria-hidden=true href=#0483-httpsaristeinfoenmsdyn365-azure-devops-almdelete-azure-devtest-labs-vmdelete-azure-devtest-labs-vm>#</a></h4><p>It‚Äôs almost the same as the create step, complete the subscription, lab and VM fields and done:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2021/01/image.png.webp alt="Delete VM" title="MSDyn365 & Azure DevOps ALM 58"></p><p>Delete VM</p><p>And this step, like the create one, will run on the Azure-hosted agent.</p><h4 id=0484-httpsaristeinfoenmsdyn365-azure-devops-almdependencies-and-conditionsdependencies-and-conditions>0.4.8.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#dependencies-and-conditions></a>Dependencies and conditions<a hidden class=anchor aria-hidden=true href=#0484-httpsaristeinfoenmsdyn365-azure-devops-almdependencies-and-conditionsdependencies-and-conditions>#</a></h4><p>When all three steps are configured we need to add dependencies and conditions to some of them. For example, to make sure that the delete VM step runs when the build step fails, but it doesn‚Äôt when the create VM step fails.</p><h5 id=04841-httpsaristeinfoenmsdyn365-azure-devops-almbuildbuild>0.4.8.4.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#build></a>Build<a hidden class=anchor aria-hidden=true href=#04841-httpsaristeinfoenmsdyn365-azure-devops-almbuildbuild>#</a></h5><p>The build step depends on the create VM step, and will only run if the previous step succeeds:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2021/01/image-4.png.webp alt="Build step dependencies and conditions" title="MSDyn365 & Azure DevOps ALM 59"></p><p>Build step dependencies and conditions</p><h5 id=04842-httpsaristeinfoenmsdyn365-azure-devops-almdelete-vmdelete-vm>0.4.8.4.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#delete-vm></a>Delete VM<a hidden class=anchor aria-hidden=true href=#04842-httpsaristeinfoenmsdyn365-azure-devops-almdelete-vmdelete-vm>#</a></h5><p>The delete step depends on all previous steps and must run when the create VM step succeeds. If the create step fails there‚Äôs no VM and we don‚Äôt need to delete it:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2021/01/image-5.png.webp alt="Dependencies and conditions on delete VM step" title="MSDyn365 & Azure DevOps ALM 60"></p><p>Dependencies and conditions on delete VM step</p><p>This is the custom condition we‚Äôll use:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=n>and</span><span class=p>(</span><span class=n>always</span><span class=p>(),</span> <span class=n>eq</span><span class=p>(</span><span class=n>dependencies</span><span class=p>.</span><span class=n>Job</span><span class=err>\</span><span class=m>_1.</span><span class=n>status</span><span class=p>,</span> <span class=err>&#39;</span><span class=n>Succeeded</span><span class=err>&#39;</span><span class=p>))</span>
</code></pre></td></tr></table></div></div><p>If you need to know your first step‚Äôs job name just export the pipeline to YAML and you‚Äôll find it there:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2021/01/image-6.png.webp alt="Export pipeline to YAML" title="MSDyn365 & Azure DevOps ALM 61"></p><p>Export pipeline to YAML</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2021/01/image-7.png.webp alt="Job name on YAML" title="MSDyn365 & Azure DevOps ALM 62"></p><p>Job name on YAML</p><p>If this step fails when the pipeline is run, wait to delete the VM manually, first change the VM name in the delete step, save your pipeline and then use the dropdown to show the VMs in the selected subscription, and save the pipeline.</p><h3 id=049-httpsaristeinfoenmsdyn365-azure-devops-almrun-the-buildrun-the-build>0.4.9. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#run-the-build></a>Run the build<a hidden class=anchor aria-hidden=true href=#049-httpsaristeinfoenmsdyn365-azure-devops-almrun-the-buildrun-the-build>#</a></h3><p>And, I think, we‚Äôre done and ready to run our Azure DevTest Labs pipeline for Dynamics 365 Finance and Operations‚Ä¶ click ‚ÄúRun pipeline‚Äù and wait‚Ä¶</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2021/01/image-10-382x1024.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 16" title="MSDyn365 & Azure DevOps ALM 63"></p><p>Tadaaaa!!</p><h3 id=0410-httpsaristeinfoenmsdyn365-azure-devops-almtimestimes>0.4.10. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#times></a>Times<a hidden class=anchor aria-hidden=true href=#0410-httpsaristeinfoenmsdyn365-azure-devops-almtimestimes>#</a></h3><p>The pipeline from the image above is one with real code from a customer but I can‚Äôt compare the times with the Azure-hosted builds because there‚Äôs no sync, or tests there. Regarding the build time the Azure-hosted takes one minute less, but it needs to install the nugets first.</p><p>But for example this is a comparison I did:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2021/01/B2msVSB4ms.png.webp alt="Azure DevTest Labs B2ms vs B4ms" title="MSDyn365 & Azure DevOps ALM 64"></p><p>Azure DevTest Labs B2ms vs B4ms</p><p>It takes around 1 hour to create the VM, build, do a full DB synch, deploy reports, run tests, generate a Deployable Package and, finally, delete the VM:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2021/01/Full.jpg.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 17" title="MSDyn365 & Azure DevOps ALM 65"></p><p>If you skip deploying the SSRS reports your build will run in 15 minutes less, that‚Äôs around 45 minutes.</p><p>If you use the partial sync process instead of a full DB sync it‚Äôll be 5-7 minutes less.</p><p>This would leave us with a 35-40 minutes build.</p><h4 id=04101-httpsaristeinfoenmsdyn365-azure-devops-almcomparison-1comparison-1>0.4.10.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#comparison-1></a>Comparison 1<a hidden class=anchor aria-hidden=true href=#04101-httpsaristeinfoenmsdyn365-azure-devops-almcomparison-1comparison-1>#</a></h4><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2021/01/Dtcomp1.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 18" title="MSDyn365 & Azure DevOps ALM 66"></p><p>No DB Sync</p><p>The image above shows a simple package being compiled, without any table, so the selective sync goes really fast. The build times improve with VM size.</p><h4 id=04102-httpsaristeinfoenmsdyn365-azure-devops-almcomparison-2comparison-2>0.4.10.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#comparison-2></a>Comparison 2<a hidden class=anchor aria-hidden=true href=#04102-httpsaristeinfoenmsdyn365-azure-devops-almcomparison-2comparison-2>#</a></h4><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2021/01/Dtcomp2.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 19" title="MSDyn365 & Azure DevOps ALM 67"></p><p>Same code Full DB Sync</p><p>This one is compiling the same codebase but is doing a full DB sync. The sync time improves in the B4ms VM compared to the B2ms but it‚Äôs almost the same in the B8ms. Build times are better for larger VM sizes.</p><h4 id=04103-httpsaristeinfoenmsdyn365-azure-devops-almcomparison-3comparison-3>0.4.10.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#comparison-3></a>Comparison 3<a hidden class=anchor aria-hidden=true href=#04103-httpsaristeinfoenmsdyn365-azure-devops-almcomparison-3comparison-3>#</a></h4><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2021/01/image-14.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 20" title="MSDyn365 & Azure DevOps ALM 68"></p><p>Real code + full sync</p><p>And in the image above we see a more realistic build. The codebase is larger and we‚Äôre doing a full DB sync.</p><p>Similar as the comparison before there a good enhancement between a B2ms and a B4ms, but not between a B4ms and B8ms.</p><h3 id=0411-httpsaristeinfoenmsdyn365-azure-devops-almshow-me-the-moneyshow-me-the-money>0.4.11. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#show-me-the-money></a>Show me the money!<a hidden class=anchor aria-hidden=true href=#0411-httpsaristeinfoenmsdyn365-azure-devops-almshow-me-the-moneyshow-me-the-money>#</a></h3><p>I think this is the interesting comparison. How did a Tier-1 MS-hosted build VM cost? Around 400‚Ç¨? How does it compare to using the Azure DevTest Labs alternative?</p><p>There‚Äôs only one fix cost when using Azure DevTest Labs: the blob storage where the VHD is uploaded. The VHD‚Äôs size is around 130GB and this should have a cost of, more or less, 5 euros/month. Keep in mind that <strong>you need to clean up your custom images when yours is prepared</strong>, the new ones are created as snapshots and also take space in the storage account.</p><p>Then we have the variable costs that come with the deployment of a VM each build but it‚Äôs just <strong>absurd</strong>. Imagine we‚Äôre using a B4ms VM, with a 256GB Premium SSD disk, we would pay 0.18‚Ç¨/hour for the VM plus the proportional part of 35.26‚Ç¨/month of the SSD disk, which would be like 5 cents/hour?</p><p>But this can run on a B2ms VM too which is half the compute price of the VM, down to 9 cents per hour.</p><p>If we run this build once a day each month, 30 times, the cost of a B4ms would be like‚Ä¶ 7‚Ç¨? Add the blob storage and we‚Äôll be paying <strong>12‚Ç¨ per month to run our builds with DB sync and tests</strong>.</p><p>Is it cheaper than deploying a cloud-hosted environment, and starting and stopping it using <a href=https://github.com/d365collaborative/d365fo.tools>the new d365fo.tools Cmdlets</a> each time we run the build? <strong>Yes it is!</strong> Because if we deploy a CHE we‚Äôll be paying the price of the SSD disk for the whole month!</p><h3 id=0412-httpsaristeinfoenmsdyn365-azure-devops-almsome-final-remarkssome-final-remarks>0.4.12. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#some-final-remarks></a>Some final remarks<a hidden class=anchor aria-hidden=true href=#0412-httpsaristeinfoenmsdyn365-azure-devops-almsome-final-remarkssome-final-remarks>#</a></h3><ol><li>I have accomplished this <strong>mostly through trial-and-error</strong>. There‚Äôs lots of enhancements and best practices to be applied to all the process, specially using an <a href="https://docs.microsoft.com/en-us/azure/key-vault/general/overview?WT.mc_id=BA-MVP-5003976">Azure Key Vault</a> to store all the secrets to be used in the Azure DevOps Agent artifact and the pipeline.</li><li>This in another clear example that <a href=https://ariste.info/en/2019/07/do-you-want-to-become-a-better-x-developer/>X++ developers need to step outside of X++</a> and Dynamics 365 FnO. We‚Äôre not X++ only developers anymore, we‚Äôre very lucky to be working on a product that is using Azure.</li><li>I‚Äôm sure there‚Äôs scenarios where using DevTest Labs to create a build VM is useful. Maybe not for an implementation partner, but maybe it is for an ISV partner. It‚Äôs just an additional option.</li><li>The only bad thing to me is that we need to apply the version upgrades manually to the VHDs because they‚Äôre published only twice a year.</li><li>As I said at the beginning of the post, it may have worked to me with all these steps, but if you try you maybe need to change some things. But it‚Äôs a good way to start.</li></ol><h2 id=httpsaristeinfoenmsdyn365-azure-devops-almadd-and-build-net-projectsadd-and-build-net-projects><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#add-and-build-net-projects></a>Add and build .NET projects<a hidden class=anchor aria-hidden=true href=#httpsaristeinfoenmsdyn365-azure-devops-almadd-and-build-net-projectsadd-and-build-net-projects>#</a></h2><p>I bet that most of us have had to develop some .NET class library to solve something in Dynamics 365 Finance and Operations. You create a C# project, build it, and add the DLL as a reference in your FnO project. Don‚Äôt do that anymore! You can add the .NET project to source control, build it in your pipeline, and the DLL gets added to the deployable package!</p><p>I‚Äôve been trying this during the last days after a conversation on Yammer, and while I‚Äôve managed to build .NET and X++ code in the same pipeline, I‚Äôve found some issues or limitations.</p><h3 id=051-httpsaristeinfoenmsdyn365-azure-devops-almbuild-net-in-your-pipelinebuild-net-in-your-pipeline>0.5.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#build-net-in-your-pipeline></a>Build .NET in your pipeline<a hidden class=anchor aria-hidden=true href=#051-httpsaristeinfoenmsdyn365-azure-devops-almbuild-net-in-your-pipelinebuild-net-in-your-pipeline>#</a></h3><p><strong>Note</strong>: what I show in this post is done using the <a href=https://ariste.info/en/2020/05/azure-hosted-build-dynamics365-finance-scm/>Azure-hosted pipeline</a> but it should also be possible to do it using a self-hosted agent (aka old build VM).</p><p>The build step of the pipeline invokes <a href="https://docs.microsoft.com/en-us/visualstudio/msbuild/msbuild?view=vs-2019&WT.mc_id=DOP-MVP-5003976">msbuild.exe</a> which can build .NET code. If we check the logs of the build step we will see it:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/09/2020-09-29-13_03_44.png.webp alt="msbuild.exe builds C# projects and our X++ ones too!" title="MSDyn365 & Azure DevOps ALM 69"></p><p>msbuild.exe builds C# projects and our X++ ones too!</p><p>Remember that X++ is part of the .NET family after all‚Ä¶ a second cousin or something like it.</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/09/2020-09-29-13_21_54.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 21" title="MSDyn365 & Azure DevOps ALM 70"></p><p>Build folder</p><p>If you‚Äôve read the blog post about <a href=https://ariste.info/en/2020/05/azure-hosted-build-dynamics365-finance-scm/>Azure-hosted builds</a> you must‚Äôve seen I‚Äôm putting the solution that references all my models in a folder called Build at the root of my source control tree (left image).</p><p>That‚Äôs just a personal preference that helps me keep the .config files and the solution I use to build all the models in a single, separate place.</p><p>By using a solution and pointing the build process to use it I also keep control of what‚Äôs being built in a single place.</p><h3 id=052-httpsaristeinfoenmsdyn365-azure-devops-almadd-a-c-project-to-fnoadd-a-c-project-to-fno>0.5.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#add-a-c-project-to-fno></a>Add a C# project to FnO<a hidden class=anchor aria-hidden=true href=#052-httpsaristeinfoenmsdyn365-azure-devops-almadd-a-c-project-to-fnoadd-a-c-project-to-fno>#</a></h3><p>Our first step will usually be creating a Finance and Operations project. Once it‚Äôs created we right-click on the solution and select ‚ÄúAdd new project‚Äù. Then we select a Visual C# Class Library project:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/09/2020-09-30-12_51_37.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 22" title="MSDyn365 & Azure DevOps ALM 71"></p><p>C# project in Dynamics 365</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/09/2020-09-30-12_54_25.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 23" title="MSDyn365 & Azure DevOps ALM 72"></p><p>Now we should have a solution with a FnO Project and a C# project (right image).</p><p>To demo this I‚Äôll create a class called Calculator with a single method that accepts two decimal values as parameters and returns it‚Äôs sum. An add method.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>public</span> <span class=k>class</span> <span class=nc>Calculator</span> <span class=p>{</span> <span class=k>public</span> <span class=kt>decimal</span> <span class=n>Add</span><span class=p>(</span><span class=kt>decimal</span> <span class=n>a</span><span class=p>,</span> <span class=kt>decimal</span> <span class=n>b</span><span class=p>)</span> <span class=p>{</span> <span class=k>return</span> <span class=n>a</span> <span class=p>+</span> <span class=n>b</span><span class=p>;</span> <span class=p>}</span> <span class=p>}</span>

<span class=k>public</span> <span class=k>class</span> <span class=nc>Calculator</span>

<span class=p>{</span>

 <span class=k>public</span> <span class=kt>decimal</span> <span class=n>Add</span><span class=p>(</span><span class=kt>decimal</span> <span class=n>a</span><span class=p>,</span> <span class=kt>decimal</span> <span class=n>b</span><span class=p>)</span>

 <span class=p>{</span>

 <span class=k>return</span> <span class=n>a</span> <span class=p>+</span> <span class=n>b</span><span class=p>;</span>

 <span class=p>}</span>

<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>Now compile the C# project alone, not the whole solution. This will create the DLL in the bin folder of the project. We have to do this before adding the C# project as a reference to the FnO project.</p><p>Right click on the References node of the FnO project and select ‚ÄúAdd Reference‚Ä¶‚Äù:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/09/2020-09-30-13_00_34.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 24" title="MSDyn365 & Azure DevOps ALM 73"></p><p>Add reference to FnO project</p><p>A window will open and you should see the C# project in the ‚ÄúProjects‚Äù tab:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/09/2020-09-30-13_01_58.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 25" title="MSDyn365 & Azure DevOps ALM 74"></p><p>Add C# project reference to FnO project</p><p>Select it and click the Ok button. That will add the C# project as a reference to our FnO project, but we still need to do something or this won‚Äôt compile in our pipeline. We have to manually add the reference to the project that has been created in the AOT. So, right-click on the reference and select ‚ÄúAdd to source control‚Äù:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/09/2020-09-30-13_31_10.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 26" title="MSDyn365 & Azure DevOps ALM 75"></p><p>Add the reference to source control</p><p>In the FnO project add a Runnable Class, we‚Äôll call the C# library there:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>AASBuildNetDemoLibrary</span><span class=p>;</span> 
<span class=k>class</span> <span class=nc>AASBuildNetTest</span> 
<span class=p>{</span> 
    <span class=k>public</span> <span class=k>static</span> <span class=k>void</span> <span class=n>main</span><span class=p>(</span><span class=n>Args</span> <span class=err>\</span><span class=m>_</span><span class=n>args</span><span class=p>)</span> 
    <span class=p>{</span> 
        <span class=kt>var</span> <span class=n>calc</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Calculator</span><span class=p>();</span> 
        <span class=n>calc</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=m>4</span><span class=p>,</span> <span class=m>5</span><span class=p>);</span> 
    <span class=p>}</span> 
<span class=p>}</span>

<span class=k>using</span> <span class=nn>AASBuildNetDemoLibrary</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>AASBuildNetTest</span>

<span class=p>{</span>

 <span class=k>public</span> <span class=k>static</span> <span class=k>void</span> <span class=n>main</span><span class=p>(</span><span class=n>Args</span> <span class=err>\</span><span class=m>_</span><span class=n>args</span><span class=p>)</span>

 <span class=p>{</span>

 <span class=kt>var</span> <span class=n>calc</span> <span class=err>\</span><span class=p>=</span> <span class=k>new</span> <span class=n>Calculator</span><span class=p>();</span>

 <span class=n>calc</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=m>4</span><span class=p>,</span> <span class=m>5</span><span class=p>);</span>

 <span class=p>}</span>

<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>Add the solution to source control if you haven‚Äôt, make sure all the objects are also added and check it in.</p><h3 id=053-httpsaristeinfoenmsdyn365-azure-devops-almbuild-pipelinebuild-pipeline>0.5.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#build-pipeline></a>Build pipeline<a hidden class=anchor aria-hidden=true href=#053-httpsaristeinfoenmsdyn365-azure-devops-almbuild-pipelinebuild-pipeline>#</a></h3><p>If I go to my Azure DevOps repo we‚Äôll see the following:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/09/2020-09-30-13_38_19.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 27" title="MSDyn365 & Azure DevOps ALM 76"></p><p>Projects and objects</p><p>You can see I‚Äôve checked-in the solution under the Build folder, as I said earlier this is my personal preference and I do that to keep the solutions I‚Äôll use to build the code under control.</p><p>In my build pipeline I make sure I‚Äôm using this solution to build the code:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/09/2020-09-30-13_43_12.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 28" title="MSDyn365 & Azure DevOps ALM 77"></p><p>Build Dynamics 365 solution</p><p>Run the pipeline and when it‚Äôs done you can check the build step and you‚Äôll see a line that reads:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=n>Copying</span> <span class=n>file</span> <span class=n>from</span> <span class=s2>&#34;D:\\a\\9\\s\\Build\\AASBuildNetDemo\\AASBuildNetDemoLibrary\\bin\\Debug\\AASBuildNetDemoLibrary.dll&#34;</span> <span class=n>to</span> <span class=s2>&#34;D:\\a\\9\\b\\AASDemo\\bin\\AASBuildNetDemoLibrary.dll&#34;</span><span class=p>.</span>
</code></pre></td></tr></table></div></div><p>And if you download the DP, unzip it, navigate to AOSService\Packages\files and unzip the file in there, then open the bin folder, you‚Äôll see our library‚Äôs DLL there:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/09/2020-09-30-13_52_47.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 29" title="MSDyn365 & Azure DevOps ALM 78"></p><p>Victory!</p><h3 id=054-httpsaristeinfoenmsdyn365-azure-devops-almthings-i-dont-like-understand-need-to-investigatethings-i-dont-likeunderstandneed-to-investigate>0.5.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#things-i-dont-like-understand-need-to-investigate></a>Things I don‚Äôt like/understand/need to investigate<a hidden class=anchor aria-hidden=true href=#054-httpsaristeinfoenmsdyn365-azure-devops-almthings-i-dont-like-understand-need-to-investigatethings-i-dont-likeunderstandneed-to-investigate>#</a></h3><p>I‚Äôve always done this with a single solution and only one C# project. I have some doubts about how this will work with many C# projects, models, solutions, etc.</p><p>For example, if a model has a dependency on the DLL but it‚Äôs built before the DLL the build will fail. I‚Äôm sure there‚Äôs a way to set an order to solve dependencies like there is for FnO projects within a solution.</p><p>Or maybe I could try building all the C#/.NET projects before, pack them in a nuget and use the DLLs later in the FnO build, <a href=https://msdyn365fo.wordpress.com/2020/08/13/integration-of-nuget-packages-from-azure-devops-artifacts-into-the-dynalm-process/>something similar to what Paul Heisterkamp explained in his blog</a>.</p><p>Anyway, it‚Äôs your choice how to manage your C# projects and what solution fits your workflow the best, but at least you‚Äôve got an example here üôÇ</p><h2 id=httpsaristeinfoenmsdyn365-azure-devops-almsetup-release-pipelinessetup-release-pipelines><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#setup-release-pipelines></a>Setup Release Pipelines<a hidden class=anchor aria-hidden=true href=#httpsaristeinfoenmsdyn365-azure-devops-almsetup-release-pipelinessetup-release-pipelines>#</a></h2><p>We‚Äôve seen how the default build definition is created and how we can modify it. Now we‚Äôll see how to configure our release pipelines!</p><p>The release pipelines allow us to automatically deploy our Deployable Packages to a Tier 2+ environment. This is part of the Continuous Delivery (CD) strategy. We can only do this for the UAT environments, it‚Äôs not possible to automate the deployment to the production environment.</p><h3 id=061-httpsaristeinfoenmsdyn365-azure-devops-almsetting-up-release-pipeline-in-azure-devops-for-dynamics-365-for-finance-and-operationssetting-up-release-pipeline-in-azure-devops-for-dynamics-365-for-finance-and-operations>0.6.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#setting-up-release-pipeline-in-azure-devops-for-dynamics-365-for-finance-and-operations></a>Setting up Release Pipeline in Azure DevOps for Dynamics 365 for Finance and Operations<a hidden class=anchor aria-hidden=true href=#061-httpsaristeinfoenmsdyn365-azure-devops-almsetting-up-release-pipeline-in-azure-devops-for-dynamics-365-for-finance-and-operationssetting-up-release-pipeline-in-azure-devops-for-dynamics-365-for-finance-and-operations>#</a></h3><p>To configure the release pipeline, we need:</p><ul><li>AAD app registration</li><li>LCS project</li><li>An Azure DevOps project linked to the LCS project above</li><li>A service account</li></ul><p>I recommend a service account to do this, with a non-expiring password and no MFA enabled. It must have enough privileges on LCS, Azure and Azure DevOps too. This is not mandatory and can be done even with your user (if it has enough rights) for testing purposes, but if you‚Äôre setting this up don‚Äôt use your user and go for a service account.</p><h3 id=062-httpsaristeinfoenmsdyn365-azure-devops-almaad-app-creationaad-app-creation>0.6.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#aad-app-creation></a>AAD app creation<a hidden class=anchor aria-hidden=true href=#062-httpsaristeinfoenmsdyn365-azure-devops-almaad-app-creationaad-app-creation>#</a></h3><p>The first step to take is creating an app registration on Azure Active Directory to upload the generated deployable package to LCS. Head to¬†<a href=https://portal.azure.com/>Azure portal</a>¬† and once logged in go to Azure ActiveDirectory, then App Registrations and create a new Native app:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/05/New-AAD-App.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 30" title="MSDyn365 & Azure DevOps ALM 79"></p><p>Next go to ‚ÄúSettings‚Äù and ‚ÄúRequired permissions‚Äù to add the Dynamics Lifecycle Services API:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/05/Add-permission.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 31" title="MSDyn365 & Azure DevOps ALM 80"></p><p>In the dialog that will open change to the ‚ÄúAPIs my organization uses‚Äù tab and select ‚ÄúDynamics Lifecycle Services‚Äù:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/05/LCS.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 32" title="MSDyn365 & Azure DevOps ALM 81"></p><p>Select the only available permission in the next screen and click on the ‚ÄúAdd permissions‚Äù button. Finally press the ‚ÄúGrant admin consent‚Äù button to apply the changes. This last step can be easily forgotten and the package upload to LCS cannot be done if not granted. Once done take note of the Application ID, we‚Äôll use it later.</p><h3 id=063-httpsaristeinfoenmsdyn365-azure-devops-almcreate-the-release-pipeline-in-devopscreate-the-release-pipeline-in-devops>0.6.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#create-the-release-pipeline-in-devops></a>Create the release pipeline in DevOps<a hidden class=anchor aria-hidden=true href=#063-httpsaristeinfoenmsdyn365-azure-devops-almcreate-the-release-pipeline-in-devopscreate-the-release-pipeline-in-devops>#</a></h3><p>Go to Azure DevOps, and to Pipelines -> Releases to create the new release. Select ‚ÄúNew release pipeline‚Äù and choose ‚ÄúEmpty job‚Äù from the list.</p><p>On the artifact box select the build which will be used for this release definition:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/02/Captura-de-pantalla-2019-02-03-a-les-0.33.40-1024x467.png.webp alt="New release" title="MSDyn365 & Azure DevOps ALM 82"></p><p>Pick the build definition you want to use for the release in ‚ÄúSource‚Äù, ‚ÄúLatest‚Äù in ‚ÄúDefault version‚Äù and push ‚ÄúAdd‚Äù.</p><h4 id=0631-httpsaristeinfoenmsdyn365-azure-devops-almupload-to-lcsupload-to-lcs>0.6.3.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#upload-to-lcs></a>Upload to LCS<a hidden class=anchor aria-hidden=true href=#0631-httpsaristeinfoenmsdyn365-azure-devops-almupload-to-lcsupload-to-lcs>#</a></h4><p>The next step we‚Äôll take is adding a Task with the release pipeline for Dynamics. Go to the Tasks tab and press the plus button. A list with extension will appear, look for ‚ÄúDynamics 365 Unified Operations Tools‚Äù:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/02/Captura-de-pantalla-2019-02-03-a-les-0.39.39-1024x279.png.webp alt="Dynamics 365 Unified Operations Tools" title="MSDyn365 & Azure DevOps ALM 83"></p><p>If the extension hasn‚Äôt been added previously it can be done in this screen. <strong>In order to add it, the user used to create the release must have admin rights on the Azure DevOps account, not only in the project in which we‚Äôre creating the pipeline</strong>.</p><p>When the task is created we need to fill some parameters:![Release Dynamics Operations](./MSDyn365 & Azure DevOps ALM - ariste.info_files/Captura-de-pantalla-2019-02-03-a-les-0.43.11-1024x508.png.webp &ldquo;MSDyn365 & Azure DevOps ALM 84&rdquo;)</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/02/Captura-de-pantalla-2019-02-03-a-les-0.43.11-1024x508.png.webp alt="Release Dynamics Operations" title="MSDyn365 & Azure DevOps ALM 84"></p><h4 id=0632-httpsaristeinfoenmsdyn365-azure-devops-almapply-deployable-packageapply-deployable-package>0.6.3.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#apply-deployable-package></a>Apply deployable package<a hidden class=anchor aria-hidden=true href=#0632-httpsaristeinfoenmsdyn365-azure-devops-almapply-deployable-packageapply-deployable-package>#</a></h4><p>This step is finally available for self-service environments! If you already set this for a regular environment you can still change the task to the new version.</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/09/2020-09-04-10_55_48.png.webp alt="Azure DevOps asset deployment" title="MSDyn365 & Azure DevOps ALM 85"></p><p>Azure DevOps asset deployment</p><p>The new task version 1 works for both type of environments: Microsoft managed (regular environments) and self-service environments. The task version 0 is the old one and will only work with regular environments. You can safely switch your deploy tasks to version 1.</p><p>What‚Äôs different in task version 1? I guess that some work behind it that we don‚Äôt see to make it support self-service, but in the UI we only see a new field called ‚Äú<em>Name for the update</em>‚Äú.</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/09/2020-09-04-10_59_39.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 33" title="MSDyn365 & Azure DevOps ALM 86"></p><p>Name for the update field</p><p>This field is needed only for the self-service environments deployments, it will be ignored for regular ones, and corresponds to the field with the same name that appears on LCS when we apply an update to a sandbox environment:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/09/2020-09-04-11_05_10.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 34" title="MSDyn365 & Azure DevOps ALM 87"></p><p>Name for this update in LCS</p><p>The default field‚Äôs value is the variable $(Release.ReleaseName) that is the name of the release, but you can change it, for example I‚Äôll be using a pattern like <em>PREFIX BRANCH $(Build.BuildNumber)</em> to have the same name we have for the builds and identifying what we‚Äôre deploying to prod quickier.</p><h3 id=064-httpsaristeinfoenmsdyn365-azure-devops-almcreating-the-lcs-connectioncreating-the-lcs-connection>0.6.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#creating-the-lcs-connection></a>Creating the LCS connection<a hidden class=anchor aria-hidden=true href=#064-httpsaristeinfoenmsdyn365-azure-devops-almcreating-the-lcs-connectioncreating-the-lcs-connection>#</a></h3><p>The first step in the task is setting up the link to LCS using the AAD app we created before. Press New and let‚Äôs fill the fields in the following screen:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/05/LCS-in-Azure-DevOps.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 35" title="MSDyn365 & Azure DevOps ALM 88"></p><p>It‚Äôs only necessary to fill in the connection name, username, password (from the user and Application (Client) ID fields. Use the App ID we got in the first step for the App ID field. The endpoint fields should be automatically filled in. Finally, press OK and the LCS connection is ready.</p><p>In the LCS Project Id field, use the ID from the LCS project URL, for example in <a href=https://lcs.dynamics.com/V2/ProjectOverview/1234567>https://lcs.dynamics.com/V2/ProjectOverview/1234567</a> the project is is 1234567.</p><p>Press the button next to ‚ÄúFile to upload‚Äù and select the deployable package file generated by the build:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/02/Captura-de-pantalla-2019-02-03-a-les-0.53.30.png.webp alt="DP Generado" title="MSDyn365 & Azure DevOps ALM 89"></p><p>If the build definition hasn‚Äôt been modified, the output DP will have a name like AXDeployableRuntime_VERSION_BUILDNUMBER.zip. Change the fixed Build Number for the DevOps variable $(Build.BuildNumber) like in the image below:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/02/Captura-de-pantalla-2019-02-03-a-les-0.56.20-1024x87.png.webp alt=BUildNumber title="MSDyn365 & Azure DevOps ALM 90"></p><p>The package name and description in LCS are defined in ‚ÄúLCS Asset Name‚Äù and ‚ÄúLCS Asset Description‚Äù. For these fields, Azure DevOps‚Äô <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/build/variables?view=azure-devops&WT.mc_id=DOP-MVP-5003976">build variables</a> and <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/release/variables?view=azure-devops&tabs=batch&WT.mc_id=DOP-MVP-5003976#default-variables">release variables</a> can be used. Use whatever fits your project, for example a prefix to distinguish between prod and pre-prod packages followed by $(Build.BuildNumber), will upload the DP to LCS with a name like Prod 2019.1.29.1, using the date as a DP name.</p><p>Save the task and release definition and let‚Äôs test it. In the Releases select the one we have just created and press the ‚ÄúCreate a release‚Äù button, in the dialog just press OK. The release will start and, if everything is OK we‚Äôll see the DP in LCS when it finishes:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/02/Captura-de-pantalla-2019-02-03-a-les-1.05.05.png.webp alt="LCS Asset Library" title="MSDyn365 & Azure DevOps ALM 91"></p><p>The release part can be automated, just press the lightning button on the artifact and enable the trigger:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/02/Captura-de-pantalla-2019-02-03-a-les-1.08.21.png.webp alt="Release trigger" title="MSDyn365 & Azure DevOps ALM 92"></p><p>And that‚Äôs all! Now the build and the releases are both configured. Once the deployment package is published the CI scenario will be complete.</p><h1 id=httpsaristeinfoenmsdyn365-azure-devops-almmore-automationmore-automation><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#more-automation></a>More automation!<a hidden class=anchor aria-hidden=true href=#httpsaristeinfoenmsdyn365-azure-devops-almmore-automationmore-automation>#</a></h1><p>I‚Äôve already explained in the past how to automate the builds, create the <a href="https://docs.microsoft.com/en-us/azure/devops/learn/what-is-continuous-integration?WT.mc_id=DOP-MVP-5003976">CI builds</a> and create the release pipelines on Azure DevOps, what I want to talk about in this post is about adding a little bit more automation.</p><h2 id=httpsaristeinfoenmsdyn365-azure-devops-almbuildsbuilds><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#builds></a>Builds<a hidden class=anchor aria-hidden=true href=#httpsaristeinfoenmsdyn365-azure-devops-almbuildsbuilds>#</a></h2><p>In the build definition go to the ‚ÄúTriggers‚Äù tab and enable a scheduled build:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/10/2019-10-26-11_05_38-AXZ-Main-Build-DP-Daily-16.30-Azure-DevOps-Services.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 36" title="MSDyn365 & Azure DevOps ALM 93"></p><p>This will automatically trigger the build at the time and days you select. In the example image, every weekday at 16.30h a new build will be launched. <strong>But</strong> everyday? Nope! What the ‚ÄúOnly schedule builds if the source or pipeline has changed‚Äù checkbox below the time selector makes is <strong>only triggering the build if there‚Äôs been any change to the codebase</strong>, meaning that if there‚Äôs no changeset checked-in during that day no build will be triggered.</p><h2 id=httpsaristeinfoenmsdyn365-azure-devops-almreleasesreleases><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#releases></a>Releases<a hidden class=anchor aria-hidden=true href=#httpsaristeinfoenmsdyn365-azure-devops-almreleasesreleases>#</a></h2><p>First step done, let‚Äôs see what can we do with the releases:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/10/2019-10-26-11_14_04-AXZ-Prod-Release-Daily-16.30-Pipelines.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 37" title="MSDyn365 & Azure DevOps ALM 94"></p><p>The release pipeline in the image above is the one that launches after the build I‚Äôve created in the first step. For this pipeline I‚Äôve added the following:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/10/2019-10-26-11_16_53-AXZ-Prod-Release-Daily-16.30-Pipelines.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 38" title="MSDyn365 & Azure DevOps ALM 95"></p><p>The continuous deployment trigger has been enabled, meaning that after the build finishes this release will be automatically run. No need to define a schedule but you could also do that.</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/10/2019-10-26-11_20_35-AXZ-Prod-Release-Daily-16.30-Pipelines.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 39" title="MSDyn365 & Azure DevOps ALM 96"></p><p>As you can see, the schedule screen is exactly the same as in the builds, even the changed pipeline checkbox is there.¬† You can use any of these two approaches, CD or scheduled release, it‚Äôs up to your project or team needs.</p><p>With these two small steps you can have your full CI and CD strategy automatized and update a UAT environment each night to have all the changes done during that day ready for testing, with no human interaction!</p><h2 id=httpsaristeinfoenmsdyn365-azure-devops-almbut-i-like-to-add-some-human-touch-to-itbut-i-like-to-add-some-human-touch-to-it><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#but-i-like-to-add-some-human-touch-to-it></a>But I like to add some human touch to it<a hidden class=anchor aria-hidden=true href=#httpsaristeinfoenmsdyn365-azure-devops-almbut-i-like-to-add-some-human-touch-to-itbut-i-like-to-add-some-human-touch-to-it>#</a></h2><p>If you don‚Äôt like not knowing if an environment is being updated‚Ä¶ well <strong>that‚Äôs IMPOSSIBLE</strong> because LCS will SPAM you to make sure you know what‚Äôs going on. But if you don‚Äôt want to be completely replaced by robots you can add approvals to your release flow:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/10/2019-10-27-09_59_15-AXZ-Prod-Release-Daily-16.30-Pipelines.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 40" title="MSDyn365 & Azure DevOps ALM 97"></p><p>Clicking the left lightning + person button on your release you can set the approvers, a person or a group (which is quite practical), and the kind of approval (all or single approver) and the timeout. You will also receive an email with a link to the approval form:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/10/2019-10-27-09_52_47-AXZ-Dev-Release-Daily-16.30-Release-41-Pipelines.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 41" title="MSDyn365 & Azure DevOps ALM 98"></p><p>And you can also postpone the deployment! <a href="https://www.youtube.com/watch?v=StTqXEQ2l-Y">Everything is awesome!</a></p><h2 id=httpsaristeinfoenmsdyn365-azure-devops-almextra-bonusextra-bonus><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#extra-bonus></a>Extra bonus!<a hidden class=anchor aria-hidden=true href=#httpsaristeinfoenmsdyn365-azure-devops-almextra-bonusextra-bonus>#</a></h2><p>A little tip. Imagine you have the following release:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/10/2019-10-27-11_09_39-AXZ-Golden-Release-Daily-16.30-Pipelines.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 42" title="MSDyn365 & Azure DevOps ALM 99"></p><p>This will update 3 environments, but will also upload the same Deployable Package three times to LCS. Wouldn‚Äôt it be nice to have a single upload and that all the deployments used that file? Yes, but we can‚Äôt pass the output variable from the upload to other stages üôÅ Yes that‚Äôs unfortunately right. But we can do something with a little help from our friend Powershell!</p><h2 id=httpsaristeinfoenmsdyn365-azure-devops-almupdate-a-variable-in-a-releaseupdate-a-variable-in-a-release><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#update-a-variable-in-a-release></a>Update a variable in a release<a hidden class=anchor aria-hidden=true href=#httpsaristeinfoenmsdyn365-azure-devops-almupdate-a-variable-in-a-releaseupdate-a-variable-in-a-release>#</a></h2><p>What we need to do is create a variable in the release definition and set its scope to ‚ÄúRelease‚Äù:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/10/2019-10-27-11_14_57-AXZ-Dev-Release-Daily-16.30-Pipelines.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 43" title="MSDyn365 & Azure DevOps ALM 100"></p><p>Then, <strong>for each stage</strong>, we need to enable this checkbox in the agent job:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/10/2019-10-27-11_26_29-AXZ-Dev-Release-Daily-16.30-Pipelines.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 44" title="MSDyn365 & Azure DevOps ALM 101"></p><p>I explain later why we‚Äôre enabling this. We now only need to update this variable after uploading the DP to LCS. Add an inline Powershell step after the upload one and do this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=err>#</span> <span class=n>Populate</span> <span class=n>store</span> <span class=k>value</span> <span class=n>to</span> <span class=n>update</span> <span class=n>pipeline</span>

<span class=err>$</span><span class=n>assetId</span><span class=err>\</span><span class=p>=</span> <span class=s>&#34;$(GoldenUpload.FileAssetId)&#34;</span>

<span class=n>Write</span><span class=err>\</span><span class=p>-</span><span class=n>Output</span> <span class=p>(</span><span class=err>&#39;##</span><span class=n>vso</span><span class=err>\</span><span class=p>[</span><span class=n>task</span><span class=p>.</span><span class=n>setvariable</span> <span class=n>variable</span><span class=p>=</span><span class=n>localAsset</span><span class=err>\</span><span class=p>]{</span><span class=m>0</span><span class=p>}</span><span class=err>&#39;</span> <span class=err>\</span><span class=p>-</span><span class=n>f</span> <span class=err>$</span><span class=n>assetId</span><span class=p>)</span>

<span class=cp>#region variables
</span><span class=cp></span>
<span class=err>$</span><span class=n>ReleaseVariableName</span> <span class=err>\</span><span class=p>=</span> <span class=err>&#39;</span><span class=n>axzfileid</span><span class=err>&#39;</span>

<span class=err>$</span><span class=n>releaseurl</span> <span class=err>\</span><span class=p>=</span> <span class=p>(</span><span class=err>&#39;</span><span class=p>{</span><span class=m>0</span><span class=p>}{</span><span class=m>1</span><span class=p>}/</span><span class=err>\</span><span class=m>_</span><span class=n>apis</span><span class=p>/</span><span class=n>release</span><span class=p>/</span><span class=n>releases</span><span class=p>/{</span><span class=m>2</span><span class=p>}?</span><span class=n>api</span><span class=p>-</span><span class=n>version</span><span class=p>=</span><span class=m>5.0</span><span class=err>&#39;</span> <span class=err>\</span><span class=p>-</span><span class=n>f</span> <span class=err>$</span><span class=p>(</span><span class=err>$</span><span class=n>env</span><span class=p>:</span><span class=n>SYSTEM</span><span class=err>\</span><span class=m>_</span><span class=n>TEAMFOUNDATIONSERVERURI</span><span class=p>),</span> <span class=err>$</span><span class=p>(</span><span class=err>$</span><span class=n>env</span><span class=p>:</span><span class=n>SYSTEM</span><span class=err>\</span><span class=m>_</span><span class=n>TEAMPROJECTID</span><span class=p>),</span> <span class=err>$</span><span class=p>(</span><span class=err>$</span><span class=n>env</span><span class=p>:</span><span class=n>RELEASE</span><span class=err>\</span><span class=m>_</span><span class=n>RELEASEID</span><span class=p>)</span> <span class=p>)</span>

<span class=cp>#endregion
</span><span class=cp></span>
<span class=cp>#region Get Release Definition
</span><span class=cp></span>
<span class=n>Write</span><span class=err>\</span><span class=p>-</span><span class=n>Host</span> <span class=s>&#34;URL: $releaseurl&#34;</span>

<span class=err>$</span><span class=n>Release</span> <span class=err>\</span><span class=p>=</span> <span class=n>Invoke</span><span class=err>\</span><span class=p>-</span><span class=n>RestMethod</span> <span class=err>\</span><span class=p>-</span><span class=n>Uri</span> <span class=err>$</span><span class=n>releaseurl</span> <span class=err>\</span><span class=p>-</span><span class=n>Headers</span> <span class=err>@</span><span class=p>{</span>

 <span class=n>Authorization</span> <span class=err>\</span><span class=p>=</span> <span class=s>&#34;Bearer $env:SYSTEM\_ACCESSTOKEN&#34;</span>

<span class=p>}</span>

<span class=cp>#endregion
</span><span class=cp></span>
<span class=cp>#region Output current Release Pipeline
</span><span class=cp></span>
<span class=err>#</span><span class=n>Write</span><span class=p>-</span><span class=n>Output</span> <span class=p>(</span><span class=err>&#39;</span><span class=n>Release</span> <span class=n>Pipeline</span> <span class=n>variables</span> <span class=n>output</span><span class=p>:</span> <span class=p>{</span><span class=m>0</span><span class=p>}</span><span class=err>&#39;</span> <span class=p>-</span><span class=n>f</span> <span class=err>$</span><span class=p>(</span><span class=err>$</span><span class=n>Release</span><span class=p>.</span><span class=n>variables</span> <span class=p>|</span> <span class=err>#</span><span class=n>ConvertTo</span><span class=p>-</span><span class=n>Json</span> <span class=p>-</span><span class=n>Depth</span> <span class=m>10</span><span class=p>))</span>

<span class=cp>#endregion
</span><span class=cp></span>
<span class=err>#</span><span class=n>Update</span> <span class=n>axzfileid</span> <span class=n>with</span> <span class=k>new</span> <span class=k>value</span>

<span class=err>$</span><span class=n>release</span><span class=p>.</span><span class=n>variables</span><span class=p>.(</span><span class=err>$</span><span class=n>ReleaseVariableName</span><span class=p>).</span><span class=k>value</span> <span class=err>\</span><span class=p>=</span> <span class=err>$</span><span class=n>assetId</span>

<span class=cp>#region update release pipeline
</span><span class=cp></span>
<span class=n>Write</span><span class=err>\</span><span class=p>-</span><span class=n>Output</span> <span class=p>(</span><span class=err>&#39;</span><span class=n>Updating</span> <span class=n>Release</span> <span class=n>Definition</span><span class=err>&#39;</span><span class=p>)</span>

<span class=err>$</span><span class=n>json</span> <span class=err>\</span><span class=p>=</span> <span class=err>@</span><span class=p>(</span><span class=err>$</span><span class=n>release</span><span class=p>)</span> <span class=p>|</span> <span class=n>ConvertTo</span><span class=err>\</span><span class=p>-</span><span class=n>Json</span> <span class=err>\</span><span class=p>-</span><span class=n>Depth</span> <span class=m>99</span>

<span class=err>$</span><span class=n>enc</span> <span class=err>\</span><span class=p>=</span> <span class=err>\</span><span class=p>[</span><span class=n>System</span><span class=p>.</span><span class=n>Text</span><span class=p>.</span><span class=n>Encoding</span><span class=err>\</span><span class=p>]::</span><span class=n>UTF8</span>

<span class=err>$</span><span class=n>json</span><span class=err>\</span><span class=p>=</span> <span class=err>$</span><span class=n>enc</span><span class=p>.</span><span class=n>GetBytes</span><span class=p>(</span><span class=err>$</span><span class=n>json</span><span class=p>)</span>

<span class=n>Invoke</span><span class=err>\</span><span class=p>-</span><span class=n>RestMethod</span> <span class=err>\</span><span class=p>-</span><span class=n>Uri</span> <span class=err>$</span><span class=n>releaseurl</span> <span class=err>\</span><span class=p>-</span><span class=n>Method</span> <span class=n>Put</span> <span class=err>\</span><span class=p>-</span><span class=n>Body</span> <span class=err>$</span><span class=n>json</span> <span class=err>\</span><span class=p>-</span><span class=n>ContentType</span> <span class=s>&#34;application/json&#34;</span> <span class=err>\</span><span class=p>-</span><span class=n>Headers</span> <span class=err>@</span><span class=p>{</span><span class=n>Authorization</span> <span class=err>\</span><span class=p>=</span> <span class=s>&#34;Bearer $env:SYSTEM\_ACCESSTOKEN&#34;</span> <span class=p>}</span>

<span class=cp>#endregion
</span></code></pre></td></tr></table></div></div><p>You need to change the following:</p><ul><li>Line 2: $assetId= ‚Äú$(GoldenUpload.FileAssetId)‚Äù. Change $(GoldenUpload.FileAssetId) for your output variable name.</li><li>Line 6: $ReleaseVariableName = ‚Äòaxzfileid‚Äô. Change axzfileid for your Release variable name.</li></ul><p>And you‚Äôre done. This script uses Azure DevOps‚Äô REST API to update the variable value with the file id, and we enabled the OAuth token checkbox to allow the usage of this API without having to pass any user credentials. This is not my idea obviously, I‚Äôve done <a href=https://stefanstranger.github.io/2019/06/26/PassingVariablesfromStagetoStage/>this thanks to this post from Stefan Stranger‚Äôs blog</a>.</p><p>Now, in the deploy stages you need to retrieve your variable‚Äôs value in the following way:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/10/2019-10-27-11_21_02-AXZ-Dev-Release-Daily-16.30-Pipelines.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 45" title="MSDyn365 & Azure DevOps ALM 102"></p><p><strong>Don‚Äôt forget the ( ) or it won‚Äôt work!</strong></p><p>And with these small changes you can have a release like this:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2019/10/pipelines.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 46" title="MSDyn365 & Azure DevOps ALM 103"></p><p>With a single DP upload to LCS and multiple deployments using the file uploaded in the first stage. With approvals, and delays, and emails, and everything!</p><h1 id=httpsaristeinfoenmsdyn365-azure-devops-almlcs-db-apilcs-db-api><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#lcs-db-api></a>LCS DB API<a hidden class=anchor aria-hidden=true href=#httpsaristeinfoenmsdyn365-azure-devops-almlcs-db-apilcs-db-api>#</a></h1><h2 id=httpsaristeinfoenmsdyn365-azure-devops-almcall-the-lcs-database-movement-api-from-your-azure-devops-pipelinescall-the-lcs-database-movement-api-from-your-azure-devops-pipelines><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#call-the-lcs-database-movement-api-from-your-azure-devops-pipelines></a>Call the LCS Database Movement API from your Azure DevOps Pipelines<a hidden class=anchor aria-hidden=true href=#httpsaristeinfoenmsdyn365-azure-devops-almcall-the-lcs-database-movement-api-from-your-azure-devops-pipelinescall-the-lcs-database-movement-api-from-your-azure-devops-pipelines>#</a></h2><h3 id=211-httpsaristeinfoenmsdyn365-azure-devops-almwhat-forwhat-for>2.1.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#what-for></a>What for?<a hidden class=anchor aria-hidden=true href=#211-httpsaristeinfoenmsdyn365-azure-devops-almwhat-forwhat-for>#</a></h3><p>Basically, <a href=https://ariste.info/en/2019/10/devops-alm-automation-in-microsoft-dynamics-365-for-finance-and-operations/>automation</a>. Right now <strong>the API only allows the refresh from one Microsoft Dynamics 365 for Finance and Operations environment to another</strong>, so the idea is having fresh data from production in our UAT environments <strong>daily</strong>. I don‚Äôt know which new operations the API will support in the future but another idea could be adding the DB export operation (creating a bacpac) to the pipeline and having a copy of prod ready to be restored in a Dev environment.</p><p>Don‚Äôt forget that the API has a limit of <strong>3 refresh operations per environment per 24 hours</strong>. Don‚Äôt do this on a CI build! (it makes no sense either). Probably the best idea is to run this nightly with all your tests, once a day.</p><h3 id=212-httpsaristeinfoenmsdyn365-azure-devops-almcalling-the-apicalling-the-api>2.1.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#calling-the-api></a>Calling the API<a hidden class=anchor aria-hidden=true href=#212-httpsaristeinfoenmsdyn365-azure-devops-almcalling-the-apicalling-the-api>#</a></h3><p>I‚Äôll use PowerShell to call the API from a pipeline. PowerShell has a command called <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-restmethod?view=powershell-7&WT.mc_id=DOP-MVP-5003976">Invoke-RestMethod</a> that makes HTTP/HTTPS requests. It‚Äôs really easy and we just need to do the same we did to call the API in my post.</p><h4 id=2121-httpsaristeinfoenmsdyn365-azure-devops-almgetting-the-tokengetting-the-token>2.1.2.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#getting-the-token></a>Getting the token<a hidden class=anchor aria-hidden=true href=#2121-httpsaristeinfoenmsdyn365-azure-devops-almgetting-the-tokengetting-the-token>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=err>$</span><span class=n>projectId</span> <span class=err>\</span><span class=p>=</span> <span class=s>&#34;1234567&#34;</span>

<span class=err>$</span><span class=n>tokenUrl</span> <span class=err>\</span><span class=p>=</span> <span class=s>&#34;https://login.microsoftonline.com/common/oauth2/token&#34;</span>

<span class=err>$</span><span class=n>clientId</span> <span class=err>\</span><span class=p>=</span> <span class=s>&#34;12345678-abcd-432a-0666-22de4c4321aa&#34;</span>

<span class=err>$</span><span class=n>clientSecret</span> <span class=err>\</span><span class=p>=</span> <span class=s>&#34;superSeCrEt12345678&#34;</span>

<span class=err>$</span><span class=n>username</span> <span class=err>\</span><span class=p>=</span> <span class=s>&#34;youruser@tenant.com&#34;</span>

<span class=err>$</span><span class=n>password</span> <span class=err>\</span><span class=p>=</span> <span class=s>&#34;strongerThan123456&#34;</span>

<span class=err>$</span><span class=n>tokenBody</span> <span class=err>\</span><span class=p>=</span> <span class=err>@</span><span class=p>{</span>

 <span class=n>grant</span><span class=err>\</span><span class=m>_</span><span class=n>type</span> <span class=err>\</span><span class=p>=</span> <span class=s>&#34;password&#34;</span>

 <span class=n>client</span><span class=err>\</span><span class=m>_</span><span class=n>id</span> <span class=err>\</span><span class=p>=</span> <span class=err>$</span><span class=n>clientId</span>

 <span class=n>client</span><span class=err>\</span><span class=m>_</span><span class=n>secret</span> <span class=err>\</span><span class=p>=</span> <span class=err>$</span><span class=n>clientSecret</span>

 <span class=n>resource</span> <span class=err>\</span><span class=p>=</span> <span class=s>&#34;https://lcsapi.lcs.dynamics.com&#34;</span>

 <span class=n>username</span> <span class=err>\</span><span class=p>=</span> <span class=err>$</span><span class=n>username</span>

 <span class=n>password</span> <span class=err>\</span><span class=p>=</span> <span class=err>$</span><span class=n>password</span>

<span class=p>}</span>

<span class=err>$</span><span class=n>tokenResponse</span> <span class=err>\</span><span class=p>=</span> <span class=n>Invoke</span><span class=err>\</span><span class=p>-</span><span class=n>RestMethod</span> <span class=err>\</span><span class=p>-</span><span class=n>Method</span> <span class=err>&#39;</span><span class=n>POST</span><span class=err>&#39;</span> <span class=err>\</span><span class=p>-</span><span class=n>Uri</span> <span class=err>$</span><span class=n>tokenUrl</span> <span class=err>\</span><span class=p>-</span><span class=n>Body</span> <span class=err>$</span><span class=n>tokenBody</span>

<span class=err>$</span><span class=n>token</span> <span class=err>\</span><span class=p>=</span> <span class=err>$</span><span class=n>tokenResponse</span><span class=p>.</span><span class=n>access</span><span class=err>\</span><span class=m>_</span><span class=n>token</span>
</code></pre></td></tr></table></div></div><p>To get the token we‚Äôll use this script. Just change the variables for the ones of your project, AAD App registration, user (remember it needs access to the preview) and password and run it. If everything is OK you‚Äôll get the JSON response in the $tokenResponse variable and from there you can get the token‚Äôs value using dot notation.</p><h4 id=2122-httpsaristeinfoenmsdyn365-azure-devops-almrequesting-the-db-refreshrequesting-the-db-refresh>2.1.2.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#requesting-the-db-refresh></a>Requesting the DB refresh<a hidden class=anchor aria-hidden=true href=#2122-httpsaristeinfoenmsdyn365-azure-devops-almrequesting-the-db-refreshrequesting-the-db-refresh>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=err>$</span><span class=n>projectId</span> <span class=err>\</span><span class=p>=</span> <span class=s>&#34;1234567&#34;</span>

<span class=err>$</span><span class=n>sourceEnvironmentId</span> <span class=err>\</span><span class=p>=</span> <span class=s>&#34;fad26410-03cd-4c3e-89b8-85d2bddc4933&#34;</span>

<span class=err>$</span><span class=n>targetEnvironmentId</span> <span class=err>\</span><span class=p>=</span> <span class=s>&#34;cab68410-cd13-9e48-12a3-32d585aaa548&#34;</span>

<span class=err>$</span><span class=n>refreshUrl</span> <span class=err>\</span><span class=p>=</span> <span class=s>&#34;https://lcsapi.lcs.dynamics.com/databasemovement/v1/databases/project/$projectId/source/$sourceEnvironmentId/target/$targetEnvironmentId&#34;</span>

<span class=err>$</span><span class=n>refreshHeader</span> <span class=err>\</span><span class=p>=</span> <span class=err>@</span><span class=p>{</span>

 <span class=n>Authorization</span> <span class=err>\</span><span class=p>=</span> <span class=s>&#34;Bearer $token&#34;</span>

 <span class=s>&#34;x-ms-version&#34;</span> <span class=err>\</span><span class=p>=</span> <span class=err>&#39;</span><span class=m>2017</span><span class=p>-</span><span class=m>09</span><span class=p>-</span><span class=m>15</span><span class=err>&#39;</span>

 <span class=s>&#34;Content-Type&#34;</span> <span class=err>\</span><span class=p>=</span> <span class=s>&#34;application/json&#34;</span>

<span class=p>}</span>

<span class=err>$</span><span class=n>refreshResponse</span> <span class=err>\</span><span class=p>=</span> <span class=n>Invoke</span><span class=err>\</span><span class=p>-</span><span class=n>RestMethod</span> <span class=err>$</span><span class=n>refreshUrl</span><span class=p>&amp;</span><span class=n>nbsp</span><span class=p>;</span><span class=err>\</span><span class=p>-</span><span class=n>Method</span> <span class=err>&#39;</span><span class=n>POST</span><span class=err>&#39;</span> <span class=err>\</span><span class=p>-</span><span class=n>Headers</span> <span class=err>$</span><span class=n>refreshHeader</span>
</code></pre></td></tr></table></div></div><p>This will be the call to trigger the refresh. We‚Äôll need the token we‚Äôve just obtained in the first step to use it in the header and the source and target environment Ids.</p><p>If it‚Äôs successful the response will be a 200 OK.</p><h3 id=213-httpsaristeinfoenmsdyn365-azure-devops-almadd-it-to-your-pipelineadd-it-to-your-pipeline>2.1.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#add-it-to-your-pipeline></a>Add it to your pipeline<a hidden class=anchor aria-hidden=true href=#213-httpsaristeinfoenmsdyn365-azure-devops-almadd-it-to-your-pipelineadd-it-to-your-pipeline>#</a></h3><p>Adding this to an Azure DevOps pipeline is no mistery. Select and edit your pipeline, I‚Äôm doing it on a nigthly build (it‚Äôs called continuous but it‚Äôs not‚Ä¶) that runs after the environment has been updated with code, and add a new PowerShell task:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/01/2020-01-26-19_33_00-AXZ-Dev-Continuous-Build-Azure-DevOps-Services.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 47" title="MSDyn365 & Azure DevOps ALM 104"></p><p>Select the task and change it to ‚ÄúInline‚Äù:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/01/2020-01-26-19_24_42-AXZ-Prod-Release-Daily-18h-Pipelines.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 48" title="MSDyn365 & Azure DevOps ALM 105"></p><p>Then just paste the script we‚Äôve created in the Script field and done! You‚Äôll get a refresh after the tests!</p><p>You can also run this on your release pipeline <strong>BUT</strong> if you do it after the deploy step remember to mark the ‚ÄúWait for Completion‚Äù option or the operation will fail because the environment will already be servicing! And even then it could fail if the servicing goes over the timeout time. So‚Ä¶ <strong>don‚Äôt run this on your release pipeline</strong>!</p><p>And that‚Äôs all. Let‚Äôs which new operations will be added to the API and what we can do with them.</p><h3 id=214-httpsaristeinfoenmsdyn365-azure-devops-almuse-d365fo-tools-in-your-azure-pipelineuse-d365fotools-in-your-azure-pipeline>2.1.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#use-d365fo-tools-in-your-azure-pipeline></a>Use d365fo.tools in your Azure Pipeline<a hidden class=anchor aria-hidden=true href=#214-httpsaristeinfoenmsdyn365-azure-devops-almuse-d365fo-tools-in-your-azure-pipelineuse-d365fotools-in-your-azure-pipeline>#</a></h3><p>Thanks to <a href=https://ariste.info/en/2020/01/calling-the-lcs-database-movement-api-in-your-azure-devops-pipeline/#comment-77>M√∂tz‚Äôs comment</a> pointing me to how to add d365fo.tools to a hosted pipeline I‚Äôve created a pipeline which will install the tools and run the commands. It‚Äôs even easier to do than with the Invoke-RestMethod.</p><h4 id=2141-httpsaristeinfoenmsdyn365-azure-devops-almbut-firstbut-first>2.1.4.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#but-first></a>But first‚Ä¶<a hidden class=anchor aria-hidden=true href=#2141-httpsaristeinfoenmsdyn365-azure-devops-almbut-firstbut-first>#</a></h4><p>Make sure that in your Azure Active Directory app registration you‚Äôve selected ‚ÄúTreat application as a public client‚Äù under Authentication:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/01/2020-02-06-15_56_47-LCSDBAPIPreview-Authentication-Microsoft-Azure.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 49" title="MSDyn365 & Azure DevOps ALM 106"></p><h4 id=2142-httpsaristeinfoenmsdyn365-azure-devops-almthe-taskthe-task>2.1.4.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#the-task></a>The task<a hidden class=anchor aria-hidden=true href=#2142-httpsaristeinfoenmsdyn365-azure-devops-almthe-taskthe-task>#</a></h4><p>First we need to install d365fo.tools and then we can use its commands to call the LCS API:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=n>Install</span><span class=p>\</span><span class=n>-PackageProvider</span> <span class=n>nuget</span> <span class=p>\</span><span class=n>-Scope</span> <span class=n>CurrentUser</span> <span class=p>\</span><span class=n>-Force</span> <span class=p>\</span><span class=n>-Confirm</span><span class=err>:</span><span class=nv>$false</span>

<span class=n>Install</span><span class=p>\</span><span class=n>-Module</span> <span class=p>\</span><span class=n>-Name</span> <span class=n>AZ</span> <span class=p>\</span><span class=n>-AllowClobber</span> <span class=p>\</span><span class=n>-Scope</span> <span class=n>CurrentUser</span> <span class=p>\</span><span class=n>-Force</span> <span class=p>\</span><span class=n>-Confirm</span><span class=err>:</span><span class=nv>$False</span> <span class=p>\</span><span class=n>-SkipPublisherCheck</span>

<span class=n>Install</span><span class=p>\</span><span class=n>-Module</span> <span class=p>\</span><span class=n>-Name</span> <span class=n>d365fo</span><span class=p>.</span><span class=n>tools</span> <span class=p>\</span><span class=n>-AllowClobber</span> <span class=p>\</span><span class=n>-Scope</span> <span class=n>CurrentUser</span> <span class=p>\</span><span class=n>-Force</span> <span class=p>\</span><span class=n>-Confirm</span><span class=err>:</span><span class=nv>$false</span>

<span class=n>Get</span><span class=p>\</span><span class=n>-D365LcsApiToken</span> <span class=p>\</span><span class=n>-ClientId</span> <span class=s2>&#34;{YOUR\_APP\_ID}&#34;</span> <span class=p>\</span><span class=n>-Username</span> <span class=s2>&#34;{USERNAME}&#34;</span> <span class=p>\</span><span class=n>-Password</span> <span class=s2>&#34;{PASSWORD}&#34;</span> <span class=p>\</span><span class=n>-LcsApiUri</span> <span class=s2>&#34;https://lcsapi.lcs.dynamics.com&#34;</span> <span class=p>\</span><span class=n>-Verbose</span> <span class=p>|</span> <span class=n>Set</span><span class=p>\</span><span class=n>-D365LcsApiConfig</span> <span class=p>\</span><span class=n>-ProjectId</span> <span class=n>1234567</span>

<span class=n>Invoke</span><span class=p>\</span><span class=n>-D365LcsDatabaseRefresh</span> <span class=p>\</span><span class=n>-SourceEnvironmentId</span> <span class=s2>&#34;958ae597-f089-4811-abbd-c1190917eaae&#34;</span> <span class=p>\</span><span class=n>-TargetEnvironmentId</span> <span class=s2>&#34;13cc7700-c13b-4ea3-81cd-2d26fa72ec5e&#34;</span> <span class=p>\</span><span class=n>-SkipInitialStatusFetch</span>
</code></pre></td></tr></table></div></div><p>As you can see it a bit easier to do the refresh using d365fo.tools. We get the token and pipeline the output to the Set-D365LcsApiConfig command which will store the token (and others). This also helps to not having to duplicate AppIds, users, etc. and as you can see to call the refresh operation we just need the source and target environment Ids!</p><h2 id=httpsaristeinfoenmsdyn365-azure-devops-almautomating-prod-to-dev-db-copiesautomating-prod-to-dev-db-copies><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#automating-prod-to-dev-db-copies></a>Automating Prod to Dev DB copies<a hidden class=anchor aria-hidden=true href=#httpsaristeinfoenmsdyn365-azure-devops-almautomating-prod-to-dev-db-copiesautomating-prod-to-dev-db-copies>#</a></h2><p>The new LCS DB API endpoint to <a href="https://docs.microsoft.com/en-us/dynamics365/fin-ops-core/dev-itpro/database/api/v1/reference-create-export?WT.mc_id=BA-MVP-5003976">create a database export</a> has been published! With it we now have a way of <strong>automating and scheduling a database refresh from your Dynamics 365 FnO production environment to a developer or Tier 1 VM</strong>.</p><p><img loading=lazy src="https://i2.wp.com/ariste.info/wp-content/uploads/2020/04/D96E7A98-2B35-4C5E-95F5-E1DF9091CE1E-scaled.jpeg?fit=1024%2C783&ssl=1" alt="Using the LCS DB API" title="MSDyn365 & Azure DevOps ALM 107"></p><p>Using the LCS DB API</p><h3 id=221-httpsaristeinfoenmsdyn365-azure-devops-almthe-bacpac-issuethe-bacpac-issue>2.2.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#the-bacpac-issue></a>The bacpac issue<a hidden class=anchor aria-hidden=true href=#221-httpsaristeinfoenmsdyn365-azure-devops-almthe-bacpac-issuethe-bacpac-issue>#</a></h3><p>One of the main setbacks we currently have with prod DB refreshes is that it‚Äôs not a quick thing to do because you need to:</p><ul><li>Refresh a Tier 2+ environment with prod‚Äôs DB</li><li>Export a <a href="https://docs.microsoft.com/en-us/sql/relational-databases/data-tier-applications/data-tier-applications?view=sql-server-ver15&WT.mc_id=DOP-MVP-5003976#bacpac">bacpac</a> from the Tier 2+ environment</li><li>Restore the bacpac on a Tier 1 VM.</li></ul><p>This happens because Tier 2+ environments use Azure SQL as the DB engine and Tier 1 VMs use SQL Server.</p><p>The time it takes to complete the process depends on the size of the database and the performance of the VM you‚Äôll restore it to. But <strong>it‚Äôs not a fast process at all</strong>. For a 60GB database you‚Äôll get a bacpac around 7GB that will take:</p><ul><li>1 to 2 hours to refresh to UAT</li><li>2 to 4 hours for the bacpac to be exported</li><li>At least 4 hours to restore it to a Tier 1 VM.</li></ul><p>That‚Äôs between 7 and 11 hours until you have the DB on a developer machine. Once it‚Äôs there you can quickly get a BAK and share it. But you might need the time of a full working day to have that data available.</p><h3 id=222-httpsaristeinfoenmsdyn365-azure-devops-almsave-us-lcs-db-apisave-us-lcs-db-api>2.2.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#save-us-lcs-db-api></a>Save us LCS DB API!<a hidden class=anchor aria-hidden=true href=#222-httpsaristeinfoenmsdyn365-azure-devops-almsave-us-lcs-db-apisave-us-lcs-db-api>#</a></h3><p>Thanks to the new LCS DB API‚Äôs endpoint we can perform all these steps automatically, and with the help of <a href=https://github.com/d365collaborative/d365fo.tools>d365fo.tools</a> it‚Äôll be even easier. But first‚Ä¶</p><p>Due to the extensive time it takes to complete all the process, <strong>we first have to decide a schedule</strong> (daily, weekly, etc.) and then this schedule must be compatible with the release cadence to UAT/Prod, because <strong>only one operation at a time can be done</strong>.</p><p>There‚Äôs still another problem but I‚Äôll talk about it after seeing the scripts.</p><h3 id=223-httpsaristeinfoenmsdyn365-azure-devops-almmy-proposalmy-proposal>2.2.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#my-proposal></a>My proposal<a hidden class=anchor aria-hidden=true href=#223-httpsaristeinfoenmsdyn365-azure-devops-almmy-proposalmy-proposal>#</a></h3><p>To do the last part of the LCS DB API flow from prod to dev, we need a Tier 1 VM where the bacpac will be restored. My idea is <strong>using the build VM on Microsoft‚Äôs subscription</strong> and an Azure DevOps pipeline to run all the scripts that will restore the DB in that VM. It‚Äôs an underused machine and it fits perfectly to this purpose.</p><p>I want to clarify why I‚Äôve thought about doing this using the build VM. In most cases this VM will be doing nothing during the night, maybe only running some tests, and it‚Äôs during that period of time when I suggest doing all this. But be aware that depending on your DB size this won‚Äôt be possible or you‚Äôll run out of space after 2 o 3 restores.</p><p>So think about deploying an extra VM and install an agent there to do this, whatever you do <strong>don‚Äôt mess with the build VM if you don‚Äôt know what you‚Äôre doing</strong>! Try this on a dev VM or anywhere else if you‚Äôre afraid of breaking something. <strong>Remember you‚Äôll lose the capacity to generate DPs and run pipelines if this environments breaks</strong>!</p><p>This post is just an example of a possible solution, you need to decide what suits you best! <strong>End of the update</strong>.</p><p>As I said before I‚Äôll be using <a href=https://twitter.com/splaxi>M√∂tz Jensen</a>‚Äòs d365fo.tools, we could do everything without them but that would be a bit stupid because using the tools is easier, faster and makes everything clearer.</p><p>I‚Äôve separated all the steps in 3 Powershell scripts: execute the refresh, export the bacpac and restore the bacpac.</p><h4 id=2231-httpsaristeinfoenmsdyn365-azure-devops-almrefresh-databaserefresh-database>2.2.3.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#refresh-database></a>Refresh database<a hidden class=anchor aria-hidden=true href=#2231-httpsaristeinfoenmsdyn365-azure-devops-almrefresh-databaserefresh-database>#</a></h4><p>This will refresh the prod environmnet to a Tier 2+:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=nv>$clientId</span> <span class=p>\=</span> <span class=s2>&#34;ab12345-6220-4566-896a-19a4ad41783f&#34;</span>

<span class=nv>$userName</span> <span class=p>\=</span> <span class=s2>&#34;admin@tenant&#34;</span>

<span class=nv>$passWord</span> <span class=p>\=</span> <span class=s2>&#34;admin123456&#34;</span>

<span class=nv>$projectId</span> <span class=p>\=</span> <span class=s2>&#34;1234567&#34;</span>

<span class=nv>$sourceEnvId</span> <span class=p>\=</span> <span class=s2>&#34;958bc863-f089-4811-abbd-c1190917eaae&#34;</span>

<span class=nv>$targetEnvId</span> <span class=p>\=</span> <span class=s2>&#34;13aa6872-c13b-4ea3-81cd-2d26fa72ec5e&#34;</span>

<span class=nb>Get-D365LcsApiToken</span> <span class=p>\</span><span class=n>-ClientId</span> <span class=nv>$clientId</span> <span class=p>\</span><span class=n>-Username</span> <span class=nv>$userName</span> <span class=p>\</span><span class=n>-Password</span> <span class=nv>$passWord</span> <span class=p>\</span><span class=n>-LcsApiUri</span> <span class=s2>&#34;https://lcsapi.lcs.dynamics.com&#34;</span> <span class=p>\</span><span class=n>-Verbose</span> <span class=p>|</span> <span class=n>Set</span><span class=p>\</span><span class=n>-D365LcsApiConfig</span> <span class=p>\</span><span class=n>-ProjectId</span> <span class=nv>$projectId</span>

<span class=nb>Invoke-D365LcsDatabaseRefresh</span> <span class=p>\</span><span class=n>-SourceEnvironmentId</span> <span class=nv>$sourceEnvId</span> <span class=p>\</span><span class=n>-TargetEnvironmentId</span> <span class=nv>$targetEnvId</span> <span class=p>\</span><span class=n>-SkipInitialStatusFetch</span>
</code></pre></td></tr></table></div></div><h4 id=2232-httpsaristeinfoenmsdyn365-azure-devops-almexport-databaseexport-database>2.2.3.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#export-database></a>Export database<a hidden class=anchor aria-hidden=true href=#2232-httpsaristeinfoenmsdyn365-azure-devops-almexport-databaseexport-database>#</a></h4><p>This part will trigger the bacpac export from the Tier 2+ environment which we‚Äôve just refreshed:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=nv>$sourceEnvId</span> <span class=p>\=</span> <span class=s2>&#34;958bc863-f089-4811-abbd-c1190917eaae&#34;</span>

<span class=nv>$targetEnvId</span> <span class=p>\=</span> <span class=s2>&#34;13aa6872-c13b-4ea3-81cd-2d26fa72ec5e&#34;</span>

<span class=nb>Get-D365LcsApiConfig</span> <span class=p>|</span> <span class=nb>Invoke-D365LcsApiRefreshToken</span> <span class=p>|</span> <span class=n>Set</span><span class=p>\</span><span class=n>-D365LcsApiConfig</span>

<span class=nb>Invoke-D365LcsDatabaseExport</span> <span class=p>\</span><span class=n>-SourceEnvironmentId</span> <span class=nv>$targetEnvId</span> <span class=p>\</span><span class=n>-BackupName</span> <span class=nv>$bacpacName</span>
</code></pre></td></tr></table></div></div><h4 id=2233-httpsaristeinfoenmsdyn365-azure-devops-almrestore-bacpacrestore-bacpac>2.2.3.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#restore-bacpac></a>Restore bacpac<a hidden class=anchor aria-hidden=true href=#2233-httpsaristeinfoenmsdyn365-azure-devops-almrestore-bacpacrestore-bacpac>#</a></h4><p>And the final step will download the bacpac and restore it to a new database:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=nv>$currentDate</span> <span class=p>\=</span> <span class=nb>Get-Date</span> <span class=p>\</span><span class=n>-Format</span> <span class=n>yyyymmdd</span>

<span class=nv>$bacpacName</span> <span class=p>\=</span> <span class=s2>&#34;UAT{0}&#34;</span> <span class=p>\</span><span class=o>-f</span> <span class=nv>$currentDate</span>

<span class=nv>$downloadPath</span> <span class=p>\=</span> <span class=s2>&#34;D:\\UAT{0}.bacpac&#34;</span> <span class=p>\</span><span class=o>-f</span> <span class=nv>$currentDate</span>

<span class=nv>$newDBName</span> <span class=p>\=</span> <span class=s2>&#34;AxDB\_{0}&#34;</span> <span class=p>\</span><span class=o>-f</span> <span class=nv>$currentDate</span>

<span class=nb>Get-D365LcsApiConfig</span> <span class=p>|</span> <span class=nb>Invoke-D365LcsApiRefreshToken</span> <span class=p>|</span> <span class=n>Set</span><span class=p>\</span><span class=n>-D365LcsApiConfig</span>

<span class=nv>$backups</span> <span class=p>\=</span> <span class=nb>Get-D365LcsDatabaseBackups</span>

<span class=nv>$fileLocation</span> <span class=p>\=</span> <span class=nv>$backups</span><span class=p>\[</span><span class=n>0</span><span class=p>\].</span><span class=n>FileLocation</span>

<span class=nb>Invoke-D365AzCopyTransfer</span> <span class=p>\</span><span class=n>-SourceUri</span> <span class=nv>$fileLocation</span> <span class=p>\</span><span class=n>-DestinationUri</span> <span class=nv>$downloadPath</span>

<span class=nb>Import-D365Bacpac</span> <span class=p>\</span><span class=n>-ImportModeTier1</span> <span class=p>\</span><span class=n>-BacpacFile</span> <span class=nv>$downloadPath</span> <span class=p>\</span><span class=n>-NewDatabaseName</span> <span class=nv>$newDBName</span>
</code></pre></td></tr></table></div></div><h4 id=2234-httpsaristeinfoenmsdyn365-azure-devops-almusing-it-in-an-azure-devops-pipelineusing-it-in-an-azure-devops-pipeline>2.2.3.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#using-it-in-an-azure-devops-pipeline></a>Using it in an Azure DevOps pipeline<a hidden class=anchor aria-hidden=true href=#2234-httpsaristeinfoenmsdyn365-azure-devops-almusing-it-in-an-azure-devops-pipelineusing-it-in-an-azure-devops-pipeline>#</a></h4><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/04/2020-04-19-13_04_40.png.webp alt="Azure DevOps pipeline" title="MSDyn365 & Azure DevOps ALM 108"></p><p>Azure DevOps pipeline</p><p>This is it. Create a Powershell script, place it in the Build VM and call it in your pipeline. This is only valid for the agent hosted in the build VM. Everything can probably be run in an Azure hosted agent, but I‚Äôll not cover it here because I think that using the build VM, where we can restore the DB, is more useful to us.</p><h3 id=224-httpsaristeinfoenmsdyn365-azure-devops-almtimingtiming>2.2.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#timing></a>Timing<a hidden class=anchor aria-hidden=true href=#224-httpsaristeinfoenmsdyn365-azure-devops-almtimingtiming>#</a></h3><p>These 3 scripts will call the LCS DB API to refresh, export and restore the DB. But there‚Äôs the timing issue.</p><p>Refreshing the database takes some time and exporting it too. You need to find a way to control the status of the operations. The LCS DB API offers an operation you can use to get the status of the ongoing operation. Using d365fo.tools:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=nb>Get-D365LcsDatabaseRefreshStatus</span> <span class=p>\</span><span class=n>-OperationActivityId</span> <span class=n>123456789</span> <span class=p>\</span><span class=n>-EnvironmentId</span> <span class=s2>&#34;99ac6587-c13b-4ea3-81cd-2d26fa72ec5e&#34;</span>
</code></pre></td></tr></table></div></div><p>You can choose to control that inside your Powershell scripts, but if we use the agent on the build VM that means we cannot use it for anything else until everything is done.</p><p>That‚Äôs why I separated the process in 3 steps. You can manually schedule 3 pipelines, one for each step at the times <strong>you know</strong> each stage ends. Then you can choose the order: export, restore, refresh or refresh, export, restore.</p><p>You could also use <a href="https://docs.microsoft.com/en-us/windows/win32/taskschd/task-scheduler-start-page?WT.mc_id=DOP-MVP-5003976">Windows Task Scheduler</a> and forget about AZDO Pipelines, but we‚Äôre not doing that because we love pipelines.</p><p>And that‚Äôs all, we finally have a way of moving data without having to do it manually, we can schedule it, but we need to take some decisions on how we‚Äôll do things. And I‚Äôll leave that up to you üôÇ</p><h1 id=httpsaristeinfoenmsdyn365-azure-devops-almsecure-your-azure-pipelines-with-azure-key-vaultsecure-your-azure-pipelines-with-azure-key-vault><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#secure-your-azure-pipelines-with-azure-key-vault></a>Secure your Azure Pipelines with Azure Key Vault<a hidden class=anchor aria-hidden=true href=#httpsaristeinfoenmsdyn365-azure-devops-almsecure-your-azure-pipelines-with-azure-key-vaultsecure-your-azure-pipelines-with-azure-key-vault>#</a></h1><p>But <strong>creating a pipeline with a password in plain sight was not very secure</strong>. How could we add extra security to a pipeline? Once again we can turn to an Azure tool to help us, the <a href=https://azure.microsoft.com/en-us/services/key-vault/>Azure Key Vault</a>.</p><h1 id=httpsaristeinfoenmsdyn365-azure-devops-almazure-key-vaultazure-key-vault><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#azure-key-vault></a>Azure Key Vault<a hidden class=anchor aria-hidden=true href=#httpsaristeinfoenmsdyn365-azure-devops-almazure-key-vaultazure-key-vault>#</a></h1><p>A Key Vault is a service that allows us to <strong>safely store certificates or secrets</strong> and later use them in our applications and services. And like many other Azure services <a href=https://azure.microsoft.com/en-us/pricing/details/key-vault/>it has a cost</a> but it‚Äôs really low and, for a normal use, you will be billed like a cent or none a month. Don‚Äôt be stingy with security!</p><p>You might already know about Azure Key Vault because we can use it in Microsoft Dynamics 365 for Finance and Operations under System Administration. For example it‚Äôs how the company certificates for the Spanish SII or Brazilian NF-e are stored and later retrieved to call the web services.</p><h2 id=httpsaristeinfoenmsdyn365-azure-devops-almsecuring-your-azure-devops-pipelinessecuring-your-azure-devops-pipelines><a href=https://ariste.info/en/msdyn365-azure-devops-alm/#securing-your-azure-devops-pipelines></a>Securing your Azure DevOps Pipelines<a hidden class=anchor aria-hidden=true href=#httpsaristeinfoenmsdyn365-azure-devops-almsecuring-your-azure-devops-pipelinessecuring-your-azure-devops-pipelines>#</a></h2><p>Thanks to the <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/deploy/azure-key-vault?view=azure-devops&WT.mc_id=DOP-MVP-5003976">Azure Key Vault task</a> (which is <a href=https://github.com/microsoft/azure-pipelines-tasks>open source like many other tasks</a>) getting a secret from a Key Vault has no secret (<a href="https://www.youtube.com/watch?v=ObpcGNCU944">badum tssss</a>).</p><h3 id=411-httpsaristeinfoenmsdyn365-azure-devops-almcreate-a-key-vaultcreate-a-key-vault>4.1.1. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#create-a-key-vault></a>Create a Key Vault<a hidden class=anchor aria-hidden=true href=#411-httpsaristeinfoenmsdyn365-azure-devops-almcreate-a-key-vaultcreate-a-key-vault>#</a></h3><p>Go to your Azure subscription and look for Key Vaults in the top search bar. If you don‚Äôt have an Azure subscription you can get one <strong>free with a credit of 170‚Ç¨/200$ for 30 days</strong> and try this or other things.</p><p>In the Key Vault page click on ‚ÄúCreate key vault‚Äù and fill the fields</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/02/2020-02-08-13_54_14-Create-key-vault-Microsoft-Azure.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 50" title="MSDyn365 & Azure DevOps ALM 109"></p><p>You can go through other tabs but I will just click ‚ÄúReview & Create‚Äù to create the vault.</p><h3 id=412-httpsaristeinfoenmsdyn365-azure-devops-almadd-the-task-to-devopsadd-the-task-to-devops>4.1.2. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#add-the-task-to-devops></a>Add the task to DevOps<a hidden class=anchor aria-hidden=true href=#412-httpsaristeinfoenmsdyn365-azure-devops-almadd-the-task-to-devopsadd-the-task-to-devops>#</a></h3><p>Now go to Azure DevOps and create a new pipeline or edit an existing one. Add a task to the agent job and look for azure key vault:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/02/2020-02-08-13_57_08-New-release-pipeline-Pipelines.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 51" title="MSDyn365 & Azure DevOps ALM 110"></p><p>It‚Äôs possible that you might need to get the task from the marketplace first, if so remember you need to have enough right on the organization and not only the AZDO project you‚Äôre in. Now go to the task and select your subscription:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/02/2020-02-08-14_00_18-New-release-pipeline-Pipelines.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 52" title="MSDyn365 & Azure DevOps ALM 111"></p><p>Once selected click the ‚ÄúAuthorize‚Äù button. <strong>This will create a service principal in your subscription</strong>, we‚Äôll use it later. After authorizing you just need to select the key vault you‚Äôve created in the first step. And back to Azure.</p><h3 id=413-httpsaristeinfoenmsdyn365-azure-devops-almsetup-and-secret-creationsetup-and-secret-creation>4.1.3. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#setup-and-secret-creation></a>Setup and secret creation<a hidden class=anchor aria-hidden=true href=#413-httpsaristeinfoenmsdyn365-azure-devops-almsetup-and-secret-creationsetup-and-secret-creation>#</a></h3><p>Go to your key vault, ‚ÄúAccess policies‚Äù and click ‚ÄúAdd Access Policy‚Äù:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/02/2020-02-08-14_05_51-aaristeDevOps-Access-policies-Microsoft-Azure.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 53" title="MSDyn365 & Azure DevOps ALM 112"></p><p>When we authorized the task to access our Azure subscription it created a service principal now we need to select it to <strong>list and get the secrets</strong> to be able to use them in our pipeline. Click on ‚ÄúSelect principal‚Äù:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/02/2020-02-08-14_08_17-Add-access-policy-Microsoft-Azure.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 54" title="MSDyn365 & Azure DevOps ALM 113"></p><p>In the search bar type your subscription‚Äôs name, the principal should start with it and end with the same ID of your subscription. Select it and click the ‚ÄúSelect‚Äù button at the bottom:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/02/2020-02-08-14_10_21-axz-dev01dev.northeurope.cloudapp.azure_.com_61012-Remote-Desktop-Connection.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 55" title="MSDyn365 & Azure DevOps ALM 114"></p><p>Now click on the ‚ÄúSecret permissions‚Äù lookup and under ‚ÄúSecret Management Operations‚Äù select Get and List:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/02/2020-02-08-14_12_13-Add-access-policy-Microsoft-Azure.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 56" title="MSDyn365 & Azure DevOps ALM 115"></p><p>If you want to also use certificates or keys you should do the same. Finally click the ‚ÄúAdd‚Äù button and <strong>don‚Äôt forget to click ‚ÄúSave‚Äù!!</strong> Otherwise nothing will be saved:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/02/2020-02-08-14_13_42-aaristeDevOps-Access-policies-Microsoft-Azure.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 57" title="MSDyn365 & Azure DevOps ALM 116"></p><p>Now we can create a secret in the key vault. Go to secrets and click on ‚ÄúGenerate/Import‚Äù, complete the fields and finally click on the ‚ÄúCreate‚Äù button:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/02/2020-02-08-14_15_55-Create-a-secret-Microsoft-Azure.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 58" title="MSDyn365 & Azure DevOps ALM 117"></p><h3 id=414-httpsaristeinfoenmsdyn365-azure-devops-almusing-the-secrets-in-your-pipelinesusing-the-secrets-in-your-pipelines>4.1.4. <a href=https://ariste.info/en/msdyn365-azure-devops-alm/#using-the-secrets-in-your-pipelines></a>Using the secrets in your pipelines<a hidden class=anchor aria-hidden=true href=#414-httpsaristeinfoenmsdyn365-azure-devops-almusing-the-secrets-in-your-pipelinesusing-the-secrets-in-your-pipelines>#</a></h3><p>We‚Äôre ready to use the secret in our pipeline. I will add a PowerShell task to call the LCS DB API using d365fo.tools but I‚Äôll change all the variables to the secrets:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-powershell data-lang=powershell><span class=c># Write your PowerShell commands here.</span>
<span class=n>Install</span><span class=p>\</span><span class=n>-PackageProvider</span> <span class=n>nuget</span> <span class=p>\</span><span class=n>-Scope</span> <span class=n>CurrentUser</span> <span class=p>\</span><span class=n>-Force</span> <span class=p>\</span><span class=n>-Confirm</span><span class=err>:</span><span class=nv>$false</span>
<span class=n>Install</span><span class=p>\</span><span class=n>-Module</span> <span class=p>\</span><span class=n>-Name</span> <span class=n>AZ</span> <span class=p>\</span><span class=n>-AllowClobber</span> <span class=p>\</span><span class=n>-Scope</span> <span class=n>CurrentUser</span> <span class=p>\</span><span class=n>-Force</span> <span class=p>\</span><span class=n>-Confirm</span><span class=err>:</span><span class=nv>$False</span> <span class=p>\</span><span class=n>-SkipPublisherCheck</span>
<span class=n>Install</span><span class=p>\</span><span class=n>-Module</span> <span class=p>\</span><span class=n>-Name</span> <span class=n>d365fo</span><span class=p>.</span><span class=n>tools</span> <span class=p>\</span><span class=n>-AllowClobber</span> <span class=p>\</span><span class=n>-Scope</span> <span class=n>CurrentUser</span> <span class=p>\</span><span class=n>-Force</span> <span class=p>\</span><span class=n>-Confirm</span><span class=err>:</span><span class=nv>$false</span>
<span class=n>Get</span><span class=p>\</span><span class=n>-D365LcsApiToken</span> <span class=p>\</span><span class=n>-ClientId</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=n>myAppId</span><span class=p>)</span><span class=s2>&#34;</span> <span class=p>\</span><span class=n>-Username</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=n>myUserName</span><span class=p>)</span><span class=s2>&#34;</span> <span class=p>\</span><span class=n>-Password</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=n>mySecretPassword</span><span class=p>)</span><span class=s2>&#34;</span> <span class=p>\</span><span class=n>-LcsApiUri</span> <span class=s2>&#34;https://lcsapi.lcs.dynamics.com&#34;</span> <span class=p>\</span><span class=n>-Verbose</span> <span class=p>|</span> <span class=n>Set</span><span class=p>\</span><span class=n>-D365LcsApiConfig</span> <span class=p>\</span><span class=n>-ProjectId</span> <span class=p>$(</span><span class=n>myProjectId</span><span class=p>)</span>
<span class=n>Get</span><span class=p>\</span><span class=n>-D365LcsDatabaseBackups</span>
</code></pre></td></tr></table></div></div><p>As you can see now even the AAD App Id is masked.</p><p>What the Azure Key Vault task does is getting the secrets from Azure and storing them in variables when the pipeline runs:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/02/2020-02-08-14_23_26-New-release-pipeline-1-Release-1-Pipelines.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 59" title="MSDyn365 & Azure DevOps ALM 118"></p><p>Then we can access it‚Äôs value with the $(variableName) notation in the PowerShell script. If you try to print the secrets‚Äô values using the Write-Host command all you‚Äôll get will be three asterisks, so you can see that using the Key Vault is more than safe. If we check the result of running the Get-D365LcsDatabaseBackups command we‚Äôll see how good is this:</p><p><img loading=lazy src=https://static.ariste.info/wp-content/uploads/2020/02/2020-02-08-14_28_01-New-release-pipeline-1-Release-1-Pipelines.png.webp alt="MSDyn365 &amp;amp; Azure DevOps ALM 60" title="MSDyn365 & Azure DevOps ALM 119"></p><p>The ProjectId value <strong>is not printed because it was one of our secret values</strong>!</p><p>And this is how you can add extra security to your Dev ALM!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://nuxulu.com/tags/devops/>DevOps</a></li><li><a href=https://nuxulu.com/tags/alm/>ALM</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Dynamics 365 for Finance & Operations and Azure DevOps on twitter" href="https://twitter.com/intent/tweet/?text=Dynamics%20365%20for%20Finance%20%26%20Operations%20and%20Azure%20DevOps&url=https%3a%2f%2fnuxulu.com%2f2021-05-01-dynamics-365-for-finance-operations-and-azure-devops%2f&hashtags=DevOps%2cALM"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Dynamics 365 for Finance & Operations and Azure DevOps on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fnuxulu.com%2f2021-05-01-dynamics-365-for-finance-operations-and-azure-devops%2f&title=Dynamics%20365%20for%20Finance%20%26%20Operations%20and%20Azure%20DevOps&summary=Dynamics%20365%20for%20Finance%20%26%20Operations%20and%20Azure%20DevOps&source=https%3a%2f%2fnuxulu.com%2f2021-05-01-dynamics-365-for-finance-operations-and-azure-devops%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Dynamics 365 for Finance & Operations and Azure DevOps on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fnuxulu.com%2f2021-05-01-dynamics-365-for-finance-operations-and-azure-devops%2f&title=Dynamics%20365%20for%20Finance%20%26%20Operations%20and%20Azure%20DevOps"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Dynamics 365 for Finance & Operations and Azure DevOps on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnuxulu.com%2f2021-05-01-dynamics-365-for-finance-operations-and-azure-devops%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Dynamics 365 for Finance & Operations and Azure DevOps on whatsapp" href="https://api.whatsapp.com/send?text=Dynamics%20365%20for%20Finance%20%26%20Operations%20and%20Azure%20DevOps%20-%20https%3a%2f%2fnuxulu.com%2f2021-05-01-dynamics-365-for-finance-operations-and-azure-devops%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Dynamics 365 for Finance & Operations and Azure DevOps on telegram" href="https://telegram.me/share/url?text=Dynamics%20365%20for%20Finance%20%26%20Operations%20and%20Azure%20DevOps&url=https%3a%2f%2fnuxulu.com%2f2021-05-01-dynamics-365-for-finance-operations-and-azure-devops%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://nuxulu.com>Dynamics 365 Finance Operations & Power Platform</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script defer src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position"))};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft)}document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>