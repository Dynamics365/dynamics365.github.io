---
layout: post
title: AX 2012 RecIds and UnitOfWork Foreign-Key Magic
date: 2015-04-17 11:24:00.000000000 +07:00
type: post
published: true
status: publish
categories: []
tags:
- AX 2012
- Foreign-key
- replacement key
meta:
  _publicize_pending: '1'
author:
  login: luannx
  email: luan52@outlook.com
  display_name: luannx
  first_name: ''
  last_name: ''
---
<p><span style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;">AX 2012 features the new UnitOfWork class. One of the reasons this class exists, is to handle new issues that have come up because of one major shift in thinking in AX.</span><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><span style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;">We now should try to link records together based on RecIds.</span><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><span style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;">I can hear you scream WHAT all the way to Denver. Yes, you heard me right, it's now considered GOOD practice to link records together based on RecIds. Most developers I know that have any kind of experience with AX hate tables that link on RecId (although in some cases you have to), and usually consider it bad practice.</span><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><span style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;">Well, get with the program! :-) It is now considered a good practice. Key reasons are performance and avoiding data duplication. Lots of tables in AX use(d) long strings as primary keys, and in some cases you need to start linking on more than one field to keep linking unique, etc. Well, since RecId is always unique within a table, and it's "just" a number, the duplication of multiple field values, and the performance on long string primary keys is now "solved".</span><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><span style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;">Yes, I agree, this will not be pretty when doing data migrations and company copies (which for all intents and purposes are near impossible in 2012 - more on that later). But I'm sure somehow we will all get over our preconceptions and embrace this new paradigm (I'm using it, but I'm not a big fan just yet).</span><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><span style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;">In any case, it is what it is. There are some new things around this RecId linking, to facilitate both developer as well as end-user (can you imagine a user having to pick a RecId from a dropdown instead of a Customer number? Before you freak out - customers still have account numbers and that's still the primary key).</span><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><span style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;">Let's create a new table called AX2012Features, which uses RecId as its primary key, and a Name field. This name field will be contained in a unique index as well, and be designated as the "Alternate Key" (more on this later). On the table's properties, set this key as the "ReplacementKey".</span><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><a href="http://www.codecrib.com/daxmusings-pics/fk_01.png" style="color:rgb(0,84,166);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;background-color:rgb(255,255,255);"><img src="{{ site.baseurl }}/assets/fk_01.png" border="0" alt="" style="height:184px;display:block;margin:0 auto 10px;text-align:center;cursor:pointer;width:288px;" /></a><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><a href="http://www.codecrib.com/daxmusings-pics/fk_02.png" style="color:rgb(0,84,166);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;background-color:rgb(255,255,255);"><img src="{{ site.baseurl }}/assets/fk_02.png" border="0" alt="" style="height:258px;display:block;margin:0 auto 10px;text-align:center;cursor:pointer;width:271px;" /></a><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><a href="http://www.codecrib.com/daxmusings-pics/fk_03.png" style="color:rgb(0,84,166);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;background-color:rgb(255,255,255);"><img src="{{ site.baseurl }}/assets/fk_03.png" border="0" alt="" style="height:202px;display:block;margin:0 auto 10px;text-align:center;cursor:pointer;width:338px;" /></a><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><span style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;">Next, we create a new extended data type for our RecId (yes!). So this data type we'll call AX2012FeatureRecId, and it has to be an Int64. As it so happens, this data type has a new property called "ReferenceTable", where we fill in our AX2012Features table.</span><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><a href="http://www.codecrib.com/daxmusings-pics/fk_04.png" style="color:rgb(0,84,166);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;background-color:rgb(255,255,255);"><img src="{{ site.baseurl }}/assets/fk_04.png" border="0" alt="" style="height:55px;display:block;margin:0 auto 10px;text-align:center;cursor:pointer;width:549px;" /></a><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><span style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;">I'm skipping the creation of a form for this table. Well just add some records using the table browser, we're amongst developers here, right?</span><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><span style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;">So, on to the next table. We'll add an AX2012FavoriteFeatures table, where we can add an integer field "Ranking" for our favorites features from the other table. Also, we will drag and drop our new AX2012FeatureRecId extended data type on the "Fields" node of the table, which will then release some magic. I will rename this field to "FeatureRecId".</span><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><a href="http://www.codecrib.com/daxmusings-pics/fk_05.png" style="color:rgb(0,84,166);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;background-color:rgb(255,255,255);"><img src="{{ site.baseurl }}/assets/fk_05.png" border="0" alt="" style="height:229px;display:block;margin:0 auto 10px;text-align:center;cursor:pointer;width:308px;" /></a><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><a href="http://www.codecrib.com/daxmusings-pics/fk_06.png" style="color:rgb(0,84,166);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;background-color:rgb(255,255,255);"><img src="{{ site.baseurl }}/assets/fk_06.png" border="0" alt="" style="height:168px;display:block;margin:0 auto 10px;text-align:center;cursor:pointer;width:494px;" /></a><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><span style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;">When you now open this table's table browser, nothing appears out of the ordinary (besides the fact the table browser in 2012 is now finally no longer an MDI child). There is an integer ranking field, and a FeatureRecId field with a dropdown with recids.</span><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><span style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;">Let's create a form for this, shall we? Now, for the fields, either drag them from the datasource onto the design, OR, when you add a control for the FeatureRecId, select the "ReferenceGroup" control instead and set the referencefield property to "FeatureRecId". If you drag &amp; drop, it will take referencegroup automatically.</span><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><a href="http://www.codecrib.com/daxmusings-pics/fk_07.png" style="color:rgb(0,84,166);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;background-color:rgb(255,255,255);"><img src="{{ site.baseurl }}/assets/fk_07.png" border="0" alt="" style="height:73px;display:block;margin:0 auto 10px;text-align:center;cursor:pointer;width:296px;" /></a><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><a href="http://www.codecrib.com/daxmusings-pics/fk_08.png" style="color:rgb(0,84,166);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;background-color:rgb(255,255,255);"><img src="{{ site.baseurl }}/assets/fk_08.png" border="0" alt="" style="height:114px;display:block;margin:0 auto 10px;text-align:center;cursor:pointer;width:455px;" /></a><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><span style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;">A picture says more than a thousand words, so open up the form, which now has the FeatureRecId field (an Int64) in a ReferenceGroup control.</span><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><a href="http://www.codecrib.com/daxmusings-pics/fk_09.png" style="color:rgb(0,84,166);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;background-color:rgb(255,255,255);"><img src="{{ site.baseurl }}/assets/fk_09.png" border="0" alt="" style="height:193px;display:block;margin:0 auto 10px;text-align:center;cursor:pointer;width:363px;" /></a><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><span style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;">Yes indeed. The dropdown features your alternate key with your name. If you select a value, the supposed RecId field actually shows the Name, not the RecId. Please try this out with more than one field in the AlternateKey, instead of just one like we did here.</span><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><span style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;">Ok, so this is pretty cool actually. We only store one RecId field, but the user sees and picks from a list of values from the alternatekey (however many fields there may be in that key). This begs the question, what do we do in code? Traditionally, I know going in, what my name will be, and so I can add that name when I insert a record in the favorites. Now with this, I cannot get my inserts going, until I have added the favorites, then I need to get that recid and put it in the favorite.</span><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><span style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;">Blast! Just when you started getting used to using RecordInsertList, you need to stop using it because you need the auto-generated value to insert another record. Well, have no fear, the UnitOfWork class is here. And even better, if you have complex structures, it will figure out the sequencing of inserts for you! How you say? Let's create a class, sporting our two tables and a UnitOfWork class. We create an instance of the UnitOfWork class, and we set the name of our empty feature to "UnitOfWork". Instead of calling insert, we call unitOfWork's "InsertOnSaveChanges", to indicate we want to insert this record when we call "savechanges" on unitofwork. We use a class to test this, and not a job, because UnitOfWork always needs to run on server. So, when you create a main method to run the class, make sure to declare it SERVER!</span><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><a href="http://www.codecrib.com/daxmusings-pics/fk_10.png" style="color:rgb(0,84,166);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;background-color:rgb(255,255,255);"><img src="{{ site.baseurl }}/assets/fk_10.png" border="0" alt="" style="height:155px;display:block;margin:0 auto 10px;text-align:center;cursor:pointer;width:318px;" /></a><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><span style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;">Next, the magic happens. Go back to your FavoriteFeatures table, and check the relations. The RecId data type prompted you to auto-create the relation. If you open the relation, you'll see the FeatureRecId field linked to the RecId of the Features table. Open the properties of the relation and set the "CreateNavigationPropertyMethods" to YES.</span><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><a href="http://www.codecrib.com/daxmusings-pics/fk_11.png" style="color:rgb(0,84,166);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;background-color:rgb(255,255,255);"><img src="{{ site.baseurl }}/assets/fk_11.png" border="0" alt="" style="height:358px;display:block;margin:0 auto 10px;text-align:center;cursor:pointer;width:638px;" /></a><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><span style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;">In the code, we'll say our number one feature (at least for this blog post)is the one we're trying to insert. Because of the ForeignKey relationship, and setting the navigation property methods to YES, AX 2012 has added a method to the favorites table, carrying the name of your relationship, in the case of this example, AX2012Features. We pass in the (not yet created!) record buffer of feature. Next, we add the favorites buffer to the unitOfWork as well.</span><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><a href="http://www.codecrib.com/daxmusings-pics/fk_12.png" style="color:rgb(0,84,166);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;background-color:rgb(255,255,255);"><img src="{{ site.baseurl }}/assets/fk_12.png" border="0" alt="" style="height:53px;display:block;margin:0 auto 10px;text-align:center;cursor:pointer;width:304px;" /></a><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><span style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;">Alright. So now, the unit of work class knows we want to insert both records, and it also knows which one depends on which other one, so it will figure out in what sequence the inserts need to happen (granted, in this example there's not much to it… but feel free to experiment with more records, or changing up the order of calling "insertonsavechanges").</span><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><span style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;">Since UnitOfWork also takes care of transactions, we don't really need to do anything more than call the SaveChanges method (because of this transaction model, if you want to use savechanges to make updates, make sure to select your records for optimistic concurrency!).</span><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><span style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;">So, your full code should now look like this:</span><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><a href="http://www.codecrib.com/daxmusings-pics/fk_13.png" style="color:rgb(0,84,166);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;background-color:rgb(255,255,255);"><img src="{{ site.baseurl }}/assets/fk_13.png" border="0" alt="" style="height:261px;display:block;margin:0 auto 10px;text-align:center;cursor:pointer;width:334px;" /></a><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><br style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;" /><span style="color:rgb(48,49,49);font-family:'Segoe UI', Tahoma, Arial, sans-serif;font-size:16px;line-height:17.454545974731px;">So… ready to run it? GO! And yes, if you open the favorites form, you'll see your unitofwork ranking number 1 in there, properly linked on RecId (but of course sporting the alternatekey "Name" field on the form instead!).</span></p>
